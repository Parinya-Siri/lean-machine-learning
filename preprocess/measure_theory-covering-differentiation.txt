import measure_theory.covering.vitali_family
import measure_theory.measure.regular
import measure_theory.function.ae_measurable_order
import measure_theory.integral.lebesgue
import measure_theory.decomposition.radon_nikodym
open measure_theory metric set filter topological_space measure_theory.measure
open_locale filter ennreal measure_theory nnreal topological_space
local attribute [instance] emetric.second_countable_of_sigma_compact
variables {Î± : Type*} [metric_space Î±] {m0 : measurable_space Î±}
{Î¼ : measure Î±} (v : vitali_family Î¼)
include v
namespace vitali_family
noncomputable def lim_ratio (Ï : measure Î±) (x : Î±) : â„â‰¥0âˆ :=
lim (v.filter_at x) (Î» a, Ï a / Î¼ a)
theorem ae_eventually_measure_pos [second_countable_topology Î±] :
  âˆ€áµ x âˆ‚Î¼, âˆ€á¶  a in v.filter_at x, 0 < Î¼ a :=
begin
  set s := {x | Â¬ (âˆ€á¶  a in v.filter_at x, 0 < Î¼ a)} with hs,
  simp only [not_lt, not_eventually, nonpos_iff_eq_zero] at hs,
  change Î¼ s = 0,
  let f : Î± â†’ set (set Î±) := Î» x, {a | Î¼ a = 0},
  have h : v.fine_subfamily_on f s,
  { assume x hx Îµ Îµpos,
    rw hs at hx,
    simp only [frequently_filter_at_iff, exists_prop, gt_iff_lt, mem_set_of_eq] at hx,
    rcases hx Îµ Îµpos with âŸ¨a, a_sets, ax, Î¼aâŸ©,
    exact âŸ¨a, âŸ¨a_sets, Î¼aâŸ©, axâŸ© },
  refine le_antisymm _ bot_le,
  calc Î¼ s â‰¤ âˆ‘' (x : h.index), Î¼ (h.covering x) : h.measure_le_tsum
  ... = âˆ‘' (x : h.index), 0 : by { congr, ext1 x, exact h.covering_mem x.2 }
  ... = 0 : by simp only [tsum_zero, add_zero]
end
theorem eventually_measure_lt_top [is_locally_finite_measure Î¼] (x : Î±) :
  âˆ€á¶  a in v.filter_at x, Î¼ a < âˆ :=
begin
  obtain âŸ¨Îµ, Îµpos, Î¼ÎµâŸ© : âˆƒ (Îµ : â„) (hi : 0 < Îµ), Î¼ (closed_ball x Îµ) < âˆ :=
    (Î¼.finite_at_nhds x).exists_mem_basis nhds_basis_closed_ball,
  exact v.eventually_filter_at_iff.2 âŸ¨Îµ, Îµpos, Î» a ha haÎµ, (measure_mono haÎµ).trans_lt Î¼ÎµâŸ©,
end
theorem measure_le_of_frequently_le [sigma_compact_space Î±] [borel_space Î±]
  {Ï : measure Î±} (Î½ : measure Î±) [is_locally_finite_measure Î½]
  (hÏ : Ï â‰ª Î¼) (s : set Î±) (hs : âˆ€ x âˆˆ s, âˆƒá¶  a in v.filter_at x, Ï a â‰¤ Î½ a) :
  Ï s â‰¤ Î½ s :=
begin
lemma ae_eventually_measure_zero_of_singular (hÏ : Ï âŠ¥â‚˜ Î¼) :
  âˆ€áµ x âˆ‚Î¼, tendsto (Î» a, Ï a / Î¼ a) (v.filter_at x) (ğ“ 0) :=
begin
  have A : âˆ€ Îµ > (0 : â„â‰¥0), âˆ€áµ x âˆ‚Î¼, âˆ€á¶  a in v.filter_at x, Ï a < Îµ * Î¼ a,
  { assume Îµ Îµpos,
    set s := {x | Â¬(âˆ€á¶  a in v.filter_at x, Ï a < Îµ * Î¼ a) } with hs,
    change Î¼ s = 0,
    obtain âŸ¨o, o_meas, Ïo, Î¼oâŸ© : âˆƒ (o : set Î±), measurable_set o âˆ§ Ï o = 0 âˆ§ Î¼ oá¶œ = 0 := hÏ,
    apply le_antisymm _ bot_le,
    calc Î¼ s â‰¤ Î¼ ((s âˆ© o) âˆª oá¶œ) : begin
      conv_lhs { rw â† inter_union_compl s o },
      exact measure_mono (union_subset_union_right _ (inter_subset_right _ _))
    end
    ... â‰¤ Î¼ (s âˆ© o) + Î¼ (oá¶œ) : measure_union_le _ _
    ... = Î¼ (s âˆ© o) : by rw [Î¼o, add_zero]
    ... = Îµâ»Â¹ * (Îµ â€¢ Î¼) (s âˆ© o) : begin
      simp only [coe_nnreal_smul_apply, â† mul_assoc, mul_comm _ (Îµ : â„â‰¥0âˆ)],
      rw [ennreal.mul_inv_cancel (ennreal.coe_pos.2 Îµpos).ne' ennreal.coe_ne_top, one_mul],
    end
    ... â‰¤ Îµâ»Â¹ * Ï (s âˆ© o) : begin
      apply ennreal.mul_le_mul le_rfl,
      refine v.measure_le_of_frequently_le Ï ((measure.absolutely_continuous.refl Î¼).smul Îµ) _ _,
      assume x hx,
      rw hs at hx,
      simp only [mem_inter_eq, not_lt, not_eventually, mem_set_of_eq] at hx,
      exact hx.1
    end
    ... â‰¤ Îµâ»Â¹ * Ï o : ennreal.mul_le_mul le_rfl (measure_mono (inter_subset_right _ _))
    ... = 0 : by rw [Ïo, mul_zero] },
  obtain âŸ¨u, u_anti, u_pos, u_limâŸ© :
    âˆƒ (u : â„• â†’ â„â‰¥0), strict_anti u âˆ§ (âˆ€ (n : â„•), 0 < u n) âˆ§ tendsto u at_top (ğ“ 0) :=
      exists_seq_strict_anti_tendsto (0 : â„â‰¥0),
  have B : âˆ€áµ x âˆ‚Î¼, âˆ€ n, âˆ€á¶  a in v.filter_at x, Ï a < u n * Î¼ a :=
    ae_all_iff.2 (Î» n, A (u n) (u_pos n)),
  filter_upwards [B, v.ae_eventually_measure_pos],
  assume x hx h'x,
  refine tendsto_order.2 âŸ¨Î» z hz, (ennreal.not_lt_zero hz).elim, Î» z hz, _âŸ©,
  obtain âŸ¨w, w_pos, w_ltâŸ© : âˆƒ (w : â„â‰¥0), (0 : â„â‰¥0âˆ) < w âˆ§ (w : â„â‰¥0âˆ) < z :=
    ennreal.lt_iff_exists_nnreal_btwn.1 hz,
  obtain âŸ¨n, hnâŸ© : âˆƒ n, u n < w :=
    ((tendsto_order.1 u_lim).2 w (ennreal.coe_pos.1 w_pos)).exists,
  filter_upwards [hx n, h'x, v.eventually_measure_lt_top x],
  assume a ha Î¼a_pos Î¼a_lt_top,
  rw ennreal.div_lt_iff (or.inl Î¼a_pos.ne') (or.inl Î¼a_lt_top.ne),
  exact ha.trans_le (ennreal.mul_le_mul ((ennreal.coe_le_coe.2 hn.le).trans w_lt.le) le_rfl)
end
section absolutely_continuous
variable (hÏ : Ï â‰ª Î¼)
include hÏ
theorem null_of_frequently_le_of_frequently_ge {c d : â„â‰¥0} (hcd : c < d) (s : set Î±)
  (hc : âˆ€ x âˆˆ s, âˆƒá¶  a in v.filter_at x, Ï a â‰¤ c * Î¼ a)
  (hd : âˆ€ x âˆˆ s, âˆƒá¶  a in v.filter_at x, (d : â„â‰¥0âˆ) * Î¼ a â‰¤ Ï a) :
  Î¼ s = 0 :=
begin
  apply null_of_locally_null s (Î» x hx, _),
  obtain âŸ¨o, xo, o_open, Î¼oâŸ© : âˆƒ o : set Î±, x âˆˆ o âˆ§ is_open o âˆ§ Î¼ o < âˆ :=
    measure.exists_is_open_measure_lt_top Î¼ x,
  refine âŸ¨s âˆ© o, inter_mem_nhds_within _ (o_open.mem_nhds xo), _âŸ©,
  let s' := s âˆ© o,
  by_contra,
  apply lt_irrefl (Ï s'),
  calc Ï s' â‰¤ c * Î¼ s' : v.measure_le_of_frequently_le (c â€¢ Î¼) hÏ s' (Î» x hx, hc x hx.1)
  ... < d * Î¼ s' : begin
    apply (ennreal.mul_lt_mul_right h _).2 (ennreal.coe_lt_coe.2 hcd),
    exact (lt_of_le_of_lt (measure_mono (inter_subset_right _ _)) Î¼o).ne,
  end
  ... â‰¤ Ï s' : v.measure_le_of_frequently_le Ï
    ((measure.absolutely_continuous.refl Î¼).smul d) s' (Î» x hx, hd x hx.1)
end
theorem ae_tendsto_div :
  âˆ€áµ x âˆ‚Î¼, âˆƒ c, tendsto (Î» a, Ï a / Î¼ a) (v.filter_at x) (ğ“ c) :=
begin
  obtain âŸ¨w, w_count, w_dense, w_zero, w_topâŸ© : âˆƒ w : set â„â‰¥0âˆ, w.countable âˆ§ dense w âˆ§
    0 âˆ‰ w âˆ§ âˆ âˆ‰ w := ennreal.exists_countable_dense_no_zero_top,
  have I : âˆ€ x âˆˆ w, x â‰  âˆ := Î» x xs hx, w_top (hx â–¸ xs),
  have A : âˆ€ (c âˆˆ w) (d âˆˆ w), (c < d) â†’ âˆ€áµ x âˆ‚Î¼,
    Â¬((âˆƒá¶  a in v.filter_at x, Ï a / Î¼ a < c) âˆ§ (âˆƒá¶  a in v.filter_at x, d < Ï a / Î¼ a)),
  { assume c hc d hd hcd,
    lift c to â„â‰¥0 using I c hc,
    lift d to â„â‰¥0 using I d hd,
    apply v.null_of_frequently_le_of_frequently_ge hÏ (ennreal.coe_lt_coe.1 hcd),
    { simp only [and_imp, exists_prop, not_frequently, not_and, not_lt, not_le, not_eventually,
        mem_set_of_eq, mem_compl_eq, not_forall],
      assume x h1x h2x,
      apply h1x.mono (Î» a ha, _),
      refine (ennreal.div_le_iff_le_mul _ (or.inr (bot_le.trans_lt ha).ne')).1 ha.le,
      simp only [ennreal.coe_ne_top, ne.def, or_true, not_false_iff] },
    { simp only [and_imp, exists_prop, not_frequently, not_and, not_lt, not_le, not_eventually,
        mem_set_of_eq, mem_compl_eq, not_forall],
      assume x h1x h2x,
      apply h2x.mono (Î» a ha, _),
      exact ennreal.mul_le_of_le_div ha.le } },
  have B : âˆ€áµ x âˆ‚Î¼, âˆ€ (c âˆˆ w) (d âˆˆ w), (c < d) â†’
    Â¬((âˆƒá¶  a in v.filter_at x, Ï a / Î¼ a < c) âˆ§ (âˆƒá¶  a in v.filter_at x, d < Ï a / Î¼ a)),
    by simpa only [ae_ball_iff w_count, ae_imp_iff],
  filter_upwards [B],
  assume x hx,
  exact tendsto_of_no_upcrossings w_dense hx,
end
lemma ae_tendsto_lim_ratio :
  âˆ€áµ x âˆ‚Î¼, tendsto (Î» a, Ï a / Î¼ a) (v.filter_at x) (ğ“ (v.lim_ratio Ï x)) :=
begin
  filter_upwards [v.ae_tendsto_div hÏ],
  assume x hx,
  exact tendsto_nhds_lim hx,
end
lemma exists_measurable_supersets_lim_ratio {p q : â„â‰¥0} (hpq : p < q) :
  âˆƒ a b, measurable_set a âˆ§ measurable_set b âˆ§ {x | v.lim_ratio Ï x < p} âŠ† a
    âˆ§ {x | (q : â„â‰¥0âˆ) < v.lim_ratio Ï x} âŠ† b âˆ§ Î¼ (a âˆ© b) = 0 :=
begin
  let s := {x | âˆƒ c, tendsto (Î» a, Ï a / Î¼ a) (v.filter_at x) (ğ“ c)},
  let o : â„• â†’ set Î± := spanning_sets (Ï + Î¼),
  let u := Î» n, s âˆ© {x | v.lim_ratio Ï x < p} âˆ© o n,
  let w := Î» n, s âˆ© {x | (q : â„â‰¥0âˆ) < v.lim_ratio Ï x} âˆ© o n,
noncomputable def lim_ratio_meas : Î± â†’ â„â‰¥0âˆ :=
(v.ae_measurable_lim_ratio hÏ).mk _
lemma lim_ratio_meas_measurable : measurable (v.lim_ratio_meas hÏ) :=
ae_measurable.measurable_mk _
lemma ae_tendsto_lim_ratio_meas :
  âˆ€áµ x âˆ‚Î¼, tendsto (Î» a, Ï a / Î¼ a) (v.filter_at x) (ğ“ (v.lim_ratio_meas hÏ x)) :=
begin
  filter_upwards [v.ae_tendsto_lim_ratio hÏ, ae_measurable.ae_eq_mk (v.ae_measurable_lim_ratio hÏ)],
  assume x hx h'x,
  rwa h'x at hx,
end
lemma measure_le_mul_of_subset_lim_ratio_meas_lt
  {p : â„â‰¥0} {s : set Î±} (h : s âŠ† {x | v.lim_ratio_meas hÏ x < p}) :
  Ï s â‰¤ p * Î¼ s :=
begin
  let t := {x : Î± | tendsto (Î» a, Ï a / Î¼ a) (v.filter_at x) (ğ“ (v.lim_ratio_meas hÏ x))},
  have A : Î¼ tá¶œ = 0 := v.ae_tendsto_lim_ratio_meas hÏ,
  suffices H : Ï (s âˆ© t) â‰¤ (p â€¢ Î¼) (s âˆ© t), from calc
    Ï s = Ï ((s âˆ© t) âˆª (s âˆ© tá¶œ)) : by rw inter_union_compl
    ... â‰¤ Ï (s âˆ© t) + Ï (s âˆ© tá¶œ) : measure_union_le _ _
    ... â‰¤ p * Î¼ (s âˆ© t) + 0 :
      add_le_add H ((measure_mono (inter_subset_right _ _)).trans (hÏ A).le)
    ... â‰¤ p * Î¼ s :
      by { rw add_zero, exact ennreal.mul_le_mul le_rfl (measure_mono (inter_subset_left _ _)) },
  refine v.measure_le_of_frequently_le _ hÏ _ (Î» x hx, _),
  have I : âˆ€á¶  (b : set Î±) in v.filter_at x, Ï b / Î¼ b < p := (tendsto_order.1 hx.2).2 _ (h hx.1),
  apply I.frequently.mono (Î» a ha, _),
  rw [coe_nnreal_smul_apply],
  refine (ennreal.div_le_iff_le_mul _ (or.inr (bot_le.trans_lt ha).ne')).1 ha.le,
  simp only [ennreal.coe_ne_top, ne.def, or_true, not_false_iff]
end
lemma mul_measure_le_of_subset_lt_lim_ratio_meas
  {q : â„â‰¥0} {s : set Î±} (h : s âŠ† {x | (q : â„â‰¥0âˆ) < v.lim_ratio_meas hÏ x}) :
  (q : â„â‰¥0âˆ) * Î¼ s â‰¤ Ï s :=
begin
  let t := {x : Î± | tendsto (Î» a, Ï a / Î¼ a) (v.filter_at x) (ğ“ (v.lim_ratio_meas hÏ x))},
  have A : Î¼ tá¶œ = 0 := v.ae_tendsto_lim_ratio_meas hÏ,
  suffices H : (q â€¢ Î¼) (s âˆ© t) â‰¤ Ï (s âˆ© t), from calc
    (q â€¢ Î¼) s = (q â€¢ Î¼) ((s âˆ© t) âˆª (s âˆ© tá¶œ)) : by rw inter_union_compl
    ... â‰¤ (q â€¢ Î¼) (s âˆ© t) + (q â€¢ Î¼) (s âˆ© tá¶œ) : measure_union_le _ _
    ... â‰¤ Ï (s âˆ© t) + q * Î¼ tá¶œ : begin
        apply add_le_add H,
        rw [coe_nnreal_smul_apply],
        exact ennreal.mul_le_mul le_rfl (measure_mono (inter_subset_right _ _)),
      end
    ... â‰¤ Ï s :
      by { rw [A, mul_zero, add_zero], exact measure_mono (inter_subset_left _ _) },
  refine v.measure_le_of_frequently_le _ (absolutely_continuous.rfl.smul _) _ _,
  assume x hx,
  have I : âˆ€á¶  a in v.filter_at x, (q : â„â‰¥0âˆ) < Ï a / Î¼ a := (tendsto_order.1 hx.2).1 _ (h hx.1),
  apply I.frequently.mono (Î» a ha, _),
  rw [coe_nnreal_smul_apply],
  exact ennreal.mul_le_of_le_div ha.le
end
lemma measure_lim_ratio_meas_top : Î¼ {x | v.lim_ratio_meas hÏ x = âˆ} = 0 :=
begin
  refine null_of_locally_null _ (Î» x hx, _),
  obtain âŸ¨o, xo, o_open, Î¼oâŸ© : âˆƒ o : set Î±, x âˆˆ o âˆ§ is_open o âˆ§ Ï o < âˆ :=
    measure.exists_is_open_measure_lt_top Ï x,
  let s := {x : Î± | v.lim_ratio_meas hÏ x = âˆ} âˆ© o,
  refine âŸ¨s, inter_mem_nhds_within _ (o_open.mem_nhds xo), le_antisymm _ bot_leâŸ©,
  have Ïs : Ï s â‰  âˆ := ((measure_mono (inter_subset_right _ _)).trans_lt Î¼o).ne,
  have A : âˆ€ (q : â„â‰¥0), 1 â‰¤ q â†’ Î¼ s â‰¤ qâ»Â¹ * Ï s,
  { assume q hq,
    rw [mul_comm, â† div_eq_mul_inv, ennreal.le_div_iff_mul_le _ (or.inr Ïs), mul_comm],
    { apply v.mul_measure_le_of_subset_lt_lim_ratio_meas hÏ,
      assume y hy,
      have : v.lim_ratio_meas hÏ y = âˆ := hy.1,
      simp only [this, ennreal.coe_lt_top, mem_set_of_eq], },
    { simp only [(zero_lt_one.trans_le hq).ne', true_or, ennreal.coe_eq_zero, ne.def,
        not_false_iff] } },
  have B : tendsto (Î» (q : â„â‰¥0), (q : â„â‰¥0âˆ)â»Â¹ * Ï s) at_top (ğ“ (âˆâ»Â¹ * Ï s)),
  { apply ennreal.tendsto.mul_const _ (or.inr Ïs),
    exact ennreal.tendsto_inv_iff.2 (ennreal.tendsto_coe_nhds_top.2 tendsto_id) },
  simp only [zero_mul, ennreal.inv_top] at B,
  apply ge_of_tendsto B,
  exact eventually_at_top.2 âŸ¨1, AâŸ©,
end
lemma measure_lim_ratio_meas_zero : Ï {x | v.lim_ratio_meas hÏ x = 0} = 0 :=
begin
  refine null_of_locally_null _ (Î» x hx, _),
  obtain âŸ¨o, xo, o_open, Î¼oâŸ© : âˆƒ o : set Î±, x âˆˆ o âˆ§ is_open o âˆ§ Î¼ o < âˆ :=
    measure.exists_is_open_measure_lt_top Î¼ x,
  let s := {x : Î± | v.lim_ratio_meas hÏ x = 0} âˆ© o,
  refine âŸ¨s, inter_mem_nhds_within _ (o_open.mem_nhds xo), le_antisymm _ bot_leâŸ©,
  have Î¼s : Î¼ s â‰  âˆ := ((measure_mono (inter_subset_right _ _)).trans_lt Î¼o).ne,
  have A : âˆ€ (q : â„â‰¥0), 0 < q â†’ Ï s â‰¤ q * Î¼ s,
  { assume q hq,
    apply v.measure_le_mul_of_subset_lim_ratio_meas_lt hÏ,
    assume y hy,
    have : v.lim_ratio_meas hÏ y = 0 := hy.1,
    simp only [this, mem_set_of_eq, hq, ennreal.coe_pos], },
  have B : tendsto (Î» (q : â„â‰¥0), (q : â„â‰¥0âˆ) * Î¼ s) (ğ“[>] (0 : â„â‰¥0)) (ğ“ ((0 : â„â‰¥0) * Î¼ s)),
  { apply ennreal.tendsto.mul_const _ (or.inr Î¼s),
    rw ennreal.tendsto_coe,
    exact nhds_within_le_nhds },
  simp only [zero_mul, ennreal.coe_zero] at B,
  apply ge_of_tendsto B,
  filter_upwards [self_mem_nhds_within] using A,
end
lemma with_density_le_mul {s : set Î±} (hs : measurable_set s) {t : â„â‰¥0} (ht : 1 < t) :
  Î¼.with_density (v.lim_ratio_meas hÏ) s â‰¤ t^2 * Ï s :=
begin
  have t_ne_zero' : t â‰  0 := (zero_lt_one.trans ht).ne',
  have t_ne_zero : (t : â„â‰¥0âˆ) â‰  0, by simpa only [ennreal.coe_eq_zero, ne.def] using t_ne_zero',
  let Î½ := Î¼.with_density (v.lim_ratio_meas hÏ),
  let f := v.lim_ratio_meas hÏ,
  have f_meas : measurable f := v.lim_ratio_meas_measurable hÏ,
  have A : Î½ (s âˆ© f â»Â¹' ({0})) â‰¤ ((t : â„â‰¥0âˆ)^2 â€¢ Ï) (s âˆ© fâ»Â¹' {0}),
  { apply le_trans _ (zero_le _),
    have M : measurable_set (s âˆ© f â»Â¹' ({0})) := hs.inter (f_meas (measurable_set_singleton _)),
    simp only [Î½, f, nonpos_iff_eq_zero, M, with_density_apply, lintegral_eq_zero_iff f_meas],
    apply (ae_restrict_iff' M).2,
    exact eventually_of_forall (Î» x hx, hx.2) },
  have B : Î½ (s âˆ© f â»Â¹' ({âˆ})) â‰¤ ((t : â„â‰¥0âˆ)^2 â€¢ Ï) (s âˆ© fâ»Â¹' {âˆ}),
  { apply le_trans (le_of_eq _) (zero_le _),
    apply with_density_absolutely_continuous Î¼ _,
    rw â† nonpos_iff_eq_zero,
    exact (measure_mono (inter_subset_right _ _)).trans (v.measure_lim_ratio_meas_top hÏ).le },
  have C : âˆ€ (n : â„¤), Î½ (s âˆ© fâ»Â¹' (Ico (t^n) (t^(n+1))))
                        â‰¤ ((t : â„â‰¥0âˆ)^2 â€¢ Ï) (s âˆ© fâ»Â¹' (Ico (t^n) (t^(n+1)))),
  { assume n,
    let I := Ico ((t : â„â‰¥0âˆ)^n) (t^(n+1)),
    have M : measurable_set (s âˆ© f â»Â¹' I) := hs.inter (f_meas measurable_set_Ico),
    simp only [f, M, with_density_apply, coe_nnreal_smul_apply],
    calc
    âˆ«â» x in s âˆ© fâ»Â¹' I, f x âˆ‚Î¼
        â‰¤ âˆ«â» x in s âˆ© fâ»Â¹' I, t^(n+1) âˆ‚Î¼ :
          lintegral_mono_ae ((ae_restrict_iff' M).2 (eventually_of_forall (Î» x hx, hx.2.2.le)))
    ... = t^(n+1) * Î¼ (s âˆ© fâ»Â¹' I) :
          by simp only [lintegral_const, measurable_set.univ, measure.restrict_apply, univ_inter]
    ... = t^(2 : â„¤) * (t^(n-1) * Î¼ (s âˆ© fâ»Â¹' I)) : begin
        rw [â† mul_assoc, â† ennreal.zpow_add t_ne_zero ennreal.coe_ne_top],
        congr' 2,
        abel,
      end
    ... â‰¤ t^2 * Ï (s âˆ© f â»Â¹' I) : begin
        apply ennreal.mul_le_mul le_rfl _,
        rw â† ennreal.coe_zpow (zero_lt_one.trans ht).ne',
        apply v.mul_measure_le_of_subset_lt_lim_ratio_meas hÏ,
        assume x hx,
        apply lt_of_lt_of_le _ hx.2.1,
        rw [â† ennreal.coe_zpow (zero_lt_one.trans ht).ne', ennreal.coe_lt_coe, sub_eq_add_neg,
          zpow_addâ‚€ t_ne_zero'],
        conv_rhs { rw â† mul_one (t^ n) },
        refine mul_lt_mul' le_rfl _ (zero_le _) (nnreal.zpow_pos t_ne_zero' _),
        rw zpow_neg_one,
        exact nnreal.inv_lt_one ht,
      end },
  calc Î½ s = Î½ (s âˆ© fâ»Â¹' {0}) + Î½ (s âˆ© fâ»Â¹' {âˆ}) + âˆ‘' (n : â„¤), Î½ (s âˆ© fâ»Â¹' (Ico (t^n) (t^(n+1)))) :
    measure_eq_measure_preimage_add_measure_tsum_Ico_zpow Î½ f_meas hs ht
  ... â‰¤ ((t : â„â‰¥0âˆ)^2 â€¢ Ï) (s âˆ© fâ»Â¹' {0}) + ((t : â„â‰¥0âˆ)^2 â€¢ Ï) (s âˆ© fâ»Â¹' {âˆ})
          + âˆ‘' (n : â„¤), ((t : â„â‰¥0âˆ)^2 â€¢ Ï) (s âˆ© fâ»Â¹' (Ico (t^n) (t^(n+1)))) :
            add_le_add (add_le_add A B) (ennreal.tsum_le_tsum C)
  ... = ((t : â„â‰¥0âˆ)^2 â€¢ Ï) s :
    (measure_eq_measure_preimage_add_measure_tsum_Ico_zpow ((t : â„â‰¥0âˆ)^2 â€¢ Ï) f_meas hs ht).symm
end
lemma le_mul_with_density {s : set Î±} (hs : measurable_set s) {t : â„â‰¥0} (ht : 1 < t) :
  Ï s â‰¤ t * Î¼.with_density (v.lim_ratio_meas hÏ) s :=
begin
  have t_ne_zero' : t â‰  0 := (zero_lt_one.trans ht).ne',
  have t_ne_zero : (t : â„â‰¥0âˆ) â‰  0, by simpa only [ennreal.coe_eq_zero, ne.def] using t_ne_zero',
  let Î½ := Î¼.with_density (v.lim_ratio_meas hÏ),
  let f := v.lim_ratio_meas hÏ,
  have f_meas : measurable f := v.lim_ratio_meas_measurable hÏ,
  have A : Ï (s âˆ© f â»Â¹' ({0})) â‰¤ (t â€¢ Î½) (s âˆ© fâ»Â¹' {0}),
  { refine le_trans (measure_mono (inter_subset_right _ _)) (le_trans (le_of_eq _) (zero_le _)),
    exact v.measure_lim_ratio_meas_zero hÏ },
  have B : Ï (s âˆ© f â»Â¹' ({âˆ})) â‰¤ (t â€¢ Î½) (s âˆ© fâ»Â¹' {âˆ}),
  { apply le_trans (le_of_eq _) (zero_le _),
    apply hÏ,
    rw â† nonpos_iff_eq_zero,
    exact (measure_mono (inter_subset_right _ _)).trans (v.measure_lim_ratio_meas_top hÏ).le },
  have C : âˆ€ (n : â„¤), Ï (s âˆ© fâ»Â¹' (Ico (t^n) (t^(n+1))))
                        â‰¤ (t â€¢ Î½) (s âˆ© fâ»Â¹' (Ico (t^n) (t^(n+1)))),
  { assume n,
    let I := Ico ((t : â„â‰¥0âˆ)^n) (t^(n+1)),
    have M : measurable_set (s âˆ© f â»Â¹' I) := hs.inter (f_meas measurable_set_Ico),
    simp only [f, M, with_density_apply, coe_nnreal_smul_apply],
    calc Ï (s âˆ© f â»Â¹' I) â‰¤ t^ (n+1) * Î¼ (s âˆ© f â»Â¹' I) : begin
        rw â† ennreal.coe_zpow t_ne_zero',
        apply v.measure_le_mul_of_subset_lim_ratio_meas_lt hÏ,
        assume x hx,
        apply hx.2.2.trans_le (le_of_eq _),
        rw ennreal.coe_zpow t_ne_zero',
      end
    ... = âˆ«â» x in s âˆ© fâ»Â¹' I, t^(n+1) âˆ‚Î¼ :
      by simp only [lintegral_const, measurable_set.univ, measure.restrict_apply, univ_inter]
    ... â‰¤ âˆ«â» x in s âˆ© fâ»Â¹' I, t * f x âˆ‚Î¼ : begin
        apply lintegral_mono_ae ((ae_restrict_iff' M).2 (eventually_of_forall (Î» x hx, _))),
        rw [add_comm, ennreal.zpow_add t_ne_zero ennreal.coe_ne_top, zpow_one],
        exact ennreal.mul_le_mul le_rfl hx.2.1,
      end
    ... = t * âˆ«â» x in s âˆ© fâ»Â¹' I, f x âˆ‚Î¼ : lintegral_const_mul _ f_meas },
  calc Ï s = Ï (s âˆ© fâ»Â¹' {0}) + Ï (s âˆ© fâ»Â¹' {âˆ}) + âˆ‘' (n : â„¤), Ï (s âˆ© fâ»Â¹' (Ico (t^n) (t^(n+1)))) :
    measure_eq_measure_preimage_add_measure_tsum_Ico_zpow Ï f_meas hs ht
  ... â‰¤ (t â€¢ Î½) (s âˆ© fâ»Â¹' {0}) + (t â€¢ Î½) (s âˆ© fâ»Â¹' {âˆ})
          + âˆ‘' (n : â„¤), (t â€¢ Î½) (s âˆ© fâ»Â¹' (Ico (t^n) (t^(n+1)))) :
            add_le_add (add_le_add A B) (ennreal.tsum_le_tsum C)
  ... = (t â€¢ Î½) s :
    (measure_eq_measure_preimage_add_measure_tsum_Ico_zpow (t â€¢ Î½) f_meas hs ht).symm
end
theorem with_density_lim_ratio_meas_eq : Î¼.with_density (v.lim_ratio_meas hÏ) = Ï :=
begin
  ext1 s hs,
  refine le_antisymm _ _,
  { have : tendsto (Î» (t : â„â‰¥0), (t^2 * Ï s : â„â‰¥0âˆ)) (ğ“[>] 1) (ğ“ ((1 : â„â‰¥0)^2 * Ï s)),
    { refine ennreal.tendsto.mul _ _ tendsto_const_nhds _,
      { exact ennreal.tendsto.pow (ennreal.tendsto_coe.2 nhds_within_le_nhds) },
      { simp only [one_pow, ennreal.coe_one, true_or, ne.def, not_false_iff, one_ne_zero] },
      { simp only [one_pow, ennreal.coe_one, ne.def, or_true, ennreal.one_ne_top,
                   not_false_iff] } },
    simp only [one_pow, one_mul, ennreal.coe_one] at this,
    refine ge_of_tendsto this _,
    filter_upwards [self_mem_nhds_within] with _ ht,
    exact v.with_density_le_mul hÏ hs ht, },
  { have : tendsto (Î» (t : â„â‰¥0), (t : â„â‰¥0âˆ) * Î¼.with_density (v.lim_ratio_meas hÏ) s) (ğ“[>] 1)
            (ğ“ ((1 : â„â‰¥0) * Î¼.with_density (v.lim_ratio_meas hÏ) s)),
    { refine ennreal.tendsto.mul_const (ennreal.tendsto_coe.2 nhds_within_le_nhds) _,
      simp only [ennreal.coe_one, true_or, ne.def, not_false_iff, one_ne_zero], },
    simp only [one_mul, ennreal.coe_one] at this,
    refine ge_of_tendsto this _,
    filter_upwards [self_mem_nhds_within] with _ ht,
    exact v.le_mul_with_density hÏ hs ht }
end
theorem ae_tendsto_rn_deriv_of_absolutely_continuous :
  âˆ€áµ x âˆ‚Î¼, tendsto (Î» a, Ï a / Î¼ a) (v.filter_at x) (ğ“ (Ï.rn_deriv Î¼ x)) :=
begin
  have A : (Î¼.with_density (v.lim_ratio_meas hÏ)).rn_deriv Î¼ =áµ[Î¼] v.lim_ratio_meas hÏ :=
    rn_deriv_with_density Î¼ (v.lim_ratio_meas_measurable hÏ),
  rw v.with_density_lim_ratio_meas_eq hÏ at A,
  filter_upwards [v.ae_tendsto_lim_ratio_meas hÏ, A] with _ _ h'x,
  rwa h'x,
end
end absolutely_continuous
variable (Ï)
theorem ae_tendsto_rn_deriv :
  âˆ€áµ x âˆ‚Î¼, tendsto (Î» a, Ï a / Î¼ a) (v.filter_at x) (ğ“ (Ï.rn_deriv Î¼ x)) :=
begin
  let t := Î¼.with_density (Ï.rn_deriv Î¼),
  have eq_add : Ï = Ï.singular_part Î¼ + t := have_lebesgue_decomposition_add _ _,
  have A : âˆ€áµ x âˆ‚Î¼, tendsto (Î» a, Ï.singular_part Î¼ a / Î¼ a) (v.filter_at x) (ğ“ 0) :=
    v.ae_eventually_measure_zero_of_singular (mutually_singular_singular_part Ï Î¼),
  have B : âˆ€áµ x âˆ‚Î¼, t.rn_deriv Î¼ x = Ï.rn_deriv Î¼ x :=
    rn_deriv_with_density Î¼ (measurable_rn_deriv Ï Î¼),
  have C : âˆ€áµ x âˆ‚Î¼, tendsto (Î» a, t a / Î¼ a) (v.filter_at x) (ğ“ (t.rn_deriv Î¼ x)) :=
    v.ae_tendsto_rn_deriv_of_absolutely_continuous (with_density_absolutely_continuous _ _),
  filter_upwards [A, B, C] with _ Ax Bx Cx,
  convert Ax.add Cx,
  { ext1 a,
    conv_lhs { rw [eq_add] },
    simp only [pi.add_apply, coe_add, ennreal.add_div] },
  { simp only [Bx, zero_add] }
end
lemma ae_tendsto_measure_inter_div_of_measurable_set {s : set Î±} (hs : measurable_set s) :
  âˆ€áµ x âˆ‚Î¼, tendsto (Î» a, Î¼ (s âˆ© a) / Î¼ a) (v.filter_at x) (ğ“ (s.indicator 1 x)) :=
begin
  haveI : is_locally_finite_measure (Î¼.restrict s) :=
    is_locally_finite_measure_of_le restrict_le_self,
  filter_upwards [ae_tendsto_rn_deriv v (Î¼.restrict s), rn_deriv_restrict Î¼ hs],
  assume x hx h'x,
  simpa only [h'x, restrict_apply' hs, inter_comm] using hx,
end
lemma ae_tendsto_measure_inter_div (s : set Î±) :
  âˆ€áµ x âˆ‚(Î¼.restrict s), tendsto (Î» a, Î¼ (s âˆ© a) / Î¼ a) (v.filter_at x) (ğ“ 1) :=
begin
  let t := to_measurable Î¼ s,
  have A : âˆ€áµ x âˆ‚(Î¼.restrict s),
    tendsto (Î» a, Î¼ (t âˆ© a) / Î¼ a) (v.filter_at x) (ğ“ (t.indicator 1 x)),
  { apply ae_mono restrict_le_self,
    apply ae_tendsto_measure_inter_div_of_measurable_set,
    exact measurable_set_to_measurable _ _ },
  have B : âˆ€áµ x âˆ‚(Î¼.restrict s), t.indicator 1 x = (1 : â„â‰¥0âˆ),
  { refine ae_restrict_of_ae_restrict_of_subset (subset_to_measurable Î¼ s) _,
    filter_upwards [ae_restrict_mem (measurable_set_to_measurable Î¼ s)] with _ hx,
    simp only [hx, pi.one_apply, indicator_of_mem] },
  filter_upwards [A, B] with x hx h'x,
  rw [h'x] at hx,
  apply hx.congr' _,
  filter_upwards [v.eventually_filter_at_measurable_set x] with _ ha,
  congr' 1,
  exact measure_to_measurable_inter_of_sigma_finite ha _,
end
end
end vitali_family
