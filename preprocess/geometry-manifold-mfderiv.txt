import geometry.manifold.tangent_bundle
noncomputable theory
open_locale classical topological_space manifold
open set
universe u
section derivatives_definitions
variables {ğ•œ : Type*} [nondiscrete_normed_field ğ•œ]
{E : Type*} [normed_group E] [normed_space ğ•œ E]
{H : Type*} [topological_space H] (I : model_with_corners ğ•œ E H)
{M : Type*} [topological_space M] [charted_space H M]
{E' : Type*} [normed_group E'] [normed_space ğ•œ E']
{H' : Type*} [topological_space H'] (I' : model_with_corners ğ•œ E' H')
{M' : Type*} [topological_space M'] [charted_space H' M']
def unique_mdiff_within_at (s : set M) (x : M) :=
unique_diff_within_at ğ•œ ((ext_chart_at I x).symm â»Â¹' s âˆ© range I) ((ext_chart_at I x) x)
def unique_mdiff_on (s : set M) :=
âˆ€xâˆˆs, unique_mdiff_within_at I s x
@[simp, mfld_simps] def written_in_ext_chart_at (x : M) (f : M â†’ M') : E â†’ E' :=
(ext_chart_at I' (f x)) âˆ˜ f âˆ˜ (ext_chart_at I x).symm
def mdifferentiable_within_at (f : M â†’ M') (s : set M) (x : M) :=
continuous_within_at f s x âˆ§
differentiable_within_at ğ•œ (written_in_ext_chart_at I I' x f)
  ((ext_chart_at I x).symm â»Â¹' s âˆ© range I) ((ext_chart_at I x) x)
def mdifferentiable_at (f : M â†’ M') (x : M) :=
continuous_at f x âˆ§
differentiable_within_at ğ•œ (written_in_ext_chart_at I I' x f) (range I)
  ((ext_chart_at I x) x)
def mdifferentiable_on (f : M â†’ M') (s : set M) :=
âˆ€x âˆˆ s, mdifferentiable_within_at I I' f s x
def mdifferentiable (f : M â†’ M') :=
âˆ€x, mdifferentiable_at I I' f x
def local_homeomorph.mdifferentiable (f : local_homeomorph M M') :=
(mdifferentiable_on I I' f f.source) âˆ§ (mdifferentiable_on I' I f.symm f.target)
variables [smooth_manifold_with_corners I M] [smooth_manifold_with_corners I' M']
def has_mfderiv_within_at (f : M â†’ M') (s : set M) (x : M)
  (f' : tangent_space I x â†’L[ğ•œ] tangent_space I' (f x)) :=
continuous_within_at f s x âˆ§
has_fderiv_within_at (written_in_ext_chart_at I I' x f : E â†’ E') f'
  ((ext_chart_at I x).symm â»Â¹' s âˆ© range I) ((ext_chart_at I x) x)
def has_mfderiv_at (f : M â†’ M') (x : M)
  (f' : tangent_space I x â†’L[ğ•œ] tangent_space I' (f x)) :=
continuous_at f x âˆ§
has_fderiv_within_at (written_in_ext_chart_at I I' x f : E â†’ E') f' (range I)
  ((ext_chart_at I x) x)
def mfderiv_within (f : M â†’ M') (s : set M) (x : M) :
  tangent_space I x â†’L[ğ•œ] tangent_space I' (f x) :=
if h : mdifferentiable_within_at I I' f s x then
(fderiv_within ğ•œ (written_in_ext_chart_at I I' x f) ((ext_chart_at I x).symm â»Â¹' s âˆ© range I)
  ((ext_chart_at I x) x) : _)
else 0
def mfderiv (f : M â†’ M') (x : M) : tangent_space I x â†’L[ğ•œ] tangent_space I' (f x) :=
if h : mdifferentiable_at I I' f x then
(fderiv_within ğ•œ (written_in_ext_chart_at I I' x f : E â†’ E') (range I)
  ((ext_chart_at I x) x) : _)
else 0
def tangent_map_within (f : M â†’ M') (s : set M) : tangent_bundle I M â†’ tangent_bundle I' M' :=
Î»p, âŸ¨f p.1, (mfderiv_within I I' f s p.1 : tangent_space I p.1 â†’ tangent_space I' (f p.1)) p.2âŸ©
def tangent_map (f : M â†’ M') : tangent_bundle I M â†’ tangent_bundle I' M' :=
Î»p, âŸ¨f p.1, (mfderiv I I' f p.1 : tangent_space I p.1 â†’ tangent_space I' (f p.1)) p.2âŸ©
end derivatives_definitions
section derivatives_properties
variables {ğ•œ : Type*} [nondiscrete_normed_field ğ•œ]
{E : Type*} [normed_group E] [normed_space ğ•œ E]
{H : Type*} [topological_space H] (I : model_with_corners ğ•œ E H)
variables [Is : smooth_manifold_with_corners I M] [I's : smooth_manifold_with_corners I' M']
[I''s : smooth_manifold_with_corners I'' M'']
{f' fâ‚€' fâ‚' : tangent_space I x â†’L[ğ•œ] tangent_space I' (f x)}
{g' : tangent_space I' (f x) â†’L[ğ•œ] tangent_space I'' (g (f x))}
theorem unique_mdiff_within_at.eq (U : unique_mdiff_within_at I s x)
  (h : has_mfderiv_within_at I I' f s x f') (hâ‚ : has_mfderiv_within_at I I' f s x fâ‚') :
  f' = fâ‚' :=
U.eq h.2 hâ‚.2
theorem unique_mdiff_on.eq (U : unique_mdiff_on I s) (hx : x âˆˆ s)
  (h : has_mfderiv_within_at I I' f s x f') (hâ‚ : has_mfderiv_within_at I I' f s x fâ‚') :
  f' = fâ‚' :=
unique_mdiff_within_at.eq (U _ hx) h hâ‚
lemma mdifferentiable_within_at_iff {f : M â†’ M'} {s : set M} {x : M} :
  mdifferentiable_within_at I I' f s x â†”
  continuous_within_at f s x âˆ§
  differentiable_within_at ğ•œ (written_in_ext_chart_at I I' x f)
    ((ext_chart_at I x).target âˆ© (ext_chart_at I x).symm â»Â¹' s) ((ext_chart_at I x) x) :=
begin
  refine and_congr iff.rfl (exists_congr $ Î» f', _),
  rw [inter_comm],
  simp only [has_fderiv_within_at, nhds_within_inter, nhds_within_ext_chart_target_eq]
end
include Is I's
lemma mfderiv_within_zero_of_not_mdifferentiable_within_at
  (h : Â¬ mdifferentiable_within_at I I' f s x) : mfderiv_within I I' f s x = 0 :=
by simp only [mfderiv_within, h, dif_neg, not_false_iff]
lemma mfderiv_zero_of_not_mdifferentiable_at
  (h : Â¬ mdifferentiable_at I I' f x) : mfderiv I I' f x = 0 :=
by simp only [mfderiv, h, dif_neg, not_false_iff]
theorem has_mfderiv_within_at.mono (h : has_mfderiv_within_at I I' f t x f') (hst : s âŠ† t) :
  has_mfderiv_within_at I I' f s x f' :=
âŸ¨ continuous_within_at.mono h.1 hst,
  has_fderiv_within_at.mono h.2 (inter_subset_inter (preimage_mono hst) (subset.refl _)) âŸ©
theorem has_mfderiv_at.has_mfderiv_within_at
  (h : has_mfderiv_at I I' f x f') : has_mfderiv_within_at I I' f s x f' :=
âŸ¨ continuous_at.continuous_within_at h.1, has_fderiv_within_at.mono h.2 (inter_subset_right _ _) âŸ©
lemma has_mfderiv_within_at.mdifferentiable_within_at (h : has_mfderiv_within_at I I' f s x f') :
  mdifferentiable_within_at I I' f s x :=
âŸ¨h.1, âŸ¨f', h.2âŸ©âŸ©
lemma has_mfderiv_at.mdifferentiable_at (h : has_mfderiv_at I I' f x f') :
  mdifferentiable_at I I' f x :=
âŸ¨h.1, âŸ¨f', h.2âŸ©âŸ©
@[simp, mfld_simps] lemma has_mfderiv_within_at_univ :
  has_mfderiv_within_at I I' f univ x f' â†” has_mfderiv_at I I' f x f' :=
by simp only [has_mfderiv_within_at, has_mfderiv_at, continuous_within_at_univ] with mfld_simps
theorem has_mfderiv_at_unique
  (hâ‚€ : has_mfderiv_at I I' f x fâ‚€') (hâ‚ : has_mfderiv_at I I' f x fâ‚') : fâ‚€' = fâ‚' :=
begin
  rw â† has_mfderiv_within_at_univ at hâ‚€ hâ‚,
  exact (unique_mdiff_within_at_univ I).eq hâ‚€ hâ‚
end
lemma has_mfderiv_within_at_inter' (h : t âˆˆ ğ“[s] x) :
  has_mfderiv_within_at I I' f (s âˆ© t) x f' â†” has_mfderiv_within_at I I' f s x f' :=
begin
  rw [has_mfderiv_within_at, has_mfderiv_within_at, ext_chart_preimage_inter_eq,
      has_fderiv_within_at_inter', continuous_within_at_inter' h],
  exact ext_chart_preimage_mem_nhds_within I x h,
end
lemma has_mfderiv_within_at_inter (h : t âˆˆ ğ“ x) :
  has_mfderiv_within_at I I' f (s âˆ© t) x f' â†” has_mfderiv_within_at I I' f s x f' :=
begin
  rw [has_mfderiv_within_at, has_mfderiv_within_at, ext_chart_preimage_inter_eq,
      has_fderiv_within_at_inter, continuous_within_at_inter h],
  exact ext_chart_preimage_mem_nhds I x h,
end
lemma has_mfderiv_within_at.union
  (hs : has_mfderiv_within_at I I' f s x f') (ht : has_mfderiv_within_at I I' f t x f') :
  has_mfderiv_within_at I I' f (s âˆª t) x f' :=
begin
  split,
  { exact continuous_within_at.union hs.1 ht.1 },
  { convert has_fderiv_within_at.union hs.2 ht.2,
    simp only [union_inter_distrib_right, preimage_union] }
end
lemma has_mfderiv_within_at.nhds_within (h : has_mfderiv_within_at I I' f s x f')
  (ht : s âˆˆ ğ“[t] x) : has_mfderiv_within_at I I' f t x f' :=
(has_mfderiv_within_at_inter' ht).1 (h.mono (inter_subset_right _ _))
lemma has_mfderiv_within_at.has_mfderiv_at (h : has_mfderiv_within_at I I' f s x f')
  (hs : s âˆˆ ğ“ x) :
  has_mfderiv_at I I' f x f' :=
by rwa [â† univ_inter s, has_mfderiv_within_at_inter hs, has_mfderiv_within_at_univ] at h
lemma mdifferentiable_within_at.has_mfderiv_within_at (h : mdifferentiable_within_at I I' f s x) :
  has_mfderiv_within_at I I' f s x (mfderiv_within I I' f s x) :=
begin
  refine âŸ¨h.1, _âŸ©,
  simp only [mfderiv_within, h, dif_pos] with mfld_simps,
  exact differentiable_within_at.has_fderiv_within_at h.2
end
lemma mdifferentiable_within_at.mfderiv_within (h : mdifferentiable_within_at I I' f s x) :
  (mfderiv_within I I' f s x) =
  fderiv_within ğ•œ (written_in_ext_chart_at I I' x f : _) ((ext_chart_at I x).symm â»Â¹' s âˆ© range I)
  ((ext_chart_at I x) x) :=
by simp only [mfderiv_within, h, dif_pos]
lemma mdifferentiable_at.has_mfderiv_at (h : mdifferentiable_at I I' f x) :
  has_mfderiv_at I I' f x (mfderiv I I' f x) :=
begin
  refine âŸ¨h.1, _âŸ©,
  simp only [mfderiv, h, dif_pos] with mfld_simps,
  exact differentiable_within_at.has_fderiv_within_at h.2
end
lemma mdifferentiable_at.mfderiv (h : mdifferentiable_at I I' f x) :
  (mfderiv I I' f x) =
  fderiv_within ğ•œ (written_in_ext_chart_at I I' x f : _) (range I) ((ext_chart_at I x) x) :=
by simp only [mfderiv, h, dif_pos]
lemma has_mfderiv_at.mfderiv (h : has_mfderiv_at I I' f x f') :
  mfderiv I I' f x = f' :=
(has_mfderiv_at_unique h h.mdifferentiable_at.has_mfderiv_at).symm
lemma has_mfderiv_within_at.mfderiv_within
  (h : has_mfderiv_within_at I I' f s x f') (hxs : unique_mdiff_within_at I s x) :
  mfderiv_within I I' f s x = f' :=
by { ext, rw hxs.eq h h.mdifferentiable_within_at.has_mfderiv_within_at }
lemma mdifferentiable.mfderiv_within
  (h : mdifferentiable_at I I' f x) (hxs : unique_mdiff_within_at I s x) :
  mfderiv_within I I' f s x = mfderiv I I' f x :=
begin
  apply has_mfderiv_within_at.mfderiv_within _ hxs,
  exact h.has_mfderiv_at.has_mfderiv_within_at
end
lemma mfderiv_within_subset (st : s âŠ† t) (hs : unique_mdiff_within_at I s x)
  (h : mdifferentiable_within_at I I' f t x) :
  mfderiv_within I I' f s x = mfderiv_within I I' f t x :=
((mdifferentiable_within_at.has_mfderiv_within_at h).mono st).mfderiv_within hs
omit Is I's
lemma mdifferentiable_within_at.mono (hst : s âŠ† t)
  (h : mdifferentiable_within_at I I' f t x) : mdifferentiable_within_at I I' f s x :=
âŸ¨ continuous_within_at.mono h.1 hst,
  differentiable_within_at.mono h.2 (inter_subset_inter (preimage_mono hst) (subset.refl _)) âŸ©
lemma mdifferentiable_within_at_univ :
  mdifferentiable_within_at I I' f univ x â†” mdifferentiable_at I I' f x :=
by simp only [mdifferentiable_within_at, mdifferentiable_at, continuous_within_at_univ]
  with mfld_simps
lemma mdifferentiable_within_at_inter (ht : t âˆˆ ğ“ x) :
  mdifferentiable_within_at I I' f (s âˆ© t) x â†” mdifferentiable_within_at I I' f s x :=
begin
  rw [mdifferentiable_within_at, mdifferentiable_within_at, ext_chart_preimage_inter_eq,
      differentiable_within_at_inter, continuous_within_at_inter ht],
  exact ext_chart_preimage_mem_nhds I x ht
end
lemma mdifferentiable_within_at_inter' (ht : t âˆˆ ğ“[s] x) :
  mdifferentiable_within_at I I' f (s âˆ© t) x â†” mdifferentiable_within_at I I' f s x :=
begin
  rw [mdifferentiable_within_at, mdifferentiable_within_at, ext_chart_preimage_inter_eq,
      differentiable_within_at_inter', continuous_within_at_inter' ht],
  exact ext_chart_preimage_mem_nhds_within I x ht
end
lemma mdifferentiable_at.mdifferentiable_within_at
  (h : mdifferentiable_at I I' f x) : mdifferentiable_within_at I I' f s x :=
mdifferentiable_within_at.mono (subset_univ _) (mdifferentiable_within_at_univ.2 h)
lemma mdifferentiable_within_at.mdifferentiable_at
  (h : mdifferentiable_within_at I I' f s x) (hs : s âˆˆ ğ“ x) : mdifferentiable_at I I' f x :=
begin
  have : s = univ âˆ© s, by rw univ_inter,
  rwa [this, mdifferentiable_within_at_inter hs, mdifferentiable_within_at_univ] at h,
end
lemma mdifferentiable_on.mono
  (h : mdifferentiable_on I I' f t) (st : s âŠ† t) : mdifferentiable_on I I' f s :=
Î»x hx, (h x (st hx)).mono st
lemma mdifferentiable_on_univ :
  mdifferentiable_on I I' f univ â†” mdifferentiable I I' f :=
by { simp only [mdifferentiable_on, mdifferentiable_within_at_univ] with mfld_simps, refl }
lemma mdifferentiable.mdifferentiable_on
  (h : mdifferentiable I I' f) : mdifferentiable_on I I' f s :=
(mdifferentiable_on_univ.2 h).mono (subset_univ _)
lemma mdifferentiable_on_of_locally_mdifferentiable_on
  (h : âˆ€xâˆˆs, âˆƒu, is_open u âˆ§ x âˆˆ u âˆ§ mdifferentiable_on I I' f (s âˆ© u)) :
  mdifferentiable_on I I' f s :=
begin
  assume x xs,
  rcases h x xs with âŸ¨t, t_open, xt, htâŸ©,
  exact (mdifferentiable_within_at_inter (is_open.mem_nhds t_open xt)).1 (ht x âŸ¨xs, xtâŸ©)
end
include Is I's
@[simp, mfld_simps] lemma mfderiv_within_univ : mfderiv_within I I' f univ = mfderiv I I' f :=
begin
  ext x : 1,
  simp only [mfderiv_within, mfderiv] with mfld_simps,
  rw mdifferentiable_within_at_univ
end
lemma mfderiv_within_inter (ht : t âˆˆ ğ“ x) (hs : unique_mdiff_within_at I s x) :
  mfderiv_within I I' f (s âˆ© t) x = mfderiv_within I I' f s x :=
by rw [mfderiv_within, mfderiv_within, ext_chart_preimage_inter_eq,
  mdifferentiable_within_at_inter ht, fderiv_within_inter (ext_chart_preimage_mem_nhds I x ht) hs]
omit Is I's
theorem has_mfderiv_within_at.continuous_within_at
  (h : has_mfderiv_within_at I I' f s x f') : continuous_within_at f s x :=
h.1
theorem has_mfderiv_at.continuous_at (h : has_mfderiv_at I I' f x f') :
  continuous_at f x :=
h.1
lemma mdifferentiable_within_at.continuous_within_at (h : mdifferentiable_within_at I I' f s x) :
  continuous_within_at f s x :=
h.1
lemma mdifferentiable_at.continuous_at (h : mdifferentiable_at I I' f x) : continuous_at f x :=
h.1
lemma mdifferentiable_on.continuous_on (h : mdifferentiable_on I I' f s) : continuous_on f s :=
Î»x hx, (h x hx).continuous_within_at
lemma mdifferentiable.continuous (h : mdifferentiable I I' f) : continuous f :=
continuous_iff_continuous_at.2 $ Î»x, (h x).continuous_at
include Is I's
lemma tangent_map_within_subset {p : tangent_bundle I M}
  (st : s âŠ† t) (hs : unique_mdiff_within_at I s p.1) (h : mdifferentiable_within_at I I' f t p.1) :
  tangent_map_within I I' f s p = tangent_map_within I I' f t p :=
begin
  simp only [tangent_map_within] with mfld_simps,
  rw mfderiv_within_subset st hs h,
end
lemma tangent_map_within_univ :
  tangent_map_within I I' f univ = tangent_map I I' f :=
by { ext p : 1, simp only [tangent_map_within, tangent_map] with mfld_simps }
lemma tangent_map_within_eq_tangent_map {p : tangent_bundle I M}
  (hs : unique_mdiff_within_at I s p.1) (h : mdifferentiable_at I I' f p.1) :
  tangent_map_within I I' f s p = tangent_map I I' f p :=
begin
  rw â† mdifferentiable_within_at_univ at h,
  rw â† tangent_map_within_univ,
  exact tangent_map_within_subset (subset_univ _) hs h,
end
@[simp, mfld_simps] lemma tangent_map_within_tangent_bundle_proj {p : tangent_bundle I M} :
  tangent_bundle.proj I' M' (tangent_map_within I I' f s p) = f (tangent_bundle.proj I M p) := rfl
@[simp, mfld_simps] lemma tangent_map_within_proj {p : tangent_bundle I M} :
  (tangent_map_within I I' f s p).1 = f p.1 := rfl
@[simp, mfld_simps] lemma tangent_map_tangent_bundle_proj {p : tangent_bundle I M} :
  tangent_bundle.proj I' M' (tangent_map I I' f p) = f (tangent_bundle.proj I M p) := rfl
@[simp, mfld_simps] lemma tangent_map_proj {p : tangent_bundle I M} :
  (tangent_map I I' f p).1 = f p.1 := rfl
omit Is I's
lemma has_mfderiv_within_at.congr_of_eventually_eq (h : has_mfderiv_within_at I I' f s x f')
  (hâ‚ : fâ‚ =á¶ [ğ“[s] x] f) (hx : fâ‚ x = f x) : has_mfderiv_within_at I I' fâ‚ s x f' :=
begin
  refine âŸ¨continuous_within_at.congr_of_eventually_eq h.1 hâ‚ hx, _âŸ©,
  apply has_fderiv_within_at.congr_of_eventually_eq h.2,
  { have : (ext_chart_at I x).symm â»Â¹' {y | fâ‚ y = f y} âˆˆ
      ğ“[(ext_chart_at I x).symm â»Â¹' s âˆ© range I] ((ext_chart_at I x) x)  :=
      ext_chart_preimage_mem_nhds_within I x hâ‚,
    apply filter.mem_of_superset this (Î»y, _),
    simp only [hx] with mfld_simps {contextual := tt} },
  { simp only [hx] with mfld_simps },
end
lemma has_mfderiv_within_at.congr_mono (h : has_mfderiv_within_at I I' f s x f')
  (ht : âˆ€x âˆˆ t, fâ‚ x = f x) (hx : fâ‚ x = f x) (hâ‚ : t âŠ† s) :
  has_mfderiv_within_at I I' fâ‚ t x f' :=
(h.mono hâ‚).congr_of_eventually_eq (filter.mem_inf_of_right ht) hx
lemma has_mfderiv_at.congr_of_eventually_eq (h : has_mfderiv_at I I' f x f')
  (hâ‚ : fâ‚ =á¶ [ğ“ x] f) : has_mfderiv_at I I' fâ‚ x f' :=
begin
  rw â† has_mfderiv_within_at_univ at âŠ¢ h,
  apply h.congr_of_eventually_eq _ (mem_of_mem_nhds hâ‚ : _),
  rwa nhds_within_univ
end
include Is I's
lemma mdifferentiable_within_at.congr_of_eventually_eq
  (h : mdifferentiable_within_at I I' f s x) (hâ‚ : fâ‚ =á¶ [ğ“[s] x] f)
  (hx : fâ‚ x = f x) : mdifferentiable_within_at I I' fâ‚ s x :=
(h.has_mfderiv_within_at.congr_of_eventually_eq hâ‚ hx).mdifferentiable_within_at
variables (I I')
lemma filter.eventually_eq.mdifferentiable_within_at_iff
  (hâ‚ : fâ‚ =á¶ [ğ“[s] x] f) (hx : fâ‚ x = f x) :
  mdifferentiable_within_at I I' f s x â†” mdifferentiable_within_at I I' fâ‚ s x :=
begin
  split,
  { assume h,
    apply h.congr_of_eventually_eq hâ‚ hx },
  { assume h,
    apply h.congr_of_eventually_eq _ hx.symm,
    apply hâ‚.mono,
    intro y,
    apply eq.symm }
end
variables {I I'}
lemma mdifferentiable_within_at.congr_mono (h : mdifferentiable_within_at I I' f s x)
  (ht : âˆ€x âˆˆ t, fâ‚ x = f x) (hx : fâ‚ x = f x) (hâ‚ : t âŠ† s) :
  mdifferentiable_within_at I I' fâ‚ t x :=
(has_mfderiv_within_at.congr_mono h.has_mfderiv_within_at ht hx hâ‚).mdifferentiable_within_at
lemma mdifferentiable_within_at.congr (h : mdifferentiable_within_at I I' f s x)
  (ht : âˆ€x âˆˆ s, fâ‚ x = f x) (hx : fâ‚ x = f x) : mdifferentiable_within_at I I' fâ‚ s x :=
(has_mfderiv_within_at.congr_mono h.has_mfderiv_within_at ht hx
  (subset.refl _)).mdifferentiable_within_at
lemma mdifferentiable_on.congr_mono (h : mdifferentiable_on I I' f s) (h' : âˆ€x âˆˆ t, fâ‚ x = f x)
  (hâ‚ : t âŠ† s) : mdifferentiable_on I I' fâ‚ t :=
Î» x hx, (h x (hâ‚ hx)).congr_mono h' (h' x hx) hâ‚
lemma mdifferentiable_at.congr_of_eventually_eq (h : mdifferentiable_at I I' f x)
  (hL : fâ‚ =á¶ [ğ“ x] f) : mdifferentiable_at I I' fâ‚ x :=
((h.has_mfderiv_at).congr_of_eventually_eq hL).mdifferentiable_at
lemma mdifferentiable_within_at.mfderiv_within_congr_mono (h : mdifferentiable_within_at I I' f s x)
  (hs : âˆ€x âˆˆ t, fâ‚ x = f x) (hx : fâ‚ x = f x) (hxt : unique_mdiff_within_at I t x) (hâ‚ : t âŠ† s) :
  mfderiv_within I I' fâ‚ t x = (mfderiv_within I I' f s x : _) :=
(has_mfderiv_within_at.congr_mono h.has_mfderiv_within_at hs hx hâ‚).mfderiv_within hxt
lemma filter.eventually_eq.mfderiv_within_eq (hs : unique_mdiff_within_at I s x)
  (hL : fâ‚ =á¶ [ğ“[s] x] f) (hx : fâ‚ x = f x) :
  mfderiv_within I I' fâ‚ s x = (mfderiv_within I I' f s x : _) :=
begin
  by_cases h : mdifferentiable_within_at I I' f s x,
  { exact ((h.has_mfderiv_within_at).congr_of_eventually_eq hL hx).mfderiv_within hs },
  { unfold mfderiv_within,
    rw [dif_neg h, dif_neg],
    rwa â† hL.mdifferentiable_within_at_iff I I' hx }
end
lemma mfderiv_within_congr (hs : unique_mdiff_within_at I s x)
  (hL : âˆ€ x âˆˆ s, fâ‚ x = f x) (hx : fâ‚ x = f x) :
  mfderiv_within I I' fâ‚ s x = (mfderiv_within I I' f s x : _) :=
filter.eventually_eq.mfderiv_within_eq hs (filter.eventually_eq_of_mem (self_mem_nhds_within) hL) hx
lemma tangent_map_within_congr (h : âˆ€ x âˆˆ s, f x = fâ‚ x)
  (p : tangent_bundle I M) (hp : p.1 âˆˆ s) (hs : unique_mdiff_within_at I s p.1) :
  tangent_map_within I I' f s p = tangent_map_within I I' fâ‚ s p :=
begin
  simp only [tangent_map_within, h p.fst hp, true_and, eq_self_iff_true, heq_iff_eq,
    sigma.mk.inj_iff],
  congr' 1,
  exact mfderiv_within_congr hs h (h _ hp)
end
lemma filter.eventually_eq.mfderiv_eq (hL : fâ‚ =á¶ [ğ“ x] f) :
  mfderiv I I' fâ‚ x = (mfderiv I I' f x : _) :=
begin
  have A : fâ‚ x = f x := (mem_of_mem_nhds hL : _),
  rw [â† mfderiv_within_univ, â† mfderiv_within_univ],
  rw â† nhds_within_univ at hL,
  exact hL.mfderiv_within_eq (unique_mdiff_within_at_univ I) A
end
omit Is I's
lemma written_in_ext_chart_comp (h : continuous_within_at f s x) :
  {y | written_in_ext_chart_at I I'' x (g âˆ˜ f) y
       = ((written_in_ext_chart_at I' I'' (f x) g) âˆ˜ (written_in_ext_chart_at I I' x f)) y}
  âˆˆ ğ“[(ext_chart_at I x).symm â»Â¹' s âˆ© range I] ((ext_chart_at I x) x)  :=
begin
  apply @filter.mem_of_superset _ _
    ((f âˆ˜ (ext_chart_at I x).symm)â»Â¹' (ext_chart_at I' (f x)).source) _
    (ext_chart_preimage_mem_nhds_within I x
      (h.preimage_mem_nhds_within (ext_chart_at_source_mem_nhds _ _))),
  mfld_set_tac,
end
variable (x)
include Is I's I''s
theorem has_mfderiv_within_at.comp
  (hg : has_mfderiv_within_at I' I'' g u (f x) g') (hf : has_mfderiv_within_at I I' f s x f')
  (hst : s âŠ† f â»Â¹' u) :
  has_mfderiv_within_at I I'' (g âˆ˜ f) s x (g'.comp f') :=
begin
  refine âŸ¨continuous_within_at.comp hg.1 hf.1 hst, _âŸ©,
  have A : has_fderiv_within_at ((written_in_ext_chart_at I' I'' (f x) g) âˆ˜
       (written_in_ext_chart_at I I' x f))
    (continuous_linear_map.comp g' f' : E â†’L[ğ•œ] E'')
    ((ext_chart_at I x).symm â»Â¹' s âˆ© range (I))
    ((ext_chart_at I x) x),
  { have : (ext_chart_at I x).symm â»Â¹' (f â»Â¹' (ext_chart_at I' (f x)).source)
    âˆˆ ğ“[(ext_chart_at I x).symm â»Â¹' s âˆ© range I] ((ext_chart_at I x) x)  :=
      (ext_chart_preimage_mem_nhds_within I x
        (hf.1.preimage_mem_nhds_within (ext_chart_at_source_mem_nhds _ _))),
    unfold has_mfderiv_within_at at *,
    rw [â† has_fderiv_within_at_inter' this, â† ext_chart_preimage_inter_eq] at hf âŠ¢,
    have : written_in_ext_chart_at I I' x f ((ext_chart_at I x) x)
        = (ext_chart_at I' (f x)) (f x),
      by simp only with mfld_simps,
    rw â† this at hg,
    apply has_fderiv_within_at.comp ((ext_chart_at I x) x) hg.2 hf.2 _,
    assume y hy,
    simp only with mfld_simps at hy,
    have : f (((chart_at H x).symm : H â†’ M) (I.symm y)) âˆˆ u := hst hy.1.1,
    simp only [hy, this] with mfld_simps },
  apply A.congr_of_eventually_eq (written_in_ext_chart_comp hf.1),
  simp only with mfld_simps
end
theorem has_mfderiv_at.comp
  (hg : has_mfderiv_at I' I'' g (f x) g') (hf : has_mfderiv_at I I' f x f') :
  has_mfderiv_at I I'' (g âˆ˜ f) x (g'.comp f') :=
begin
  rw â† has_mfderiv_within_at_univ at *,
  exact has_mfderiv_within_at.comp x (hg.mono (subset_univ _)) hf subset_preimage_univ
end
theorem has_mfderiv_at.comp_has_mfderiv_within_at
  (hg : has_mfderiv_at I' I'' g (f x) g') (hf : has_mfderiv_within_at I I' f s x f') :
  has_mfderiv_within_at I I'' (g âˆ˜ f) s x (g'.comp f') :=
begin
  rw â† has_mfderiv_within_at_univ at *,
  exact has_mfderiv_within_at.comp x (hg.mono (subset_univ _)) hf subset_preimage_univ
end
lemma mdifferentiable_within_at.comp
  (hg : mdifferentiable_within_at I' I'' g u (f x)) (hf : mdifferentiable_within_at I I' f s x)
  (h : s âŠ† f â»Â¹' u) : mdifferentiable_within_at I I'' (g âˆ˜ f) s x :=
begin
  rcases hf.2 with âŸ¨f', hf'âŸ©,
  have F : has_mfderiv_within_at I I' f s x f' := âŸ¨hf.1, hf'âŸ©,
  rcases hg.2 with âŸ¨g', hg'âŸ©,
  have G : has_mfderiv_within_at I' I'' g u (f x) g' := âŸ¨hg.1, hg'âŸ©,
  exact (has_mfderiv_within_at.comp x G F h).mdifferentiable_within_at
end
lemma mdifferentiable_at.comp
  (hg : mdifferentiable_at I' I'' g (f x)) (hf : mdifferentiable_at I I' f x) :
  mdifferentiable_at I I'' (g âˆ˜ f) x :=
(hg.has_mfderiv_at.comp x hf.has_mfderiv_at).mdifferentiable_at
lemma mfderiv_within_comp
  (hg : mdifferentiable_within_at I' I'' g u (f x)) (hf : mdifferentiable_within_at I I' f s x)
  (h : s âŠ† f â»Â¹' u) (hxs : unique_mdiff_within_at I s x) :
  mfderiv_within I I'' (g âˆ˜ f) s x =
    (mfderiv_within I' I'' g u (f x)).comp (mfderiv_within I I' f s x) :=
begin
  apply has_mfderiv_within_at.mfderiv_within _ hxs,
  exact has_mfderiv_within_at.comp x hg.has_mfderiv_within_at hf.has_mfderiv_within_at h
end
lemma mfderiv_comp
  (hg : mdifferentiable_at I' I'' g (f x)) (hf : mdifferentiable_at I I' f x) :
  mfderiv I I'' (g âˆ˜ f) x = (mfderiv I' I'' g (f x)).comp (mfderiv I I' f x) :=
begin
  apply has_mfderiv_at.mfderiv,
  exact has_mfderiv_at.comp x hg.has_mfderiv_at hf.has_mfderiv_at
end
lemma mdifferentiable_on.comp
  (hg : mdifferentiable_on I' I'' g u) (hf : mdifferentiable_on I I' f s) (st : s âŠ† f â»Â¹' u) :
  mdifferentiable_on I I'' (g âˆ˜ f) s :=
Î»x hx, mdifferentiable_within_at.comp x (hg (f x) (st hx)) (hf x hx) st
lemma mdifferentiable.comp
  (hg : mdifferentiable I' I'' g) (hf : mdifferentiable I I' f) : mdifferentiable I I'' (g âˆ˜ f) :=
Î»x, mdifferentiable_at.comp x (hg (f x)) (hf x)
lemma tangent_map_within_comp_at (p : tangent_bundle I M)
  (hg : mdifferentiable_within_at I' I'' g u (f p.1)) (hf : mdifferentiable_within_at I I' f s p.1)
  (h : s âŠ† f â»Â¹' u)  (hps : unique_mdiff_within_at I s p.1) :
  tangent_map_within I I'' (g âˆ˜ f) s p =
  tangent_map_within I' I'' g u (tangent_map_within I I' f s p) :=
begin
  simp only [tangent_map_within] with mfld_simps,
  rw mfderiv_within_comp p.1 hg hf h hps,
  refl
end
lemma tangent_map_comp_at (p : tangent_bundle I M)
  (hg : mdifferentiable_at I' I'' g (f p.1)) (hf : mdifferentiable_at I I' f p.1) :
  tangent_map I I'' (g âˆ˜ f) p = tangent_map I' I'' g (tangent_map I I' f p) :=
begin
  simp only [tangent_map] with mfld_simps,
  rw mfderiv_comp p.1 hg hf,
  refl
end
lemma tangent_map_comp (hg : mdifferentiable I' I'' g) (hf : mdifferentiable I I' f) :
  tangent_map I I'' (g âˆ˜ f) = (tangent_map I' I'' g) âˆ˜ (tangent_map I I' f) :=
by { ext p : 1, exact tangent_map_comp_at _ (hg _) (hf _) }
end derivatives_properties
section mfderiv_fderiv
variables {ğ•œ : Type*} [nondiscrete_normed_field ğ•œ]
{E : Type*} [normed_group E] [normed_space ğ•œ E]
{E' : Type*} [normed_group E'] [normed_space ğ•œ E']
{f : E â†’ E'} {s : set E} {x : E}
lemma unique_mdiff_within_at_iff_unique_diff_within_at :
  unique_mdiff_within_at (ğ“˜(ğ•œ, E)) s x â†” unique_diff_within_at ğ•œ s x :=
by simp only [unique_mdiff_within_at] with mfld_simps
alias unique_mdiff_within_at_iff_unique_diff_within_at â†”
  unique_mdiff_within_at.unique_diff_within_at unique_diff_within_at.unique_mdiff_within_at
lemma unique_mdiff_on_iff_unique_diff_on :
  unique_mdiff_on (ğ“˜(ğ•œ, E)) s â†” unique_diff_on ğ•œ s :=
by simp [unique_mdiff_on, unique_diff_on, unique_mdiff_within_at_iff_unique_diff_within_at]
alias unique_mdiff_on_iff_unique_diff_on â†”
  unique_mdiff_on.unique_diff_on unique_diff_on.unique_mdiff_on
@[simp, mfld_simps] lemma written_in_ext_chart_model_space :
  written_in_ext_chart_at (ğ“˜(ğ•œ, E)) (ğ“˜(ğ•œ, E')) x f = f :=
rfl
lemma has_mfderiv_within_at_iff_has_fderiv_within_at {f'} :
  has_mfderiv_within_at ğ“˜(ğ•œ, E) ğ“˜(ğ•œ, E') f s x f' â†”
    has_fderiv_within_at f f' s x :=
by simpa only [has_mfderiv_within_at, and_iff_right_iff_imp] with mfld_simps
  using has_fderiv_within_at.continuous_within_at
alias has_mfderiv_within_at_iff_has_fderiv_within_at â†”
  has_mfderiv_within_at.has_fderiv_within_at has_fderiv_within_at.has_mfderiv_within_at
lemma has_mfderiv_at_iff_has_fderiv_at {f'} :
  has_mfderiv_at ğ“˜(ğ•œ, E) ğ“˜(ğ•œ, E') f x f' â†” has_fderiv_at f f' x :=
by rw [â† has_mfderiv_within_at_univ, has_mfderiv_within_at_iff_has_fderiv_within_at,
  has_fderiv_within_at_univ]
alias has_mfderiv_at_iff_has_fderiv_at â†” has_mfderiv_at.has_fderiv_at has_fderiv_at.has_mfderiv_at
theorem mdifferentiable_within_at_iff_differentiable_within_at :
  mdifferentiable_within_at (ğ“˜(ğ•œ, E)) (ğ“˜(ğ•œ, E')) f s x
  â†” differentiable_within_at ğ•œ f s x :=
begin
  simp only [mdifferentiable_within_at] with mfld_simps,
  exact âŸ¨Î»H, H.2, Î»H, âŸ¨H.continuous_within_at, HâŸ©âŸ©
end
alias mdifferentiable_within_at_iff_differentiable_within_at â†”
  mdifferentiable_within_at.differentiable_within_at
  differentiable_within_at.mdifferentiable_within_at
theorem mdifferentiable_at_iff_differentiable_at :
  mdifferentiable_at (ğ“˜(ğ•œ, E)) (ğ“˜(ğ•œ, E')) f x â†” differentiable_at ğ•œ f x :=
begin
  simp only [mdifferentiable_at, differentiable_within_at_univ] with mfld_simps,
  exact âŸ¨Î»H, H.2, Î»H, âŸ¨H.continuous_at, HâŸ©âŸ©
end
alias mdifferentiable_at_iff_differentiable_at â†”
  mdifferentiable_at.differentiable_at differentiable_at.mdifferentiable_at
theorem mdifferentiable_on_iff_differentiable_on :
  mdifferentiable_on (ğ“˜(ğ•œ, E)) (ğ“˜(ğ•œ, E')) f s â†” differentiable_on ğ•œ f s :=
by simp only [mdifferentiable_on, differentiable_on,
              mdifferentiable_within_at_iff_differentiable_within_at]
alias mdifferentiable_on_iff_differentiable_on â†”
  mdifferentiable_on.differentiable_on differentiable_on.mdifferentiable_on
theorem mdifferentiable_iff_differentiable :
  mdifferentiable (ğ“˜(ğ•œ, E)) (ğ“˜(ğ•œ, E')) f â†” differentiable ğ•œ f :=
by simp only [mdifferentiable, differentiable, mdifferentiable_at_iff_differentiable_at]
alias mdifferentiable_iff_differentiable â†”
  mdifferentiable.differentiable differentiable.mdifferentiable
@[simp] theorem mfderiv_within_eq_fderiv_within :
  mfderiv_within (ğ“˜(ğ•œ, E)) (ğ“˜(ğ•œ, E')) f s x = fderiv_within ğ•œ f s x :=
begin
  by_cases h : mdifferentiable_within_at (ğ“˜(ğ•œ, E)) (ğ“˜(ğ•œ, E')) f s x,
  { simp only [mfderiv_within, h, dif_pos] with mfld_simps },
  { simp only [mfderiv_within, h, dif_neg, not_false_iff],
    rw [mdifferentiable_within_at_iff_differentiable_within_at] at h,
    exact (fderiv_within_zero_of_not_differentiable_within_at h).symm }
end
@[simp] theorem mfderiv_eq_fderiv :
  mfderiv (ğ“˜(ğ•œ, E)) (ğ“˜(ğ•œ, E')) f x = fderiv ğ•œ f x :=
begin
  rw [â† mfderiv_within_univ, â† fderiv_within_univ],
  exact mfderiv_within_eq_fderiv_within
end
end mfderiv_fderiv
section specific_functions
variables {ğ•œ : Type*} [nondiscrete_normed_field ğ•œ]
{E : Type*} [normed_group E] [normed_space ğ•œ E]
{H : Type*} [topological_space H] (I : model_with_corners ğ•œ E H)
{M : Type*} [topological_space M] [charted_space H M] [smooth_manifold_with_corners I M]
{E' : Type*} [normed_group E'] [normed_space ğ•œ E']
{H' : Type*} [topological_space H'] (I' : model_with_corners ğ•œ E' H')
{M' : Type*} [topological_space M'] [charted_space H' M'] [smooth_manifold_with_corners I' M']
namespace continuous_linear_map
variables (f : E â†’L[ğ•œ] E') {s : set E} {x : E}
protected lemma has_mfderiv_within_at : has_mfderiv_within_at ğ“˜(ğ•œ, E) ğ“˜(ğ•œ, E') f s x f :=
f.has_fderiv_within_at.has_mfderiv_within_at
protected lemma has_mfderiv_at : has_mfderiv_at ğ“˜(ğ•œ, E) ğ“˜(ğ•œ, E') f x f :=
f.has_fderiv_at.has_mfderiv_at
protected lemma mdifferentiable_within_at : mdifferentiable_within_at ğ“˜(ğ•œ, E) ğ“˜(ğ•œ, E') f s x :=
f.differentiable_within_at.mdifferentiable_within_at
protected lemma mdifferentiable_on : mdifferentiable_on ğ“˜(ğ•œ, E) ğ“˜(ğ•œ, E') f s :=
f.differentiable_on.mdifferentiable_on
protected lemma mdifferentiable_at : mdifferentiable_at ğ“˜(ğ•œ, E) ğ“˜(ğ•œ, E') f x :=
f.differentiable_at.mdifferentiable_at
protected lemma mdifferentiable : mdifferentiable ğ“˜(ğ•œ, E) ğ“˜(ğ•œ, E') f :=
f.differentiable.mdifferentiable
lemma mfderiv_eq : mfderiv ğ“˜(ğ•œ, E) ğ“˜(ğ•œ, E') f x = f :=
f.has_mfderiv_at.mfderiv
lemma mfderiv_within_eq (hs : unique_mdiff_within_at ğ“˜(ğ•œ, E) s x)  :
  mfderiv_within ğ“˜(ğ•œ, E) ğ“˜(ğ•œ, E') f s x = f :=
f.has_mfderiv_within_at.mfderiv_within hs
end continuous_linear_map
namespace continuous_linear_equiv
variables (f : E â‰ƒL[ğ•œ] E') {s : set E} {x : E}
protected lemma has_mfderiv_within_at :
  has_mfderiv_within_at ğ“˜(ğ•œ, E) ğ“˜(ğ•œ, E') f s x (f : E â†’L[ğ•œ] E') :=
f.has_fderiv_within_at.has_mfderiv_within_at
protected lemma has_mfderiv_at : has_mfderiv_at ğ“˜(ğ•œ, E) ğ“˜(ğ•œ, E') f x (f : E â†’L[ğ•œ] E') :=
f.has_fderiv_at.has_mfderiv_at
protected lemma mdifferentiable_within_at : mdifferentiable_within_at ğ“˜(ğ•œ, E) ğ“˜(ğ•œ, E') f s x :=
f.differentiable_within_at.mdifferentiable_within_at
protected lemma mdifferentiable_on : mdifferentiable_on ğ“˜(ğ•œ, E) ğ“˜(ğ•œ, E') f s :=
f.differentiable_on.mdifferentiable_on
protected lemma mdifferentiable_at : mdifferentiable_at ğ“˜(ğ•œ, E) ğ“˜(ğ•œ, E') f x :=
f.differentiable_at.mdifferentiable_at
protected lemma mdifferentiable : mdifferentiable ğ“˜(ğ•œ, E) ğ“˜(ğ•œ, E') f :=
f.differentiable.mdifferentiable
lemma mfderiv_eq : mfderiv ğ“˜(ğ•œ, E) ğ“˜(ğ•œ, E') f x = (f : E â†’L[ğ•œ] E') :=
f.has_mfderiv_at.mfderiv
lemma mfderiv_within_eq (hs : unique_mdiff_within_at ğ“˜(ğ•œ, E) s x)  :
  mfderiv_within ğ“˜(ğ•œ, E) ğ“˜(ğ•œ, E') f s x = (f : E â†’L[ğ•œ] E') :=
f.has_mfderiv_within_at.mfderiv_within hs
end continuous_linear_equiv
variables {s : set M} {x : M}
section id
lemma has_mfderiv_at_id (x : M) :
  has_mfderiv_at I I (@_root_.id M) x (continuous_linear_map.id ğ•œ (tangent_space I x)) :=
begin
  refine âŸ¨continuous_id.continuous_at, _âŸ©,
  have : âˆ€á¶  y in ğ“[range I] ((ext_chart_at I x) x),
    ((ext_chart_at I x) âˆ˜ (ext_chart_at I x).symm) y = id y,
  { apply filter.mem_of_superset (ext_chart_at_target_mem_nhds_within I x),
    mfld_set_tac },
  apply has_fderiv_within_at.congr_of_eventually_eq (has_fderiv_within_at_id _ _) this,
  simp only with mfld_simps
end
theorem has_mfderiv_within_at_id (s : set M) (x : M) :
  has_mfderiv_within_at I I (@_root_.id M) s x (continuous_linear_map.id ğ•œ (tangent_space I x)) :=
(has_mfderiv_at_id I x).has_mfderiv_within_at
lemma mdifferentiable_at_id : mdifferentiable_at I I (@_root_.id M) x :=
(has_mfderiv_at_id I x).mdifferentiable_at
lemma mdifferentiable_within_at_id : mdifferentiable_within_at I I (@_root_.id M) s x :=
(mdifferentiable_at_id I).mdifferentiable_within_at
lemma mdifferentiable_id : mdifferentiable I I (@_root_.id M) :=
Î»x, mdifferentiable_at_id I
lemma mdifferentiable_on_id : mdifferentiable_on I I (@_root_.id M) s :=
(mdifferentiable_id I).mdifferentiable_on
@[simp, mfld_simps] lemma mfderiv_id :
  mfderiv I I (@_root_.id M) x = (continuous_linear_map.id ğ•œ (tangent_space I x)) :=
has_mfderiv_at.mfderiv (has_mfderiv_at_id I x)
lemma mfderiv_within_id (hxs : unique_mdiff_within_at I s x) :
  mfderiv_within I I (@_root_.id M) s x = (continuous_linear_map.id ğ•œ (tangent_space I x)) :=
begin
  rw mdifferentiable.mfderiv_within (mdifferentiable_at_id I) hxs,
  exact mfderiv_id I
end
@[simp, mfld_simps] lemma tangent_map_id : tangent_map I I (id : M â†’ M) = id :=
by { ext1 âŸ¨x, vâŸ©, simp [tangent_map] }
lemma tangent_map_within_id {p : tangent_bundle I M}
  (hs : unique_mdiff_within_at I s (tangent_bundle.proj I M p)) :
  tangent_map_within I I (id : M â†’ M) s p = p :=
begin
  simp only [tangent_map_within, id.def],
  rw mfderiv_within_id,
  { rcases p, refl },
  { exact hs }
end
end id
section const
variables {c : M'}
lemma has_mfderiv_at_const (c : M') (x : M) :
  has_mfderiv_at I I' (Î»y : M, c) x
  (0 : tangent_space I x â†’L[ğ•œ] tangent_space I' c) :=
begin
  refine âŸ¨continuous_const.continuous_at, _âŸ©,
  simp only [written_in_ext_chart_at, (âˆ˜), has_fderiv_within_at_const]
end
theorem has_mfderiv_within_at_const (c : M') (s : set M) (x : M) :
  has_mfderiv_within_at I I' (Î»y : M, c) s x
  (0 : tangent_space I x â†’L[ğ•œ] tangent_space I' c) :=
(has_mfderiv_at_const I I' c x).has_mfderiv_within_at
lemma mdifferentiable_at_const : mdifferentiable_at I I' (Î»y : M, c) x :=
(has_mfderiv_at_const I I' c x).mdifferentiable_at
lemma mdifferentiable_within_at_const : mdifferentiable_within_at I I' (Î»y : M, c) s x :=
(mdifferentiable_at_const I I').mdifferentiable_within_at
lemma mdifferentiable_const : mdifferentiable I I' (Î»y : M, c) :=
Î»x, mdifferentiable_at_const I I'
lemma mdifferentiable_on_const : mdifferentiable_on I I' (Î»y : M, c) s :=
(mdifferentiable_const I I').mdifferentiable_on
@[simp, mfld_simps] lemma mfderiv_const : mfderiv I I' (Î»y : M, c) x =
  (0 : tangent_space I x â†’L[ğ•œ] tangent_space I' c) :=
has_mfderiv_at.mfderiv (has_mfderiv_at_const I I' c x)
lemma mfderiv_within_const (hxs : unique_mdiff_within_at I s x) :
  mfderiv_within I I' (Î»y : M, c) s x =
  (0 : tangent_space I x â†’L[ğ•œ] tangent_space I' c) :=
(has_mfderiv_within_at_const _ _ _ _ _).mfderiv_within hxs
end const
namespace model_with_corners
protected lemma has_mfderiv_at {x} :
  has_mfderiv_at I ğ“˜(ğ•œ, E) I x (continuous_linear_map.id _ _) :=
âŸ¨I.continuous_at, (has_fderiv_within_at_id _ _).congr' I.right_inv_on (mem_range_self _)âŸ©
protected lemma has_mfderiv_within_at {s x} :
  has_mfderiv_within_at I ğ“˜(ğ•œ, E) I s x (continuous_linear_map.id _ _) :=
I.has_mfderiv_at.has_mfderiv_within_at
protected lemma mdifferentiable_within_at {s x} :
  mdifferentiable_within_at I ğ“˜(ğ•œ, E) I s x :=
I.has_mfderiv_within_at.mdifferentiable_within_at
protected lemma mdifferentiable_at {x} :
  mdifferentiable_at I ğ“˜(ğ•œ, E) I x :=
I.has_mfderiv_at.mdifferentiable_at
protected lemma mdifferentiable_on {s} :
  mdifferentiable_on I ğ“˜(ğ•œ, E) I s :=
Î» x hx, I.mdifferentiable_within_at
protected lemma mdifferentiable :
  mdifferentiable I (ğ“˜(ğ•œ, E)) I :=
Î» x, I.mdifferentiable_at
lemma has_mfderiv_within_at_symm {x} (hx : x âˆˆ range I) :
  has_mfderiv_within_at ğ“˜(ğ•œ, E) I I.symm (range I) x (continuous_linear_map.id _ _) :=
âŸ¨I.continuous_within_at_symm, (has_fderiv_within_at_id _ _).congr'
  (Î» y hy, I.right_inv_on hy.1) âŸ¨hx, mem_range_self _âŸ©âŸ©
lemma mdifferentiable_on_symm :
  mdifferentiable_on (ğ“˜(ğ•œ, E)) I I.symm (range I) :=
Î» x hx, (I.has_mfderiv_within_at_symm hx).mdifferentiable_within_at
end model_with_corners
section charts
variable {e : local_homeomorph M H}
lemma mdifferentiable_at_atlas (h : e âˆˆ atlas H M) {x : M} (hx : x âˆˆ e.source) :
  mdifferentiable_at I I e x :=
begin
  refine âŸ¨(e.continuous_on x hx).continuous_at (is_open.mem_nhds e.open_source hx), _âŸ©,
  have mem : I ((chart_at H x : M â†’ H) x) âˆˆ
    I.symm â»Â¹' ((chart_at H x).symm â‰«â‚• e).source âˆ© range I,
    by simp only [hx] with mfld_simps,
  have : (chart_at H x).symm.trans e âˆˆ cont_diff_groupoid âˆ I :=
    has_groupoid.compatible _ (chart_mem_atlas H x) h,
  have A : cont_diff_on ğ•œ âˆ
    (I âˆ˜ ((chart_at H x).symm.trans e) âˆ˜ I.symm)
    (I.symm â»Â¹' ((chart_at H x).symm.trans e).source âˆ© range I) :=
    this.1,
  have B := A.differentiable_on le_top (I ((chart_at H x : M â†’ H) x)) mem,
  simp only with mfld_simps at B,
  rw [inter_comm, differentiable_within_at_inter] at B,
  { simpa only with mfld_simps },
  { apply is_open.mem_nhds ((local_homeomorph.open_source _).preimage I.continuous_symm) mem.1 }
end
lemma mdifferentiable_on_atlas (h : e âˆˆ atlas H M) :
  mdifferentiable_on I I e e.source :=
Î»x hx, (mdifferentiable_at_atlas I h hx).mdifferentiable_within_at
lemma mdifferentiable_at_atlas_symm (h : e âˆˆ atlas H M) {x : H} (hx : x âˆˆ e.target) :
  mdifferentiable_at I I e.symm x :=
begin
  refine âŸ¨(e.continuous_on_symm x hx).continuous_at (is_open.mem_nhds e.open_target hx), _âŸ©,
  have mem : I x âˆˆ I.symm â»Â¹' (e.symm â‰«â‚• chart_at H (e.symm x)).source âˆ© range (I),
    by simp only [hx] with mfld_simps,
  have : e.symm.trans (chart_at H (e.symm x)) âˆˆ cont_diff_groupoid âˆ I :=
    has_groupoid.compatible _ h (chart_mem_atlas H _),
  have A : cont_diff_on ğ•œ âˆ
    (I âˆ˜ (e.symm.trans (chart_at H (e.symm x))) âˆ˜ I.symm)
    (I.symm â»Â¹' (e.symm.trans (chart_at H (e.symm x))).source âˆ© range I) :=
    this.1,
  have B := A.differentiable_on le_top (I x) mem,
  simp only with mfld_simps at B,
  rw [inter_comm, differentiable_within_at_inter] at B,
  { simpa only with mfld_simps },
  { apply (is_open.mem_nhds ((local_homeomorph.open_source _).preimage I.continuous_symm) mem.1) }
end
lemma mdifferentiable_on_atlas_symm (h : e âˆˆ atlas H M) :
  mdifferentiable_on I I e.symm e.target :=
Î»x hx, (mdifferentiable_at_atlas_symm I h hx).mdifferentiable_within_at
lemma mdifferentiable_of_mem_atlas (h : e âˆˆ atlas H M) : e.mdifferentiable I I :=
âŸ¨mdifferentiable_on_atlas I h, mdifferentiable_on_atlas_symm I hâŸ©
lemma mdifferentiable_chart (x : M) : (chart_at H x).mdifferentiable I I :=
mdifferentiable_of_mem_atlas _ (chart_mem_atlas _ _)
lemma tangent_map_chart {p q : tangent_bundle I M} (h : q.1 âˆˆ (chart_at H p.1).source) :
  tangent_map I I (chart_at H p.1) q =
  (equiv.sigma_equiv_prod _ _).symm
    ((chart_at (model_prod H E) p : tangent_bundle I M â†’ model_prod H E) q) :=
begin
  dsimp [tangent_map],
  rw mdifferentiable_at.mfderiv,
  { refl },
  { exact mdifferentiable_at_atlas _ (chart_mem_atlas _ _) h }
end
lemma tangent_map_chart_symm {p : tangent_bundle I M} {q : tangent_bundle I H}
  (h : q.1 âˆˆ (chart_at H p.1).target) :
  tangent_map I I (chart_at H p.1).symm q =
  ((chart_at (model_prod H E) p).symm : model_prod H E â†’ tangent_bundle I M)
    ((equiv.sigma_equiv_prod H E) q) :=
begin
  dsimp only [tangent_map],
  rw mdifferentiable_at.mfderiv (mdifferentiable_at_atlas_symm _ (chart_mem_atlas _ _) h),
namespace local_homeomorph.mdifferentiable
variables {ğ•œ : Type*} [nondiscrete_normed_field ğ•œ]
{E : Type*} [normed_group E] [normed_space ğ•œ E]
{H : Type*} [topological_space H] {I : model_with_corners ğ•œ E H}
{M : Type*} [topological_space M] [charted_space H M]
{E' : Type*} [normed_group E'] [normed_space ğ•œ E']
{H' : Type*} [topological_space H'] {I' : model_with_corners ğ•œ E' H'}
{M' : Type*} [topological_space M'] [charted_space H' M']
{E'' : Type*} [normed_group E''] [normed_space ğ•œ E'']
{H'' : Type*} [topological_space H''] {I'' : model_with_corners ğ•œ E'' H''}
{M'' : Type*} [topological_space M''] [charted_space H'' M'']
{e : local_homeomorph M M'} (he : e.mdifferentiable I I')
{e' : local_homeomorph M' M''}
include he
lemma symm : e.symm.mdifferentiable I' I :=
âŸ¨he.2, he.1âŸ©
protected lemma mdifferentiable_at {x : M} (hx : x âˆˆ e.source) :
  mdifferentiable_at I I' e x :=
(he.1 x hx).mdifferentiable_at (is_open.mem_nhds e.open_source hx)
lemma mdifferentiable_at_symm {x : M'} (hx : x âˆˆ e.target) :
  mdifferentiable_at I' I e.symm x :=
(he.2 x hx).mdifferentiable_at (is_open.mem_nhds e.open_target hx)
variables [smooth_manifold_with_corners I M] [smooth_manifold_with_corners I' M']
[smooth_manifold_with_corners I'' M'']
lemma symm_comp_deriv {x : M} (hx : x âˆˆ e.source) :
  (mfderiv I' I e.symm (e x)).comp (mfderiv I I' e x) =
    continuous_linear_map.id ğ•œ (tangent_space I x) :=
begin
  have : (mfderiv I I (e.symm âˆ˜ e) x) =
         (mfderiv I' I e.symm (e x)).comp (mfderiv I I' e x) :=
    mfderiv_comp x (he.mdifferentiable_at_symm (e.map_source hx)) (he.mdifferentiable_at hx),
  rw â† this,
  have : mfderiv I I (_root_.id : M â†’ M) x = continuous_linear_map.id _ _ := mfderiv_id I,
  rw â† this,
  apply filter.eventually_eq.mfderiv_eq,
  have : e.source âˆˆ ğ“ x := is_open.mem_nhds e.open_source hx,
  exact filter.mem_of_superset this (by mfld_set_tac)
end
lemma comp_symm_deriv {x : M'} (hx : x âˆˆ e.target) :
  (mfderiv I I' e (e.symm x)).comp (mfderiv I' I e.symm x) =
    continuous_linear_map.id ğ•œ (tangent_space I' x) :=
he.symm.symm_comp_deriv hx
protected def mfderiv {x : M} (hx : x âˆˆ e.source) :
  tangent_space I x â‰ƒL[ğ•œ] tangent_space I' (e x) :=
{ inv_fun := (mfderiv I' I e.symm (e x)),
  continuous_to_fun := (mfderiv I I' e x).cont,
  continuous_inv_fun := (mfderiv I' I e.symm (e x)).cont,
  left_inv := Î»y, begin
    have : (continuous_linear_map.id _ _ : tangent_space I x â†’L[ğ•œ] tangent_space I x) y = y := rfl,
    conv_rhs { rw [â† this, â† he.symm_comp_deriv hx] },
    refl
  end,
  right_inv := Î»y, begin
    have : (continuous_linear_map.id ğ•œ _ :
      tangent_space I' (e x) â†’L[ğ•œ] tangent_space I' (e x)) y = y := rfl,
    conv_rhs { rw [â† this, â† he.comp_symm_deriv (e.map_source hx)] },
    rw e.left_inv hx,
    refl
  end,
  .. mfderiv I I' e x }
lemma mfderiv_bijective {x : M} (hx : x âˆˆ e.source) :
  function.bijective (mfderiv I I' e x) :=
(he.mfderiv hx).bijective
lemma mfderiv_injective {x : M} (hx : x âˆˆ e.source) :
  function.injective (mfderiv I I' e x) :=
(he.mfderiv hx).injective
lemma mfderiv_surjective {x : M} (hx : x âˆˆ e.source) :
  function.surjective (mfderiv I I' e x) :=
(he.mfderiv hx).surjective
lemma ker_mfderiv_eq_bot {x : M} (hx : x âˆˆ e.source) :
  (mfderiv I I' e x).ker = âŠ¥ :=
(he.mfderiv hx).to_linear_equiv.ker
lemma range_mfderiv_eq_top {x : M} (hx : x âˆˆ e.source) :
  (mfderiv I I' e x).range = âŠ¤ :=
(he.mfderiv hx).to_linear_equiv.range
lemma range_mfderiv_eq_univ {x : M} (hx : x âˆˆ e.source) :
  range (mfderiv I I' e x) = univ :=
(he.mfderiv_surjective hx).range_eq
lemma trans (he': e'.mdifferentiable I' I'') : (e.trans e').mdifferentiable I I'' :=
begin
  split,
  { assume x hx,
    simp only with mfld_simps at hx,
    exact ((he'.mdifferentiable_at hx.2).comp _
           (he.mdifferentiable_at hx.1)).mdifferentiable_within_at },
  { assume x hx,
    simp only with mfld_simps at hx,
    exact ((he.symm.mdifferentiable_at hx.2).comp _
           (he'.symm.mdifferentiable_at hx.1)).mdifferentiable_within_at }
end
end local_homeomorph.mdifferentiable
section ext_chart_at
variables {ğ•œ : Type*} [nondiscrete_normed_field ğ•œ]
{E : Type*} [normed_group E] [normed_space ğ•œ E]
{H : Type*} [topological_space H] (I : model_with_corners ğ•œ E H)
{M : Type*} [topological_space M] [charted_space H M] [smooth_manifold_with_corners I M]
{s : set M} {x y : M}
lemma has_mfderiv_at_ext_chart_at (h : y âˆˆ (chart_at H x).source) :
  has_mfderiv_at I ğ“˜(ğ•œ, E) (ext_chart_at I x) y (mfderiv I I (chart_at H x) y : _) :=
I.has_mfderiv_at.comp y ((mdifferentiable_chart I x).mdifferentiable_at h).has_mfderiv_at
lemma has_mfderiv_within_at_ext_chart_at (h : y âˆˆ (chart_at H x).source) :
  has_mfderiv_within_at I ğ“˜(ğ•œ, E) (ext_chart_at I x) s y (mfderiv I I (chart_at H x) y : _) :=
(has_mfderiv_at_ext_chart_at I h).has_mfderiv_within_at
lemma mdifferentiable_at_ext_chart_at (h : y âˆˆ (chart_at H x).source) :
  mdifferentiable_at I ğ“˜(ğ•œ, E) (ext_chart_at I x) y :=
(has_mfderiv_at_ext_chart_at I h).mdifferentiable_at
lemma mdifferentiable_on_ext_chart_at :
  mdifferentiable_on I ğ“˜(ğ•œ, E) (ext_chart_at I x) (chart_at H x).source :=
Î» y hy, (has_mfderiv_within_at_ext_chart_at I hy).mdifferentiable_within_at
end ext_chart_at
section unique_mdiff
variables {ğ•œ : Type*} [nondiscrete_normed_field ğ•œ]
{E : Type*} [normed_group E] [normed_space ğ•œ E]
{H : Type*} [topological_space H] {I : model_with_corners ğ•œ E H}
{M : Type*} [topological_space M] [charted_space H M] [smooth_manifold_with_corners I M]
{E' : Type*} [normed_group E'] [normed_space ğ•œ E']
{H' : Type*} [topological_space H'] {I' : model_with_corners ğ•œ E' H'}
{M' : Type*} [topological_space M'] [charted_space H' M']
{s : set M}
lemma unique_mdiff_on.unique_mdiff_on_preimage [smooth_manifold_with_corners I' M']
  (hs : unique_mdiff_on I s) {e : local_homeomorph M M'} (he : e.mdifferentiable I I') :
  unique_mdiff_on I' (e.target âˆ© e.symm â»Â¹' s) :=
begin
  assume x hx,
  let z := e.symm x,
  have z_source : z âˆˆ e.source, by simp only [hx.1] with mfld_simps,
  have zx : e z = x, by simp only [z, hx.1] with mfld_simps,
  let F := ext_chart_at I z,
lemma unique_mdiff_on.unique_diff_on_target_inter (hs : unique_mdiff_on I s) (x : M) :
  unique_diff_on ğ•œ ((ext_chart_at I x).target âˆ© ((ext_chart_at I x).symm â»Â¹' s)) :=
begin
lemma unique_mdiff_on.unique_diff_on_inter_preimage (hs : unique_mdiff_on I s) (x : M) (y : M')
  {f : M â†’ M'} (hf : continuous_on f s) :
  unique_diff_on ğ•œ ((ext_chart_at I x).target
    âˆ© ((ext_chart_at I x).symm â»Â¹' (s âˆ© fâ»Â¹' (ext_chart_at I' y).source))) :=
begin
  have : unique_mdiff_on I (s âˆ© f â»Â¹' (ext_chart_at I' y).source),
  { assume z hz,
    apply (hs z hz.1).inter',
    apply (hf z hz.1).preimage_mem_nhds_within,
    exact is_open.mem_nhds (ext_chart_at_open_source I' y) hz.2 },
  exact this.unique_diff_on_target_inter _
end
variables {F : Type*} [normed_group F] [normed_space ğ•œ F]
(Z : basic_smooth_vector_bundle_core I M F)
lemma unique_mdiff_on.smooth_bundle_preimage (hs : unique_mdiff_on I s) :
  unique_mdiff_on (I.prod (ğ“˜(ğ•œ, F))) (Z.to_topological_vector_bundle_core.proj â»Â¹' s) :=
begin
  assume p hp,
  replace hp : p.fst âˆˆ s, by simpa only with mfld_simps using hp,
  let eâ‚€ := chart_at H p.1,
  let e := chart_at (model_prod H F) p,
