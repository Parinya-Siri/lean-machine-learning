import measure_theory.covering.besicovitch_vector_space
import measure_theory.measure.haar_lebesgue
import analysis.normed_space.pointwise
import measure_theory.covering.differentiation
import measure_theory.constructions.polish
open measure_theory measure_theory.measure metric filter set finite_dimensional asymptotics
topological_space
open_locale nnreal ennreal topological_space pointwise
variables {E F : Type*} [normed_group E] [normed_space â„ E] [finite_dimensional â„ E]
[normed_group F] [normed_space â„ F] {s : set E} {f : E â†’ E} {f' : E â†’ E â†’L[â„] E}
lemma exists_closed_cover_approximates_linear_on_of_has_fderiv_within_at
  [second_countable_topology F]
  (f : E â†’ F) (s : set E) (f' : E â†’ E â†’L[â„] F) (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x)
  (r : (E â†’L[â„] F) â†’ â„â‰¥0) (rpos : âˆ€ A, r A â‰  0) :
  âˆƒ (t : â„• â†’ set E) (A : â„• â†’ (E â†’L[â„] F)), (âˆ€ n, is_closed (t n)) âˆ§ (s âŠ† â‹ƒ n, t n)
    âˆ§ (âˆ€ n, approximates_linear_on f (A n) (s âˆ© t n) (r (A n)))
    âˆ§ (s.nonempty â†’ âˆ€ n, âˆƒ y âˆˆ s, A n = f' y) :=
begin
lemma exists_partition_approximates_linear_on_of_has_fderiv_within_at
  [second_countable_topology F]
  (f : E â†’ F) (s : set E) (f' : E â†’ E â†’L[â„] F) (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x)
  (r : (E â†’L[â„] F) â†’ â„â‰¥0) (rpos : âˆ€ A, r A â‰  0) :
  âˆƒ (t : â„• â†’ set E) (A : â„• â†’ (E â†’L[â„] F)), pairwise (disjoint on t)
    âˆ§ (âˆ€ n, measurable_set (t n)) âˆ§ (s âŠ† â‹ƒ n, t n)
    âˆ§ (âˆ€ n, approximates_linear_on f (A n) (s âˆ© t n) (r (A n)))
    âˆ§ (s.nonempty â†’ âˆ€ n, âˆƒ y âˆˆ s, A n = f' y) :=
begin
  rcases exists_closed_cover_approximates_linear_on_of_has_fderiv_within_at f s f' hf' r rpos
    with âŸ¨t, A, t_closed, st, t_approx, htâŸ©,
  refine âŸ¨disjointed t, A, disjoint_disjointed _,
          measurable_set.disjointed (Î» n, (t_closed n).measurable_set), _, _, htâŸ©,
  { rw Union_disjointed, exact st },
  { assume n, exact (t_approx n).mono_set (inter_subset_inter_right _ (disjointed_subset _ _)) },
end
namespace measure_theory
lemma add_haar_image_le_mul_of_det_lt
  (A : E â†’L[â„] E) {m : â„â‰¥0} (hm : ennreal.of_real (|A.det|) < m) :
  âˆ€á¶  Î´ in ğ“[>] (0 : â„â‰¥0), âˆ€ (s : set E) (f : E â†’ E) (hf : approximates_linear_on f A s Î´),
  Î¼ (f '' s) â‰¤ m * Î¼ s :=
begin
  apply nhds_within_le_nhds,
  let d := ennreal.of_real (|A.det|),
lemma mul_le_add_haar_image_of_lt_det
  (A : E â†’L[â„] E) {m : â„â‰¥0} (hm : (m : â„â‰¥0âˆ) < ennreal.of_real (|A.det|)) :
  âˆ€á¶  Î´ in ğ“[>] (0 : â„â‰¥0), âˆ€ (s : set E) (f : E â†’ E) (hf : approximates_linear_on f A s Î´),
  (m : â„â‰¥0âˆ) * Î¼ s â‰¤ Î¼ (f '' s) :=
begin
  apply nhds_within_le_nhds,
lemma _root_.approximates_linear_on.norm_fderiv_sub_le
  {A : E â†’L[â„] E} {Î´ : â„â‰¥0}
  (hf : approximates_linear_on f A s Î´) (hs : measurable_set s)
  (f' : E â†’ E â†’L[â„] E) (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x) :
  âˆ€áµ x âˆ‚(Î¼.restrict s), âˆ¥f' x - Aâˆ¥â‚Š â‰¤ Î´ :=
begin
  filter_upwards [besicovitch.ae_tendsto_measure_inter_div Î¼ s, ae_restrict_mem hs],
lemma add_haar_image_eq_zero_of_differentiable_on_of_add_haar_eq_zero
  (hf : differentiable_on â„ f s) (hs : Î¼ s = 0) :
  Î¼ (f '' s) = 0 :=
begin
  refine le_antisymm _ (zero_le _),
  have : âˆ€ (A : E â†’L[â„] E), âˆƒ (Î´ : â„â‰¥0), 0 < Î´ âˆ§ âˆ€ (t : set E)
    (hf : approximates_linear_on f A t Î´), Î¼ (f '' t) â‰¤ (real.to_nnreal (|A.det|) + 1 : â„â‰¥0) * Î¼ t,
  { assume A,
    let m : â„â‰¥0 := real.to_nnreal ((|A.det|)) + 1,
    have I : ennreal.of_real (|A.det|) < m,
      by simp only [ennreal.of_real, m, lt_add_iff_pos_right, zero_lt_one, ennreal.coe_lt_coe],
    rcases ((add_haar_image_le_mul_of_det_lt Î¼ A I).and self_mem_nhds_within).exists
      with âŸ¨Î´, h, h'âŸ©,
    exact âŸ¨Î´, h', Î» t ht, h t f htâŸ© },
  choose Î´ hÎ´ using this,
  obtain âŸ¨t, A, t_disj, t_meas, t_cover, ht, -âŸ© : âˆƒ (t : â„• â†’ set E) (A : â„• â†’ (E â†’L[â„] E)),
    pairwise (disjoint on t) âˆ§ (âˆ€ (n : â„•), measurable_set (t n)) âˆ§ (s âŠ† â‹ƒ (n : â„•), t n)
    âˆ§ (âˆ€ (n : â„•), approximates_linear_on f (A n) (s âˆ© t n) (Î´ (A n)))
    âˆ§ (s.nonempty â†’ âˆ€ n, âˆƒ y âˆˆ s, A n = fderiv_within â„ f s y) :=
        exists_partition_approximates_linear_on_of_has_fderiv_within_at f s
        (fderiv_within â„ f s) (Î» x xs, (hf x xs).has_fderiv_within_at) Î´ (Î» A, (hÎ´ A).1.ne'),
  calc Î¼ (f '' s)
      â‰¤ Î¼ (â‹ƒ n, f '' (s âˆ© t n)) :
    begin
      apply measure_mono,
      rw [â† image_Union, â† inter_Union],
      exact image_subset f (subset_inter subset.rfl t_cover)
    end
  ... â‰¤ âˆ‘' n, Î¼ (f '' (s âˆ© t n)) : measure_Union_le _
  ... â‰¤ âˆ‘' n, (real.to_nnreal (|(A n).det|) + 1 : â„â‰¥0) * Î¼ (s âˆ© t n) :
    begin
      apply ennreal.tsum_le_tsum (Î» n, _),
      apply (hÎ´ (A n)).2,
      exact ht n,
    end
  ... â‰¤ âˆ‘' n, (real.to_nnreal (|(A n).det|) + 1 : â„â‰¥0) * 0 :
    begin
      refine ennreal.tsum_le_tsum (Î» n, ennreal.mul_le_mul le_rfl _),
      exact le_trans (measure_mono (inter_subset_left _ _)) (le_of_eq hs),
    end
  ... = 0 : by simp only [tsum_zero, mul_zero]
end
lemma add_haar_image_eq_zero_of_det_fderiv_within_eq_zero_aux
  (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x)
  (R : â„) (hs : s âŠ† closed_ball 0 R) (Îµ : â„â‰¥0) (Îµpos : 0 < Îµ)
  (h'f' : âˆ€ x âˆˆ s, (f' x).det = 0) :
  Î¼ (f '' s) â‰¤ Îµ * Î¼ (closed_ball 0 R) :=
begin
  rcases eq_empty_or_nonempty s with rfl|h's, { simp only [measure_empty, zero_le, image_empty] },
  have : âˆ€ (A : E â†’L[â„] E), âˆƒ (Î´ : â„â‰¥0), 0 < Î´ âˆ§ âˆ€ (t : set E)
    (hf : approximates_linear_on f A t Î´), Î¼ (f '' t) â‰¤ (real.to_nnreal (|A.det|) + Îµ : â„â‰¥0) * Î¼ t,
  { assume A,
    let m : â„â‰¥0 := real.to_nnreal (|A.det|) + Îµ,
    have I : ennreal.of_real (|A.det|) < m,
      by simp only [ennreal.of_real, m, lt_add_iff_pos_right, Îµpos, ennreal.coe_lt_coe],
    rcases ((add_haar_image_le_mul_of_det_lt Î¼ A I).and self_mem_nhds_within).exists
      with âŸ¨Î´, h, h'âŸ©,
    exact âŸ¨Î´, h', Î» t ht, h t f htâŸ© },
  choose Î´ hÎ´ using this,
  obtain âŸ¨t, A, t_disj, t_meas, t_cover, ht, Af'âŸ© : âˆƒ (t : â„• â†’ set E) (A : â„• â†’ (E â†’L[â„] E)),
    pairwise (disjoint on t) âˆ§ (âˆ€ (n : â„•), measurable_set (t n)) âˆ§ (s âŠ† â‹ƒ (n : â„•), t n)
    âˆ§ (âˆ€ (n : â„•), approximates_linear_on f (A n) (s âˆ© t n) (Î´ (A n)))
    âˆ§  (s.nonempty â†’ âˆ€ n, âˆƒ y âˆˆ s, A n = f' y) :=
      exists_partition_approximates_linear_on_of_has_fderiv_within_at f s
      f' hf' Î´ (Î» A, (hÎ´ A).1.ne'),
  calc Î¼ (f '' s)
      â‰¤ Î¼ (â‹ƒ n, f '' (s âˆ© t n)) :
    begin
      apply measure_mono,
      rw [â† image_Union, â† inter_Union],
      exact image_subset f (subset_inter subset.rfl t_cover)
    end
  ... â‰¤ âˆ‘' n, Î¼ (f '' (s âˆ© t n)) : measure_Union_le _
  ... â‰¤ âˆ‘' n, (real.to_nnreal (|(A n).det|) + Îµ : â„â‰¥0) * Î¼ (s âˆ© t n) :
    begin
      apply ennreal.tsum_le_tsum (Î» n, _),
      apply (hÎ´ (A n)).2,
      exact ht n,
    end
  ... = âˆ‘' n, Îµ * Î¼ (s âˆ© t n) :
    begin
      congr' with n,
      rcases Af' h's n with âŸ¨y, ys, hyâŸ©,
      simp only [hy, h'f' y ys, real.to_nnreal_zero, abs_zero, zero_add]
    end
  ... â‰¤ Îµ * âˆ‘' n, Î¼ (closed_ball 0 R âˆ© t n) :
    begin
      rw ennreal.tsum_mul_left,
      refine ennreal.mul_le_mul le_rfl (ennreal.tsum_le_tsum (Î» n, measure_mono _)),
      exact inter_subset_inter_left _ hs,
    end
  ... = Îµ * Î¼ (â‹ƒ n, closed_ball 0 R âˆ© t n) :
    begin
      rw measure_Union,
      { exact pairwise_disjoint.mono t_disj (Î» n, inter_subset_right _ _) },
      { assume n,
        exact measurable_set_closed_ball.inter (t_meas n) }
    end
  ... â‰¤ Îµ * Î¼ (closed_ball 0 R) :
    begin
      rw â† inter_Union,
      exact ennreal.mul_le_mul le_rfl (measure_mono (inter_subset_left _ _)),
    end
end
lemma add_haar_image_eq_zero_of_det_fderiv_within_eq_zero
  (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x)
  (h'f' : âˆ€ x âˆˆ s, (f' x).det = 0) :
  Î¼ (f '' s) = 0 :=
begin
  suffices H : âˆ€ R, Î¼ (f '' (s âˆ© closed_ball 0 R)) = 0,
  { apply le_antisymm _ (zero_le _),
    rw â† Union_inter_closed_ball_nat s 0,
    calc Î¼ (f '' â‹ƒ (n : â„•), s âˆ© closed_ball 0 n) â‰¤ âˆ‘' (n : â„•), Î¼ (f '' (s âˆ© closed_ball 0 n)) :
      by { rw image_Union, exact measure_Union_le _ }
    ... â‰¤ 0 : by simp only [H, tsum_zero, nonpos_iff_eq_zero] },
  assume R,
  have A : âˆ€ (Îµ : â„â‰¥0) (Îµpos : 0 < Îµ), Î¼ (f '' (s âˆ© closed_ball 0 R)) â‰¤ Îµ * Î¼ (closed_ball 0 R) :=
    Î» Îµ Îµpos, add_haar_image_eq_zero_of_det_fderiv_within_eq_zero_aux Î¼
      (Î» x hx, (hf' x hx.1).mono (inter_subset_left _ _)) R (inter_subset_right _ _) Îµ Îµpos
      (Î» x hx, h'f' x hx.1),
  have B : tendsto (Î» (Îµ : â„â‰¥0), (Îµ : â„â‰¥0âˆ) * Î¼ (closed_ball 0 R)) (ğ“[>] 0) (ğ“ 0),
  { have : tendsto (Î» (Îµ : â„â‰¥0), (Îµ : â„â‰¥0âˆ) * Î¼ (closed_ball 0 R))
      (ğ“ 0) (ğ“ (((0 : â„â‰¥0) : â„â‰¥0âˆ) * Î¼ (closed_ball 0 R))) :=
        ennreal.tendsto.mul_const (ennreal.tendsto_coe.2 tendsto_id)
          (or.inr ((measure_closed_ball_lt_top).ne)),
    simp only [zero_mul, ennreal.coe_zero] at this,
    exact tendsto.mono_left this nhds_within_le_nhds },
  apply le_antisymm _ (zero_le _),
  apply ge_of_tendsto B,
  filter_upwards [self_mem_nhds_within],
  exact A,
end
lemma ae_measurable_fderiv_within (hs : measurable_set s)
  (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x) :
  ae_measurable f' (Î¼.restrict s) :=
begin
lemma measurable_image_of_fderiv_within (hs : measurable_set s)
  (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x) (hf : inj_on f s) :
  measurable_set (f '' s) :=
begin
  have : differentiable_on â„ f s := Î» x hx, (hf' x hx).differentiable_within_at,
  exact hs.image_of_continuous_on_inj_on (differentiable_on.continuous_on this) hf,
end
lemma measurable_embedding_of_fderiv_within (hs : measurable_set s)
  (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x) (hf : inj_on f s) :
  measurable_embedding (s.restrict f) :=
begin
  have : differentiable_on â„ f s := Î» x hx, (hf' x hx).differentiable_within_at,
  exact this.continuous_on.measurable_embedding hs hf
end
lemma add_haar_image_le_lintegral_abs_det_fderiv_aux1 (hs : measurable_set s)
  (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x) {Îµ : â„â‰¥0} (Îµpos : 0 < Îµ) :
  Î¼ (f '' s) â‰¤ âˆ«â» x in s, ennreal.of_real (|(f' x).det|) âˆ‚Î¼ + 2 * Îµ * Î¼ s :=
begin
  have : âˆ€ (A : E â†’L[â„] E), âˆƒ (Î´ : â„â‰¥0), 0 < Î´ âˆ§
    (âˆ€ (B : E â†’L[â„] E), âˆ¥B - Aâˆ¥ â‰¤ Î´ â†’ |B.det - A.det| â‰¤ Îµ) âˆ§
    âˆ€ (t : set E) (g : E â†’ E) (hf : approximates_linear_on g A t Î´),
     Î¼ (g '' t) â‰¤ (ennreal.of_real (|A.det|) + Îµ) * Î¼ t,
  { assume A,
    let m : â„â‰¥0 := real.to_nnreal (|A.det|) + Îµ,
    have I : ennreal.of_real (|A.det|) < m,
      by simp only [ennreal.of_real, m, lt_add_iff_pos_right, Îµpos, ennreal.coe_lt_coe],
    rcases ((add_haar_image_le_mul_of_det_lt Î¼ A I).and self_mem_nhds_within).exists
      with âŸ¨Î´, h, Î´posâŸ©,
    obtain âŸ¨Î´', Î´'pos, hÎ´'âŸ© :
      âˆƒ (Î´' : â„) (H : 0 < Î´'), âˆ€ B, dist B A < Î´' â†’ dist B.det A.det < â†‘Îµ :=
        continuous_at_iff.1 continuous_linear_map.continuous_det.continuous_at Îµ Îµpos,
    let Î´'' : â„â‰¥0 := âŸ¨Î´' / 2, (half_pos Î´'pos).leâŸ©,
    refine âŸ¨min Î´ Î´'', lt_min Î´pos (half_pos Î´'pos), _, _âŸ©,
    { assume B hB,
      rw â† real.dist_eq,
      apply (hÎ´' B _).le,
      rw dist_eq_norm,
      calc âˆ¥B - Aâˆ¥ â‰¤ (min Î´ Î´'' : â„â‰¥0) : hB
      ... â‰¤ Î´'' : by simp only [le_refl, nnreal.coe_min, min_le_iff, or_true]
      ... < Î´' : half_lt_self Î´'pos },
    { assume t g htg,
      exact h t g (htg.mono_num (min_le_left _ _)) } },
  choose Î´ hÎ´ using this,
  obtain âŸ¨t, A, t_disj, t_meas, t_cover, ht, -âŸ© : âˆƒ (t : â„• â†’ set E) (A : â„• â†’ (E â†’L[â„] E)),
    pairwise (disjoint on t) âˆ§ (âˆ€ (n : â„•), measurable_set (t n)) âˆ§ (s âŠ† â‹ƒ (n : â„•), t n)
    âˆ§ (âˆ€ (n : â„•), approximates_linear_on f (A n) (s âˆ© t n) (Î´ (A n)))
    âˆ§ (s.nonempty â†’ âˆ€ n, âˆƒ y âˆˆ s, A n = f' y) :=
      exists_partition_approximates_linear_on_of_has_fderiv_within_at f s
      f' hf' Î´ (Î» A, (hÎ´ A).1.ne'),
  calc Î¼ (f '' s)
      â‰¤ Î¼ (â‹ƒ n, f '' (s âˆ© t n)) :
    begin
      apply measure_mono,
      rw [â† image_Union, â† inter_Union],
      exact image_subset f (subset_inter subset.rfl t_cover)
    end
  ... â‰¤ âˆ‘' n, Î¼ (f '' (s âˆ© t n)) : measure_Union_le _
  ... â‰¤ âˆ‘' n, (ennreal.of_real (|(A n).det|) + Îµ) * Î¼ (s âˆ© t n) :
    begin
      apply ennreal.tsum_le_tsum (Î» n, _),
      apply (hÎ´ (A n)).2.2,
      exact ht n,
    end
  ... = âˆ‘' n, âˆ«â» x in s âˆ© t n, ennreal.of_real (|(A n).det|) + Îµ âˆ‚Î¼ :
    by simp only [lintegral_const, measurable_set.univ, measure.restrict_apply, univ_inter]
  ... â‰¤ âˆ‘' n, âˆ«â» x in s âˆ© t n, ennreal.of_real (|(f' x).det|) + 2 * Îµ âˆ‚Î¼ :
    begin
      apply ennreal.tsum_le_tsum (Î» n, _),
      apply lintegral_mono_ae,
      filter_upwards [(ht n).norm_fderiv_sub_le Î¼ (hs.inter (t_meas n)) f'
          (Î» x hx, (hf' x hx.1).mono (inter_subset_left _ _))],
      assume x hx,
      have I : |(A n).det| â‰¤ |(f' x).det| + Îµ := calc
        |(A n).det| = |(f' x).det - ((f' x).det - (A n).det)| : by { congr' 1, abel }
        ... â‰¤ |(f' x).det| + |(f' x).det - (A n).det| : abs_sub _ _
        ... â‰¤ |(f' x).det| + Îµ : add_le_add le_rfl ((hÎ´ (A n)).2.1 _ hx),
      calc ennreal.of_real (|(A n).det|) + Îµ
          â‰¤ ennreal.of_real (|(f' x).det| + Îµ) + Îµ :
        add_le_add (ennreal.of_real_le_of_real I) le_rfl
      ... = ennreal.of_real (|(f' x).det|) + 2 * Îµ :
        by simp only [ennreal.of_real_add, abs_nonneg, two_mul, add_assoc, nnreal.zero_le_coe,
                      ennreal.of_real_coe_nnreal],
    end
  ... = âˆ«â» x in â‹ƒ n, s âˆ© t n, ennreal.of_real (|(f' x).det|) + 2 * Îµ âˆ‚Î¼ :
    begin
      have M : âˆ€ (n : â„•), measurable_set (s âˆ© t n) := Î» n, hs.inter (t_meas n),
      rw lintegral_Union M,
      exact pairwise_disjoint.mono t_disj (Î» n, inter_subset_right _ _),
    end
  ... = âˆ«â» x in s, ennreal.of_real (|(f' x).det|) + 2 * Îµ âˆ‚Î¼ :
    begin
      have : s = â‹ƒ n, s âˆ© t n,
      { rw â† inter_Union,
        exact subset.antisymm (subset_inter subset.rfl t_cover) (inter_subset_left _ _) },
      rw â† this,
    end
  ... = âˆ«â» x in s, ennreal.of_real (|(f' x).det|) âˆ‚Î¼ + 2 * Îµ * Î¼ s :
    by simp only [lintegral_add_right' _ ae_measurable_const, set_lintegral_const]
end
lemma add_haar_image_le_lintegral_abs_det_fderiv_aux2 (hs : measurable_set s) (h's : Î¼ s â‰  âˆ)
  (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x) :
  Î¼ (f '' s) â‰¤ âˆ«â» x in s, ennreal.of_real (|(f' x).det|) âˆ‚Î¼ :=
begin
  have : tendsto (Î» (Îµ : â„â‰¥0), âˆ«â» x in s, ennreal.of_real (|(f' x).det|) âˆ‚Î¼ + 2 * Îµ * Î¼ s)
    (ğ“[>] 0) (ğ“ (âˆ«â» x in s, ennreal.of_real (|(f' x).det|) âˆ‚Î¼ + 2 * (0 : â„â‰¥0) * Î¼ s)),
  { apply tendsto.mono_left _ nhds_within_le_nhds,
    refine tendsto_const_nhds.add _,
    refine ennreal.tendsto.mul_const _ (or.inr h's),
    exact ennreal.tendsto.const_mul (ennreal.tendsto_coe.2 tendsto_id)
      (or.inr ennreal.coe_ne_top) },
  simp only [add_zero, zero_mul, mul_zero, ennreal.coe_zero] at this,
  apply ge_of_tendsto this,
  filter_upwards [self_mem_nhds_within],
  rintros Îµ (Îµpos : 0 < Îµ),
  exact add_haar_image_le_lintegral_abs_det_fderiv_aux1 Î¼ hs hf' Îµpos,
end
lemma add_haar_image_le_lintegral_abs_det_fderiv (hs : measurable_set s)
  (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x) :
  Î¼ (f '' s) â‰¤ âˆ«â» x in s, ennreal.of_real (|(f' x).det|) âˆ‚Î¼ :=
begin
  let u := Î» n, disjointed (spanning_sets Î¼) n,
  have u_meas : âˆ€ n, measurable_set (u n),
  { assume n,
    apply measurable_set.disjointed (Î» i, _),
    exact measurable_spanning_sets Î¼ i },
  have A : s = â‹ƒ n, s âˆ© u n,
    by rw [â† inter_Union, Union_disjointed, Union_spanning_sets, inter_univ],
  calc Î¼ (f '' s) â‰¤ âˆ‘' n, Î¼ (f '' (s âˆ© u n)) :
    begin
      conv_lhs { rw [A, image_Union] },
      exact measure_Union_le _,
    end
  ... â‰¤ âˆ‘' n, âˆ«â» x in s âˆ© u n, ennreal.of_real (|(f' x).det|) âˆ‚Î¼ :
    begin
      apply ennreal.tsum_le_tsum (Î» n, _),
      apply add_haar_image_le_lintegral_abs_det_fderiv_aux2 Î¼ (hs.inter (u_meas n)) _
        (Î» x hx, (hf' x hx.1).mono (inter_subset_left _ _)),
      have : Î¼ (u n) < âˆ :=
        lt_of_le_of_lt (measure_mono (disjointed_subset _ _)) (measure_spanning_sets_lt_top Î¼ n),
      exact ne_of_lt (lt_of_le_of_lt (measure_mono (inter_subset_right _ _)) this),
    end
  ... = âˆ«â» x in s, ennreal.of_real (|(f' x).det|) âˆ‚Î¼ :
    begin
      conv_rhs { rw A },
      rw lintegral_Union,
      { assume n, exact hs.inter (u_meas n) },
      { exact pairwise_disjoint.mono (disjoint_disjointed _) (Î» n, inter_subset_right _ _) }
    end
end
lemma lintegral_abs_det_fderiv_le_add_haar_image_aux1 (hs : measurable_set s)
  (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x) (hf : inj_on f s)
  {Îµ : â„â‰¥0} (Îµpos : 0 < Îµ) :
  âˆ«â» x in s, ennreal.of_real (|(f' x).det|) âˆ‚Î¼ â‰¤ Î¼ (f '' s) + 2 * Îµ * Î¼ s :=
begin
  have : âˆ€ (A : E â†’L[â„] E), âˆƒ (Î´ : â„â‰¥0), 0 < Î´ âˆ§
    (âˆ€ (B : E â†’L[â„] E), âˆ¥B - Aâˆ¥ â‰¤ Î´ â†’ |B.det - A.det| â‰¤ Îµ) âˆ§
    âˆ€ (t : set E) (g : E â†’ E) (hf : approximates_linear_on g A t Î´),
     ennreal.of_real (|A.det|) * Î¼ t â‰¤ Î¼ (g '' t) + Îµ * Î¼ t,
  { assume A,
    obtain âŸ¨Î´', Î´'pos, hÎ´'âŸ© :
      âˆƒ (Î´' : â„) (H : 0 < Î´'), âˆ€ B, dist B A < Î´' â†’ dist B.det A.det < â†‘Îµ :=
        continuous_at_iff.1 continuous_linear_map.continuous_det.continuous_at Îµ Îµpos,
    let Î´'' : â„â‰¥0 := âŸ¨Î´' / 2, (half_pos Î´'pos).leâŸ©,
    have I'' : âˆ€ (B : E â†’L[â„] E), âˆ¥B - Aâˆ¥ â‰¤ â†‘Î´'' â†’ |B.det - A.det| â‰¤ â†‘Îµ,
    { assume B hB,
      rw â† real.dist_eq,
      apply (hÎ´' B _).le,
      rw dist_eq_norm,
      exact hB.trans_lt (half_lt_self Î´'pos) },
    rcases eq_or_ne A.det 0 with hA|hA,
    { refine âŸ¨Î´'', half_pos Î´'pos, I'', _âŸ©,
      simp only [hA, forall_const, zero_mul, ennreal.of_real_zero, implies_true_iff, zero_le,
        abs_zero] },
    let m : â„â‰¥0 := real.to_nnreal (|A.det|) - Îµ,
    have I : (m : â„â‰¥0âˆ) < ennreal.of_real (|A.det|),
    { simp only [ennreal.of_real, with_top.coe_sub],
      apply ennreal.sub_lt_self ennreal.coe_ne_top,
      { simpa only [abs_nonpos_iff, real.to_nnreal_eq_zero, ennreal.coe_eq_zero, ne.def] using hA },
      { simp only [Îµpos.ne', ennreal.coe_eq_zero, ne.def, not_false_iff] } },
    rcases ((mul_le_add_haar_image_of_lt_det Î¼ A I).and self_mem_nhds_within).exists
      with âŸ¨Î´, h, Î´posâŸ©,
    refine âŸ¨min Î´ Î´'', lt_min Î´pos (half_pos Î´'pos), _, _âŸ©,
    { assume B hB,
      apply I'' _ (hB.trans _),
      simp only [le_refl, nnreal.coe_min, min_le_iff, or_true] },
    { assume t g htg,
      rcases eq_or_ne (Î¼ t) âˆ with ht|ht,
      { simp only [ht, Îµpos.ne', with_top.mul_top, ennreal.coe_eq_zero, le_top, ne.def,
                   not_false_iff, ennreal.add_top] },
      have := h t g (htg.mono_num (min_le_left _ _)),
      rwa [with_top.coe_sub, ennreal.sub_mul, tsub_le_iff_right] at this,
      simp only [ht, implies_true_iff, ne.def, not_false_iff] } },
  choose Î´ hÎ´ using this,
  obtain âŸ¨t, A, t_disj, t_meas, t_cover, ht, -âŸ© : âˆƒ (t : â„• â†’ set E) (A : â„• â†’ (E â†’L[â„] E)),
    pairwise (disjoint on t) âˆ§ (âˆ€ (n : â„•), measurable_set (t n)) âˆ§ (s âŠ† â‹ƒ (n : â„•), t n)
    âˆ§ (âˆ€ (n : â„•), approximates_linear_on f (A n) (s âˆ© t n) (Î´ (A n)))
    âˆ§ (s.nonempty â†’ âˆ€ n, âˆƒ y âˆˆ s, A n = f' y) :=
      exists_partition_approximates_linear_on_of_has_fderiv_within_at f s
      f' hf' Î´ (Î» A, (hÎ´ A).1.ne'),
  have s_eq : s = â‹ƒ n, s âˆ© t n,
  { rw â† inter_Union,
    exact subset.antisymm (subset_inter subset.rfl t_cover) (inter_subset_left _ _) },
  calc âˆ«â» x in s, ennreal.of_real (|(f' x).det|) âˆ‚Î¼
      = âˆ‘' n, âˆ«â» x in s âˆ© t n, ennreal.of_real (|(f' x).det|) âˆ‚Î¼ :
    begin
      conv_lhs { rw s_eq },
      rw lintegral_Union,
      { exact Î» n, hs.inter (t_meas n) },
      { exact pairwise_disjoint.mono t_disj (Î» n, inter_subset_right _ _) }
    end
  ... â‰¤ âˆ‘' n, âˆ«â» x in s âˆ© t n, ennreal.of_real (|(A n).det|) + Îµ âˆ‚Î¼ :
    begin
      apply ennreal.tsum_le_tsum (Î» n, _),
      apply lintegral_mono_ae,
      filter_upwards [(ht n).norm_fderiv_sub_le Î¼ (hs.inter (t_meas n)) f'
          (Î» x hx, (hf' x hx.1).mono (inter_subset_left _ _))],
      assume x hx,
      have I : |(f' x).det| â‰¤ |(A n).det| + Îµ := calc
        |(f' x).det| = |(A n).det + ((f' x).det - (A n).det)| : by { congr' 1, abel }
        ... â‰¤ |(A n).det| + |(f' x).det - (A n).det| : abs_add _ _
        ... â‰¤ |(A n).det| + Îµ : add_le_add le_rfl ((hÎ´ (A n)).2.1 _ hx),
      calc ennreal.of_real (|(f' x).det|) â‰¤ ennreal.of_real (|(A n).det| + Îµ) :
        ennreal.of_real_le_of_real I
      ... = ennreal.of_real (|(A n).det|) + Îµ :
        by simp only [ennreal.of_real_add, abs_nonneg, nnreal.zero_le_coe,
                      ennreal.of_real_coe_nnreal]
    end
  ... = âˆ‘' n, (ennreal.of_real (|(A n).det|) * Î¼ (s âˆ© t n) + Îµ * Î¼ (s âˆ© t n)) :
    by simp only [set_lintegral_const, lintegral_add_right _ measurable_const]
  ... â‰¤ âˆ‘' n, ((Î¼ (f '' (s âˆ© t n)) + Îµ * Î¼ (s âˆ© t n)) + Îµ * Î¼ (s âˆ© t n)) :
    begin
      refine ennreal.tsum_le_tsum (Î» n, add_le_add_right _ _),
      exact (hÎ´ (A n)).2.2 _ _ (ht n),
    end
  ... = Î¼ (f '' s) + 2 * Îµ * Î¼ s :
    begin
      conv_rhs { rw s_eq },
      rw [image_Union, measure_Union], rotate,
      { assume i j hij,
        apply (disjoint.image _ hf (inter_subset_left _ _) (inter_subset_left _ _)),
        exact disjoint.mono (inter_subset_right _ _) (inter_subset_right _ _) (t_disj i j hij) },
      { assume i,
        exact measurable_image_of_fderiv_within (hs.inter (t_meas i)) (Î» x hx,
          (hf' x hx.1).mono (inter_subset_left _ _)) (hf.mono (inter_subset_left _ _)) },
      rw measure_Union, rotate,
      { exact pairwise_disjoint.mono t_disj (Î» i, inter_subset_right _ _) },
      { exact Î» i, hs.inter (t_meas i) },
      rw [â† ennreal.tsum_mul_left, â† ennreal.tsum_add],
      congr' 1,
      ext1 i,
      rw [mul_assoc, two_mul, add_assoc],
    end
end
lemma lintegral_abs_det_fderiv_le_add_haar_image_aux2 (hs : measurable_set s) (h's : Î¼ s â‰  âˆ)
  (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x) (hf : inj_on f s) :
  âˆ«â» x in s, ennreal.of_real (|(f' x).det|) âˆ‚Î¼ â‰¤ Î¼ (f '' s) :=
begin
  have : tendsto (Î» (Îµ : â„â‰¥0), Î¼ (f '' s) + 2 * Îµ * Î¼ s)
    (ğ“[>] 0) (ğ“ (Î¼ (f '' s) + 2 * (0 : â„â‰¥0) * Î¼ s)),
  { apply tendsto.mono_left _ nhds_within_le_nhds,
    refine tendsto_const_nhds.add _,
    refine ennreal.tendsto.mul_const _ (or.inr h's),
    exact ennreal.tendsto.const_mul (ennreal.tendsto_coe.2 tendsto_id)
      (or.inr ennreal.coe_ne_top) },
  simp only [add_zero, zero_mul, mul_zero, ennreal.coe_zero] at this,
  apply ge_of_tendsto this,
  filter_upwards [self_mem_nhds_within],
  rintros Îµ (Îµpos : 0 < Îµ),
  exact lintegral_abs_det_fderiv_le_add_haar_image_aux1 Î¼ hs hf' hf Îµpos
end
lemma lintegral_abs_det_fderiv_le_add_haar_image (hs : measurable_set s)
  (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x) (hf : inj_on f s) :
  âˆ«â» x in s, ennreal.of_real (|(f' x).det|) âˆ‚Î¼ â‰¤ Î¼ (f '' s) :=
begin
  let u := Î» n, disjointed (spanning_sets Î¼) n,
  have u_meas : âˆ€ n, measurable_set (u n),
  { assume n,
    apply measurable_set.disjointed (Î» i, _),
    exact measurable_spanning_sets Î¼ i },
  have A : s = â‹ƒ n, s âˆ© u n,
    by rw [â† inter_Union, Union_disjointed, Union_spanning_sets, inter_univ],
  calc âˆ«â» x in s, ennreal.of_real (|(f' x).det|) âˆ‚Î¼
      = âˆ‘' n, âˆ«â» x in s âˆ© u n, ennreal.of_real (|(f' x).det|) âˆ‚Î¼ :
    begin
      conv_lhs { rw A },
      rw lintegral_Union,
      { assume n, exact hs.inter (u_meas n) },
      { exact pairwise_disjoint.mono (disjoint_disjointed _) (Î» n, inter_subset_right _ _) }
    end
  ... â‰¤ âˆ‘' n, Î¼ (f '' (s âˆ© u n)) :
    begin
      apply ennreal.tsum_le_tsum (Î» n, _),
      apply lintegral_abs_det_fderiv_le_add_haar_image_aux2 Î¼ (hs.inter (u_meas n)) _
        (Î» x hx, (hf' x hx.1).mono (inter_subset_left _ _)) (hf.mono (inter_subset_left _ _)),
      have : Î¼ (u n) < âˆ :=
        lt_of_le_of_lt (measure_mono (disjointed_subset _ _)) (measure_spanning_sets_lt_top Î¼ n),
      exact ne_of_lt (lt_of_le_of_lt (measure_mono (inter_subset_right _ _)) this),
    end
  ... = Î¼ (f '' s) :
    begin
      conv_rhs { rw [A, image_Union] },
      rw measure_Union,
      { assume i j hij,
        apply disjoint.image _ hf (inter_subset_left _ _) (inter_subset_left _ _),
        exact disjoint.mono (inter_subset_right _ _) (inter_subset_right _ _)
          (disjoint_disjointed _ i j hij) },
      { assume i,
        exact measurable_image_of_fderiv_within (hs.inter (u_meas i)) (Î» x hx,
          (hf' x hx.1).mono (inter_subset_left _ _)) (hf.mono (inter_subset_left _ _)) },
    end
end
theorem lintegral_abs_det_fderiv_eq_add_haar_image (hs : measurable_set s)
  (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x) (hf : inj_on f s) :
  âˆ«â» x in s, ennreal.of_real (|(f' x).det|) âˆ‚Î¼ = Î¼ (f '' s) :=
le_antisymm (lintegral_abs_det_fderiv_le_add_haar_image Î¼ hs hf' hf)
  (add_haar_image_le_lintegral_abs_det_fderiv Î¼ hs hf')
theorem map_with_density_abs_det_fderiv_eq_add_haar (hs : measurable_set s)
  (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x) (hf : inj_on f s)
  (h'f : measurable f) :
  measure.map f ((Î¼.restrict s).with_density (Î» x, ennreal.of_real (|(f' x).det|)))
    = Î¼.restrict (f '' s) :=
begin
  apply measure.ext (Î» t ht, _),
  rw [map_apply h'f ht, with_density_apply _ (h'f ht), measure.restrict_apply ht,
      restrict_restrict (h'f ht),
      lintegral_abs_det_fderiv_eq_add_haar_image Î¼ ((h'f ht).inter hs)
        (Î» x hx, (hf' x hx.2).mono (inter_subset_right _ _)) (hf.mono (inter_subset_right _ _)),
      image_preimage_inter]
end
theorem restrict_map_with_density_abs_det_fderiv_eq_add_haar (hs : measurable_set s)
  (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x) (hf : inj_on f s) :
  measure.map (s.restrict f)
    (comap coe (Î¼.with_density (Î» x, ennreal.of_real (|(f' x).det|)))) = Î¼.restrict (f '' s) :=
begin
  obtain âŸ¨u, u_meas, ufâŸ© : âˆƒ u, measurable u âˆ§ eq_on u f s,
  { classical,
    refine âŸ¨piecewise s f 0, _, piecewise_eq_on _ _ _âŸ©,
    refine continuous_on.measurable_piecewise _ continuous_zero.continuous_on hs,
    have : differentiable_on â„ f s := Î» x hx, (hf' x hx).differentiable_within_at,
    exact this.continuous_on },
  have u' : âˆ€ x âˆˆ s, has_fderiv_within_at u (f' x) s x :=
    Î» x hx, (hf' x hx).congr (Î» y hy, uf hy) (uf hx),
  set F : s â†’ E := u âˆ˜ coe with hF,
  have A : measure.map F
    (comap coe (Î¼.with_density (Î» x, ennreal.of_real (|(f' x).det|)))) = Î¼.restrict (u '' s),
  { rw [hF, â† measure.map_map u_meas measurable_subtype_coe, map_comap_subtype_coe hs,
        restrict_with_density hs],
    exact map_with_density_abs_det_fderiv_eq_add_haar Î¼ hs u' (hf.congr uf.symm) u_meas },
  rw uf.image_eq at A,
  have : F = s.restrict f,
  { ext x,
    exact uf x.2 },
  rwa this at A,
end
theorem lintegral_image_eq_lintegral_abs_det_fderiv_mul (hs : measurable_set s)
  (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x) (hf : inj_on f s) (g : E â†’ â„â‰¥0âˆ) :
  âˆ«â» x in f '' s, g x âˆ‚Î¼ = âˆ«â» x in s, ennreal.of_real (|(f' x).det|) * g (f x) âˆ‚Î¼ :=
begin
  rw [â† restrict_map_with_density_abs_det_fderiv_eq_add_haar Î¼ hs hf' hf,
      (measurable_embedding_of_fderiv_within hs hf' hf).lintegral_map],
  have : âˆ€ (x : s), g (s.restrict f x) = (g âˆ˜ f) x := Î» x, rfl,
  simp only [this],
  rw [â† (measurable_embedding.subtype_coe hs).lintegral_map, map_comap_subtype_coe hs,
      set_lintegral_with_density_eq_set_lintegral_mul_non_measurableâ‚€ _ _ _ hs],
  { refl },
  { simp only [eventually_true, ennreal.of_real_lt_top] },
  { exact ae_measurable_of_real_abs_det_fderiv_within Î¼ hs hf' }
end
theorem integrable_on_image_iff_integrable_on_abs_det_fderiv_smul (hs : measurable_set s)
  (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x) (hf : inj_on f s) (g : E â†’ F) :
  integrable_on g (f '' s) Î¼ â†” integrable_on (Î» x, |(f' x).det| â€¢ g (f x)) s Î¼ :=
begin
  rw [integrable_on, â† restrict_map_with_density_abs_det_fderiv_eq_add_haar Î¼ hs hf' hf,
      (measurable_embedding_of_fderiv_within hs hf' hf).integrable_map_iff],
  change (integrable ((g âˆ˜ f) âˆ˜ (coe : s â†’ E)) _) â†” _,
  rw [â† (measurable_embedding.subtype_coe hs).integrable_map_iff, map_comap_subtype_coe hs],
  simp only [ennreal.of_real],
  rw [restrict_with_density hs, integrable_with_density_iff_integrable_coe_smulâ‚€, integrable_on],
  { congr' 2 with x,
    rw real.coe_to_nnreal,
    exact abs_nonneg _ },
  { exact ae_measurable_to_nnreal_abs_det_fderiv_within Î¼ hs hf' }
end
theorem integral_image_eq_integral_abs_det_fderiv_smul [complete_space F] (hs : measurable_set s)
  (hf' : âˆ€ x âˆˆ s, has_fderiv_within_at f (f' x) s x) (hf : inj_on f s) (g : E â†’ F) :
  âˆ« x in f '' s, g x âˆ‚Î¼ = âˆ« x in s, |(f' x).det| â€¢ g (f x) âˆ‚Î¼ :=
begin
  rw [â† restrict_map_with_density_abs_det_fderiv_eq_add_haar Î¼ hs hf' hf,
      (measurable_embedding_of_fderiv_within hs hf' hf).integral_map],
  have : âˆ€ (x : s), g (s.restrict f x) = (g âˆ˜ f) x := Î» x, rfl,
  simp only [this, ennreal.of_real],
  rw [â† (measurable_embedding.subtype_coe hs).integral_map, map_comap_subtype_coe hs,
      set_integral_with_density_eq_set_integral_smulâ‚€
        (ae_measurable_to_nnreal_abs_det_fderiv_within Î¼ hs hf') _ hs],
  congr' with x,
  conv_rhs { rw â† real.coe_to_nnreal _ (abs_nonneg (f' x).det) },
  refl
end
theorem integral_target_eq_integral_abs_det_fderiv_smul [complete_space F]
  {f : local_homeomorph E E} (hf' : âˆ€ x âˆˆ f.source, has_fderiv_at f (f' x) x) (g : E â†’ F) :
  âˆ« x in f.target, g x âˆ‚Î¼ = âˆ« x in f.source, |(f' x).det| â€¢ g (f x) âˆ‚Î¼ :=
begin
  have : f '' f.source = f.target := local_equiv.image_source_eq_target f.to_local_equiv,
  rw â† this,
  apply integral_image_eq_integral_abs_det_fderiv_smul Î¼ f.open_source.measurable_set _ f.inj_on,
  assume x hx,
  exact (hf' x hx).has_fderiv_within_at
end
end measure_theory
