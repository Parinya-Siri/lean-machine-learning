import analysis.normed_space.dual
import data.set.intervals.disjoint
import measure_theory.measure.haar_lebesgue
import analysis.calculus.extend_deriv
import measure_theory.function.locally_integrable
import measure_theory.integral.set_integral
import measure_theory.integral.vitali_caratheodory
import analysis.calculus.fderiv_measurable
noncomputable theory
open topological_space (second_countable_topology)
open measure_theory set classical filter function
open_locale classical topological_space filter ennreal big_operators interval nnreal
variables {Œπ ùïú E F : Type*} [normed_group E]
def interval_integrable (f : ‚Ñù ‚Üí E) (Œº : measure ‚Ñù) (a b : ‚Ñù) :=
integrable_on f (Ioc a b) Œº ‚àß integrable_on f (Ioc b a) Œº
section
variables {f : ‚Ñù ‚Üí E} {a b : ‚Ñù} {Œº : measure ‚Ñù}
lemma interval_integrable_iff : interval_integrable f Œº a b ‚Üî integrable_on f (Œô a b) Œº :=
by rw [interval_oc_eq_union, integrable_on_union, interval_integrable]
lemma interval_integrable.def (h : interval_integrable f Œº a b) : integrable_on f (Œô a b) Œº :=
interval_integrable_iff.mp h
lemma interval_integrable_iff_integrable_Ioc_of_le (hab : a ‚â§ b) :
  interval_integrable f Œº a b ‚Üî integrable_on f (Ioc a b) Œº :=
by rw [interval_integrable_iff, interval_oc_of_le hab]
lemma integrable_on_Icc_iff_integrable_on_Ioc'
  {E : Type*} [normed_group E] {f : ‚Ñù ‚Üí E} (ha : Œº {a} ‚â† ‚àû) :
  integrable_on f (Icc a b) Œº ‚Üî integrable_on f (Ioc a b) Œº :=
begin
  cases le_or_lt a b with hab hab,
  { have : Icc a b = Icc a a ‚à™ Ioc a b := (Icc_union_Ioc_eq_Icc le_rfl hab).symm,
    rw [this, integrable_on_union],
    simp [ha.lt_top] },
  { simp [hab, hab.le] },
end
lemma integrable_on_Icc_iff_integrable_on_Ioc
  {E : Type*}[normed_group E] [has_no_atoms Œº] {f : ‚Ñù ‚Üí E} {a b : ‚Ñù} :
  integrable_on f (Icc a b) Œº ‚Üî integrable_on f (Ioc a b) Œº :=
integrable_on_Icc_iff_integrable_on_Ioc' (by simp)
lemma integrable_on_Ioc_iff_integrable_on_Ioo'
  {E : Type*} [normed_group E]
  {f : ‚Ñù ‚Üí E} {a b : ‚Ñù} (hb : Œº {b} ‚â† ‚àû) :
  integrable_on f (Ioc a b) Œº ‚Üî integrable_on f (Ioo a b) Œº :=
begin
  cases lt_or_le a b with hab hab,
  { have : Ioc a b = Ioo a b ‚à™ Icc b b := (Ioo_union_Icc_eq_Ioc hab le_rfl).symm,
    rw [this, integrable_on_union],
    simp [hb.lt_top] },
  { simp [hab] },
end
lemma integrable_on_Ioc_iff_integrable_on_Ioo
  {E : Type*} [normed_group E] [has_no_atoms Œº] {f : ‚Ñù ‚Üí E} {a b : ‚Ñù} :
  integrable_on f (Ioc a b) Œº ‚Üî integrable_on f (Ioo a b) Œº :=
integrable_on_Ioc_iff_integrable_on_Ioo' (by simp)
lemma integrable_on_Icc_iff_integrable_on_Ioo
  {E : Type*} [normed_group E] [has_no_atoms Œº] {f : ‚Ñù ‚Üí E} {a b : ‚Ñù} :
  integrable_on f (Icc a b) Œº ‚Üî integrable_on f (Ioo a b) Œº :=
by rw [integrable_on_Icc_iff_integrable_on_Ioc, integrable_on_Ioc_iff_integrable_on_Ioo]
lemma interval_integrable_iff' [has_no_atoms Œº] :
  interval_integrable f Œº a b ‚Üî integrable_on f (interval a b) Œº :=
by rw [interval_integrable_iff, interval, interval_oc, integrable_on_Icc_iff_integrable_on_Ioc]
lemma interval_integrable_iff_integrable_Icc_of_le {E : Type*} [normed_group E]
  {f : ‚Ñù ‚Üí E} {a b : ‚Ñù} (hab : a ‚â§ b) {Œº : measure ‚Ñù} [has_no_atoms Œº] :
  interval_integrable f Œº a b ‚Üî integrable_on f (Icc a b) Œº :=
by rw [interval_integrable_iff_integrable_Ioc_of_le hab, integrable_on_Icc_iff_integrable_on_Ioc]
lemma integrable_on_Ici_iff_integrable_on_Ioi'
  {E : Type*} [normed_group E] {f : ‚Ñù ‚Üí E} (ha : Œº {a} ‚â† ‚àû) :
  integrable_on f (Ici a) Œº ‚Üî integrable_on f (Ioi a) Œº :=
begin
  have : Ici a = Icc a a ‚à™ Ioi a := (Icc_union_Ioi_eq_Ici le_rfl).symm,
  rw [this, integrable_on_union],
  simp [ha.lt_top]
end
lemma integrable_on_Ici_iff_integrable_on_Ioi
  {E : Type*} [normed_group E] [has_no_atoms Œº] {f : ‚Ñù ‚Üí E} :
  integrable_on f (Ici a) Œº ‚Üî integrable_on f (Ioi a) Œº :=
integrable_on_Ici_iff_integrable_on_Ioi' (by simp)
lemma measure_theory.integrable.interval_integrable (hf : integrable f Œº) :
  interval_integrable f Œº a b :=
‚ü®hf.integrable_on, hf.integrable_on‚ü©
lemma measure_theory.integrable_on.interval_integrable (hf : integrable_on f [a, b] Œº) :
  interval_integrable f Œº a b :=
‚ü®measure_theory.integrable_on.mono_set hf (Ioc_subset_Icc_self.trans Icc_subset_interval),
 measure_theory.integrable_on.mono_set hf (Ioc_subset_Icc_self.trans Icc_subset_interval')‚ü©
lemma interval_integrable_const_iff {c : E} :
  interval_integrable (Œª _, c) Œº a b ‚Üî c = 0 ‚à® Œº (Œô a b) < ‚àû :=
by simp only [interval_integrable_iff, integrable_on_const]
@[simp] lemma interval_integrable_const [is_locally_finite_measure Œº] {c : E} :
  interval_integrable (Œª _, c) Œº a b :=
interval_integrable_const_iff.2 $ or.inr measure_Ioc_lt_top
end
namespace interval_integrable
section
variables {f : ‚Ñù ‚Üí E} {a b c d : ‚Ñù} {Œº ŒΩ : measure ‚Ñù}
@[symm] lemma symm (h : interval_integrable f Œº a b) : interval_integrable f Œº b a :=
h.symm
@[refl] lemma refl : interval_integrable f Œº a a :=
by split; simp
@[trans] lemma trans {a b c : ‚Ñù} (hab : interval_integrable f Œº a b)
  (hbc : interval_integrable f Œº b c) : interval_integrable f Œº a c :=
‚ü®(hab.1.union hbc.1).mono_set Ioc_subset_Ioc_union_Ioc,
  (hbc.2.union hab.2).mono_set Ioc_subset_Ioc_union_Ioc‚ü©
lemma trans_iterate_Ico {a : ‚Ñï ‚Üí ‚Ñù} {m n : ‚Ñï} (hmn : m ‚â§ n)
  (hint : ‚àÄ k ‚àà Ico m n, interval_integrable f Œº (a k) (a $ k+1)) :
  interval_integrable f Œº (a m) (a n) :=
begin
  revert hint,
  refine nat.le_induction _ _ n hmn,
  { simp },
  { assume p hp IH h,
    exact (IH (Œª k hk, h k (Ico_subset_Ico_right p.le_succ hk))).trans (h p (by simp [hp])) }
end
lemma trans_iterate {a : ‚Ñï ‚Üí ‚Ñù} {n : ‚Ñï} (hint : ‚àÄ k < n, interval_integrable f Œº (a k) (a $ k+1)) :
  interval_integrable f Œº (a 0) (a n) :=
trans_iterate_Ico bot_le (Œª k hk, hint k hk.2)
lemma neg (h : interval_integrable f Œº a b) : interval_integrable (-f) Œº a b :=
‚ü®h.1.neg, h.2.neg‚ü©
lemma norm (h : interval_integrable f Œº a b) :
  interval_integrable (Œª x, ‚à•f x‚à•) Œº a b  :=
‚ü®h.1.norm, h.2.norm‚ü©
lemma abs {f : ‚Ñù ‚Üí ‚Ñù} (h : interval_integrable f Œº a b) :
  interval_integrable (Œª x, |f x|) Œº a b  :=
h.norm
lemma mono (hf : interval_integrable f ŒΩ a b) (h1 : [c, d] ‚äÜ [a, b]) (h2 : Œº ‚â§ ŒΩ) :
  interval_integrable f Œº c d :=
interval_integrable_iff.mpr $ hf.def.mono
  (interval_oc_subset_interval_oc_of_interval_subset_interval h1) h2
lemma mono_set (hf : interval_integrable f Œº a b) (h : [c, d] ‚äÜ [a, b]) :
  interval_integrable f Œº c d :=
hf.mono h rfl.le
lemma mono_measure (hf : interval_integrable f ŒΩ a b) (h : Œº ‚â§ ŒΩ) :
  interval_integrable f Œº a b :=
hf.mono rfl.subset h
lemma mono_set_ae (hf : interval_integrable f Œº a b) (h : Œô c d ‚â§·µê[Œº] Œô a b) :
  interval_integrable f Œº c d :=
interval_integrable_iff.mpr $ hf.def.mono_set_ae h
lemma mono_fun [normed_group F] {g : ‚Ñù ‚Üí F}
  (hf : interval_integrable f Œº a b) (hgm : ae_strongly_measurable g (Œº.restrict (Œô a b)))
  (hle : (Œª x, ‚à•g x‚à•) ‚â§·µê[Œº.restrict (Œô a b)] (Œª x, ‚à•f x‚à•)) : interval_integrable g Œº a b :=
interval_integrable_iff.2 $ hf.def.integrable.mono hgm hle
lemma mono_fun' {g : ‚Ñù ‚Üí ‚Ñù} (hg : interval_integrable g Œº a b)
  (hfm : ae_strongly_measurable f (Œº.restrict (Œô a b)))
  (hle : (Œª x, ‚à•f x‚à•) ‚â§·µê[Œº.restrict (Œô a b)] g) : interval_integrable f Œº a b :=
interval_integrable_iff.2 $ hg.def.integrable.mono' hfm hle
protected lemma ae_strongly_measurable (h : interval_integrable f Œº a b) :
  ae_strongly_measurable f (Œº.restrict (Ioc a b)):=
h.1.ae_strongly_measurable
protected lemma ae_strongly_measurable' (h : interval_integrable f Œº a b) :
  ae_strongly_measurable f (Œº.restrict (Ioc b a)):=
h.2.ae_strongly_measurable
end
variables {f g : ‚Ñù ‚Üí E} {a b : ‚Ñù} {Œº : measure ‚Ñù}
lemma smul [normed_field ùïú] [normed_space ùïú E]
  {f : ‚Ñù ‚Üí E} {a b : ‚Ñù} {Œº : measure ‚Ñù} (h : interval_integrable f Œº a b) (r : ùïú) :
  interval_integrable (r ‚Ä¢ f) Œº a b :=
‚ü®h.1.smul r, h.2.smul r‚ü©
@[simp] lemma add (hf : interval_integrable f Œº a b) (hg : interval_integrable g Œº a b) :
  interval_integrable (Œª x, f x + g x) Œº a b :=
‚ü®hf.1.add hg.1, hf.2.add hg.2‚ü©
@[simp] lemma sub (hf : interval_integrable f Œº a b) (hg : interval_integrable g Œº a b) :
  interval_integrable (Œª x, f x - g x) Œº a b :=
‚ü®hf.1.sub hg.1, hf.2.sub hg.2‚ü©
lemma sum (s : finset Œπ) {f : Œπ ‚Üí ‚Ñù ‚Üí E} (h : ‚àÄ i ‚àà s, interval_integrable (f i) Œº a b) :
  interval_integrable (‚àë i in s, f i) Œº a b :=
‚ü®integrable_finset_sum' s (Œª i hi, (h i hi).1), integrable_finset_sum' s (Œª i hi, (h i hi).2)‚ü©
lemma mul_continuous_on {f g : ‚Ñù ‚Üí ‚Ñù}
  (hf : interval_integrable f Œº a b) (hg : continuous_on g [a, b]) :
  interval_integrable (Œª x, f x * g x) Œº a b :=
begin
  rw interval_integrable_iff at hf ‚ä¢,
  exact hf.mul_continuous_on_of_subset hg measurable_set_Ioc is_compact_interval Ioc_subset_Icc_self
end
lemma continuous_on_mul {f g : ‚Ñù ‚Üí ‚Ñù} (hf : interval_integrable f Œº a b)
  (hg : continuous_on g [a, b]) :
  interval_integrable (Œª x, g x * f x) Œº a b :=
by simpa [mul_comm] using hf.mul_continuous_on hg
lemma comp_mul_left (hf : interval_integrable f volume a b) (c : ‚Ñù) :
  interval_integrable (Œª x, f (c * x)) volume (a / c) (b / c) :=
begin
  rcases eq_or_ne c 0 with hc|hc, { rw hc, simp },
  rw interval_integrable_iff' at hf ‚ä¢,
  have A : measurable_embedding (Œª x, x * c‚Åª¬π) :=
    (homeomorph.mul_right‚ÇÄ _ (inv_ne_zero hc)).closed_embedding.measurable_embedding,
  rw [‚Üêreal.smul_map_volume_mul_right (inv_ne_zero hc), integrable_on, measure.restrict_smul,
    integrable_smul_measure (by simpa : ennreal.of_real (|c‚Åª¬π|) ‚â† 0) ennreal.of_real_ne_top,
    ‚Üêintegrable_on, measurable_embedding.integrable_on_map_iff A],
  convert hf using 1,
  { ext, simp only [comp_app], congr' 1, field_simp, ring },
  { rw preimage_mul_const_interval (inv_ne_zero hc), field_simp [hc] },
end
lemma iff_comp_neg  :
  interval_integrable f volume a b ‚Üî interval_integrable (Œª x, f (-x)) volume (-a) (-b) :=
begin
  split, all_goals { intro hf, convert comp_mul_left hf (-1), simp, field_simp, field_simp },
end
end interval_integrable
section
variables {Œº : measure ‚Ñù} [is_locally_finite_measure Œº]
lemma continuous_on.interval_integrable {u : ‚Ñù ‚Üí E} {a b : ‚Ñù}
  (hu : continuous_on u (interval a b)) : interval_integrable u Œº a b :=
(continuous_on.integrable_on_Icc hu).interval_integrable
lemma continuous_on.interval_integrable_of_Icc {u : ‚Ñù ‚Üí E} {a b : ‚Ñù} (h : a ‚â§ b)
  (hu : continuous_on u (Icc a b)) : interval_integrable u Œº a b :=
continuous_on.interval_integrable ((interval_of_le h).symm ‚ñ∏ hu)
lemma continuous.interval_integrable {u : ‚Ñù ‚Üí E} (hu : continuous u) (a b : ‚Ñù) :
  interval_integrable u Œº a b :=
hu.continuous_on.interval_integrable
end
section
variables {Œº : measure ‚Ñù} [is_locally_finite_measure Œº] [conditionally_complete_linear_order E]
  [order_topology E] [second_countable_topology E]
lemma monotone_on.interval_integrable {u : ‚Ñù ‚Üí E} {a b : ‚Ñù} (hu : monotone_on u (interval a b)) :
  interval_integrable u Œº a b :=
begin
  rw interval_integrable_iff,
  exact (hu.integrable_on_compact is_compact_interval).mono_set Ioc_subset_Icc_self,
end
lemma antitone_on.interval_integrable {u : ‚Ñù ‚Üí E} {a b : ‚Ñù} (hu : antitone_on u (interval a b)) :
  interval_integrable u Œº a b :=
hu.dual_right.interval_integrable
lemma monotone.interval_integrable {u : ‚Ñù ‚Üí E} {a b : ‚Ñù} (hu : monotone u) :
  interval_integrable u Œº a b :=
(hu.monotone_on _).interval_integrable
lemma antitone.interval_integrable {u : ‚Ñù ‚Üí E} {a b : ‚Ñù} (hu : antitone u) :
  interval_integrable u Œº a b :=
(hu.antitone_on _).interval_integrable
end
lemma filter.tendsto.eventually_interval_integrable_ae {f : ‚Ñù ‚Üí E} {Œº : measure ‚Ñù}
  {l l' : filter ‚Ñù}  (hfm : strongly_measurable_at_filter f l' Œº)
  [tendsto_Ixx_class Ioc l l'] [is_measurably_generated l']
  (hŒº : Œº.finite_at_filter l') {c : E} (hf : tendsto f (l' ‚äì Œº.ae) (ùìù c))
  {u v : Œπ ‚Üí ‚Ñù} {lt : filter Œπ} (hu : tendsto u lt l) (hv : tendsto v lt l) :
  ‚àÄ·∂† t in lt, interval_integrable f Œº (u t) (v t) :=
have _ := (hf.integrable_at_filter_ae hfm hŒº).eventually,
((hu.Ioc hv).eventually this).and $ (hv.Ioc hu).eventually this
lemma filter.tendsto.eventually_interval_integrable {f : ‚Ñù ‚Üí E} {Œº : measure ‚Ñù}
  {l l' : filter ‚Ñù} (hfm : strongly_measurable_at_filter f l' Œº)
  [tendsto_Ixx_class Ioc l l'] [is_measurably_generated l']
  (hŒº : Œº.finite_at_filter l') {c : E} (hf : tendsto f l' (ùìù c))
  {u v : Œπ ‚Üí ‚Ñù} {lt : filter Œπ} (hu : tendsto u lt l) (hv : tendsto v lt l) :
  ‚àÄ·∂† t in lt, interval_integrable f Œº (u t) (v t) :=
(hf.mono_left inf_le_left).eventually_interval_integrable_ae hfm hŒº hu hv
variables [complete_space E] [normed_space ‚Ñù E]
def interval_integral (f : ‚Ñù ‚Üí E) (a b : ‚Ñù) (Œº : measure ‚Ñù) :=
‚à´ x in Ioc a b, f x ‚àÇŒº - ‚à´ x in Ioc b a, f x ‚àÇŒº
notation `‚à´` binders ` in ` a `..` b `, ` r:(scoped:60 f, f) ` ‚àÇ` Œº:70 := interval_integral r a b Œº
notation `‚à´` binders ` in ` a `..` b `, ` r:(scoped:60 f, interval_integral f a b volume) := r
namespace interval_integral
section basic
variables {a b : ‚Ñù} {f g : ‚Ñù ‚Üí E} {Œº : measure ‚Ñù}
@[simp] lemma integral_zero : ‚à´ x in a..b, (0 : E) ‚àÇŒº = 0 :=
by simp [interval_integral]
lemma integral_of_le (h : a ‚â§ b) : ‚à´ x in a..b, f x ‚àÇŒº = ‚à´ x in Ioc a b, f x ‚àÇŒº :=
by simp [interval_integral, h]
@[simp] lemma integral_same : ‚à´ x in a..a, f x ‚àÇŒº = 0 :=
sub_self _
lemma integral_symm (a b) : ‚à´ x in b..a, f x ‚àÇŒº = -‚à´ x in a..b, f x ‚àÇŒº :=
by simp only [interval_integral, neg_sub]
lemma integral_of_ge (h : b ‚â§ a) : ‚à´ x in a..b, f x ‚àÇŒº = -‚à´ x in Ioc b a, f x ‚àÇŒº :=
by simp only [integral_symm b, integral_of_le h]
lemma interval_integral_eq_integral_interval_oc (f : ‚Ñù ‚Üí E) (a b : ‚Ñù) (Œº : measure ‚Ñù) :
  ‚à´ x in a..b, f x ‚àÇŒº = (if a ‚â§ b then 1 else -1 : ‚Ñù) ‚Ä¢ ‚à´ x in Œô a b, f x ‚àÇŒº :=
begin
  split_ifs with h,
  { simp only [integral_of_le h, interval_oc_of_le h, one_smul] },
  { simp only [integral_of_ge (not_le.1 h).le, interval_oc_of_lt (not_le.1 h), neg_one_smul] }
end
lemma integral_cases (f : ‚Ñù ‚Üí E) (a b) :
  ‚à´ x in a..b, f x ‚àÇŒº ‚àà ({‚à´ x in Œô a b, f x ‚àÇŒº, -‚à´ x in Œô a b, f x ‚àÇŒº} : set E) :=
by { rw interval_integral_eq_integral_interval_oc, split_ifs; simp }
lemma integral_undef (h : ¬¨ interval_integrable f Œº a b) :
  ‚à´ x in a..b, f x ‚àÇŒº = 0 :=
by cases le_total a b with hab hab;
  simp only [integral_of_le, integral_of_ge, hab, neg_eq_zero];
    refine integral_undef (not_imp_not.mpr integrable.integrable_on' _);
      simpa [hab] using not_and_distrib.mp h
lemma integral_non_ae_strongly_measurable
  (hf : ¬¨ ae_strongly_measurable f (Œº.restrict (Œô a b))) :
  ‚à´ x in a..b, f x ‚àÇŒº = 0 :=
by rw [interval_integral_eq_integral_interval_oc, integral_non_ae_strongly_measurable hf, smul_zero]
lemma integral_non_ae_strongly_measurable_of_le (h : a ‚â§ b)
  (hf : ¬¨ ae_strongly_measurable f (Œº.restrict (Ioc a b))) :
  ‚à´ x in a..b, f x ‚àÇŒº = 0 :=
integral_non_ae_strongly_measurable $ by rwa [interval_oc_of_le h]
lemma norm_integral_min_max (f : ‚Ñù ‚Üí E) :
  ‚à•‚à´ x in min a b..max a b, f x ‚àÇŒº‚à• = ‚à•‚à´ x in a..b, f x ‚àÇŒº‚à• :=
by cases le_total a b; simp [*, integral_symm a b]
lemma norm_integral_eq_norm_integral_Ioc (f : ‚Ñù ‚Üí E) :
  ‚à•‚à´ x in a..b, f x ‚àÇŒº‚à• = ‚à•‚à´ x in Œô a b, f x ‚àÇŒº‚à• :=
by rw [‚Üê norm_integral_min_max, integral_of_le min_le_max, interval_oc]
lemma abs_integral_eq_abs_integral_interval_oc (f : ‚Ñù ‚Üí ‚Ñù) :
  |‚à´ x in a..b, f x ‚àÇŒº| = |‚à´ x in Œô a b, f x ‚àÇŒº| :=
norm_integral_eq_norm_integral_Ioc f
lemma norm_integral_le_integral_norm_Ioc :
  ‚à•‚à´ x in a..b, f x ‚àÇŒº‚à• ‚â§ ‚à´ x in Œô a b, ‚à•f x‚à• ‚àÇŒº :=
calc ‚à•‚à´ x in a..b, f x ‚àÇŒº‚à• = ‚à•‚à´ x in Œô a b, f x ‚àÇŒº‚à• :
  norm_integral_eq_norm_integral_Ioc f
... ‚â§ ‚à´ x in Œô a b, ‚à•f x‚à• ‚àÇŒº :
  norm_integral_le_integral_norm f
lemma norm_integral_le_abs_integral_norm : ‚à•‚à´ x in a..b, f x ‚àÇŒº‚à• ‚â§ |‚à´ x in a..b, ‚à•f x‚à• ‚àÇŒº| :=
begin
  simp only [‚Üê real.norm_eq_abs, norm_integral_eq_norm_integral_Ioc],
  exact le_trans (norm_integral_le_integral_norm _) (le_abs_self _)
end
lemma norm_integral_le_integral_norm (h : a ‚â§ b) :
  ‚à•‚à´ x in a..b, f x ‚àÇŒº‚à• ‚â§ ‚à´ x in a..b, ‚à•f x‚à• ‚àÇŒº :=
norm_integral_le_integral_norm_Ioc.trans_eq $ by rw [interval_oc_of_le h, integral_of_le h]
lemma norm_integral_le_of_norm_le_const_ae {a b C : ‚Ñù} {f : ‚Ñù ‚Üí E}
  (h : ‚àÄ·µê x, x ‚àà Œô a b ‚Üí ‚à•f x‚à• ‚â§ C) :
  ‚à•‚à´ x in a..b, f x‚à• ‚â§ C * |b - a| :=
begin
  rw [norm_integral_eq_norm_integral_Ioc],
  convert norm_set_integral_le_of_norm_le_const_ae'' _ measurable_set_Ioc h,
  { rw [real.volume_Ioc, max_sub_min_eq_abs, ennreal.to_real_of_real (abs_nonneg _)] },
  { simp only [real.volume_Ioc, ennreal.of_real_lt_top] },
end
lemma norm_integral_le_of_norm_le_const {a b C : ‚Ñù} {f : ‚Ñù ‚Üí E}
  (h : ‚àÄ x ‚àà Œô a b, ‚à•f x‚à• ‚â§ C) :
  ‚à•‚à´ x in a..b, f x‚à• ‚â§ C * |b - a| :=
norm_integral_le_of_norm_le_const_ae $ eventually_of_forall h
@[simp] lemma integral_add (hf : interval_integrable f Œº a b) (hg : interval_integrable g Œº a b) :
  ‚à´ x in a..b, f x + g x ‚àÇŒº = ‚à´ x in a..b, f x ‚àÇŒº + ‚à´ x in a..b, g x ‚àÇŒº :=
by simp only [interval_integral_eq_integral_interval_oc, integral_add hf.def hg.def, smul_add]
lemma integral_finset_sum {Œπ} {s : finset Œπ} {f : Œπ ‚Üí ‚Ñù ‚Üí E}
  (h : ‚àÄ i ‚àà s, interval_integrable (f i) Œº a b) :
  ‚à´ x in a..b, ‚àë i in s, f i x ‚àÇŒº = ‚àë i in s, ‚à´ x in a..b, f i x ‚àÇŒº :=
by simp only [interval_integral_eq_integral_interval_oc,
  integral_finset_sum s (Œª i hi, (h i hi).def), finset.smul_sum]
@[simp] lemma integral_neg : ‚à´ x in a..b, -f x ‚àÇŒº = -‚à´ x in a..b, f x ‚àÇŒº :=
by { simp only [interval_integral, integral_neg], abel }
@[simp] lemma integral_sub (hf : interval_integrable f Œº a b) (hg : interval_integrable g Œº a b) :
  ‚à´ x in a..b, f x - g x ‚àÇŒº = ‚à´ x in a..b, f x ‚àÇŒº - ‚à´ x in a..b, g x ‚àÇŒº :=
by simpa only [sub_eq_add_neg] using (integral_add hf hg.neg).trans (congr_arg _ integral_neg)
@[simp] lemma integral_smul {ùïú : Type*} [nondiscrete_normed_field ùïú] [normed_space ùïú E]
  [smul_comm_class ‚Ñù ùïú E]
  (r : ùïú) (f : ‚Ñù ‚Üí E) : ‚à´ x in a..b, r ‚Ä¢ f x ‚àÇŒº = r ‚Ä¢ ‚à´ x in a..b, f x ‚àÇŒº :=
by simp only [interval_integral, integral_smul, smul_sub]
@[simp] lemma integral_smul_const {ùïú : Type*} [is_R_or_C ùïú] [normed_space ùïú E] (f : ‚Ñù ‚Üí ùïú) (c : E) :
  ‚à´ x in a..b, f x ‚Ä¢ c ‚àÇŒº = (‚à´ x in a..b, f x ‚àÇŒº) ‚Ä¢ c :=
by simp only [interval_integral_eq_integral_interval_oc, integral_smul_const, smul_assoc]
@[simp] lemma integral_const_mul {ùïú : Type*} [is_R_or_C ùïú] (r : ùïú) (f : ‚Ñù ‚Üí ùïú) :
  ‚à´ x in a..b, r * f x ‚àÇŒº = r * ‚à´ x in a..b, f x ‚àÇŒº :=
integral_smul r f
@[simp] lemma integral_mul_const {ùïú : Type*} [is_R_or_C ùïú] (r : ùïú) (f : ‚Ñù ‚Üí ùïú) :
  ‚à´ x in a..b, f x * r ‚àÇŒº = ‚à´ x in a..b, f x ‚àÇŒº * r :=
by simpa only [mul_comm r] using integral_const_mul r f
@[simp] lemma integral_div {ùïú : Type*} [is_R_or_C ùïú] (r : ùïú) (f : ‚Ñù ‚Üí ùïú) :
  ‚à´ x in a..b, f x / r ‚àÇŒº = ‚à´ x in a..b, f x ‚àÇŒº / r :=
by simpa only [div_eq_mul_inv] using integral_mul_const r‚Åª¬π f
lemma integral_const' (c : E) :
  ‚à´ x in a..b, c ‚àÇŒº = ((Œº $ Ioc a b).to_real - (Œº $ Ioc b a).to_real) ‚Ä¢ c :=
by simp only [interval_integral, set_integral_const, sub_smul]
@[simp] lemma integral_const (c : E) : ‚à´ x in a..b, c = (b - a) ‚Ä¢ c :=
by simp only [integral_const', real.volume_Ioc, ennreal.to_real_of_real', ‚Üê neg_sub b,
  max_zero_sub_eq_self]
lemma integral_smul_measure (c : ‚Ñù‚â•0‚àû) :
  ‚à´ x in a..b, f x ‚àÇ(c ‚Ä¢ Œº) = c.to_real ‚Ä¢ ‚à´ x in a..b, f x ‚àÇŒº :=
by simp only [interval_integral, measure.restrict_smul, integral_smul_measure, smul_sub]
variables [normed_group F] [complete_space F] [normed_space ‚Ñù F]
lemma _root_.continuous_linear_map.interval_integral_comp_comm
  (L : E ‚ÜíL[‚Ñù] F) (hf : interval_integrable f Œº a b) :
  ‚à´ x in a..b, L (f x) ‚àÇŒº = L (‚à´ x in a..b, f x ‚àÇŒº) :=
begin
  rw [interval_integral, interval_integral, L.integral_comp_comm, L.integral_comp_comm, L.map_sub],
  exacts [hf.2, hf.1]
end
end basic
section comp
variables {a b c d : ‚Ñù} (f : ‚Ñù ‚Üí E)
@[simp] lemma integral_comp_mul_right (hc : c ‚â† 0) :
  ‚à´ x in a..b, f (x * c) = c‚Åª¬π ‚Ä¢ ‚à´ x in a*c..b*c, f x :=
begin
  have A : measurable_embedding (Œª x, x * c) :=
    (homeomorph.mul_right‚ÇÄ c hc).closed_embedding.measurable_embedding,
  conv_rhs { rw [‚Üê real.smul_map_volume_mul_right hc] },
  simp_rw [integral_smul_measure, interval_integral, A.set_integral_map,
          ennreal.to_real_of_real (abs_nonneg c)],
  cases hc.lt_or_lt,
  { simp [h, mul_div_cancel, hc, abs_of_neg, measure.restrict_congr_set Ico_ae_eq_Ioc] },
  { simp [h, mul_div_cancel, hc, abs_of_pos] }
end
@[simp] lemma smul_integral_comp_mul_right (c) :
  c ‚Ä¢ ‚à´ x in a..b, f (x * c) = ‚à´ x in a*c..b*c, f x :=
by by_cases hc : c = 0; simp [hc]
@[simp] lemma integral_comp_mul_left (hc : c ‚â† 0) :
  ‚à´ x in a..b, f (c * x) = c‚Åª¬π ‚Ä¢ ‚à´ x in c*a..c*b, f x :=
by simpa only [mul_comm c] using integral_comp_mul_right f hc
@[simp] lemma smul_integral_comp_mul_left (c) :
  c ‚Ä¢ ‚à´ x in a..b, f (c * x) = ‚à´ x in c*a..c*b, f x :=
by by_cases hc : c = 0; simp [hc]
@[simp] lemma integral_comp_div (hc : c ‚â† 0) :
  ‚à´ x in a..b, f (x / c) = c ‚Ä¢ ‚à´ x in a/c..b/c, f x :=
by simpa only [inv_inv] using integral_comp_mul_right f (inv_ne_zero hc)
@[simp] lemma inv_smul_integral_comp_div (c) :
  c‚Åª¬π ‚Ä¢ ‚à´ x in a..b, f (x / c) = ‚à´ x in a/c..b/c, f x :=
by by_cases hc : c = 0; simp [hc]
@[simp] lemma integral_comp_add_right (d) :
  ‚à´ x in a..b, f (x + d) = ‚à´ x in a+d..b+d, f x :=
have A : measurable_embedding (Œª x, x + d) :=
  (homeomorph.add_right d).closed_embedding.measurable_embedding,
calc  ‚à´ x in a..b, f (x + d)
    = ‚à´ x in a+d..b+d, f x ‚àÇ(measure.map (Œª x, x + d) volume)
                           : by simp [interval_integral, A.set_integral_map]
... = ‚à´ x in a+d..b+d, f x : by rw [map_add_right_eq_self]
@[simp] lemma integral_comp_add_left (d) :
  ‚à´ x in a..b, f (d + x) = ‚à´ x in d+a..d+b, f x :=
by simpa only [add_comm] using integral_comp_add_right f d
@[simp] lemma integral_comp_mul_add (hc : c ‚â† 0) (d) :
  ‚à´ x in a..b, f (c * x + d) = c‚Åª¬π ‚Ä¢ ‚à´ x in c*a+d..c*b+d, f x :=
by rw [‚Üê integral_comp_add_right, ‚Üê integral_comp_mul_left _ hc]
@[simp] lemma smul_integral_comp_mul_add (c d) :
  c ‚Ä¢ ‚à´ x in a..b, f (c * x + d) = ‚à´ x in c*a+d..c*b+d, f x :=
by by_cases hc : c = 0; simp [hc]
@[simp] lemma integral_comp_add_mul (hc : c ‚â† 0) (d) :
  ‚à´ x in a..b, f (d + c * x) = c‚Åª¬π ‚Ä¢ ‚à´ x in d+c*a..d+c*b, f x :=
by rw [‚Üê integral_comp_add_left, ‚Üê integral_comp_mul_left _ hc]
@[simp] lemma smul_integral_comp_add_mul (c d) :
  c ‚Ä¢ ‚à´ x in a..b, f (d + c * x) = ‚à´ x in d+c*a..d+c*b, f x :=
by by_cases hc : c = 0; simp [hc]
@[simp] lemma integral_comp_div_add (hc : c ‚â† 0) (d) :
  ‚à´ x in a..b, f (x / c + d) = c ‚Ä¢ ‚à´ x in a/c+d..b/c+d, f x :=
by simpa only [div_eq_inv_mul, inv_inv] using integral_comp_mul_add f (inv_ne_zero hc) d
@[simp] lemma inv_smul_integral_comp_div_add (c d) :
  c‚Åª¬π ‚Ä¢ ‚à´ x in a..b, f (x / c + d) = ‚à´ x in a/c+d..b/c+d, f x :=
by by_cases hc : c = 0; simp [hc]
@[simp] lemma integral_comp_add_div (hc : c ‚â† 0) (d) :
  ‚à´ x in a..b, f (d + x / c) = c ‚Ä¢ ‚à´ x in d+a/c..d+b/c, f x :=
by simpa only [div_eq_inv_mul, inv_inv] using integral_comp_add_mul f (inv_ne_zero hc) d
@[simp] lemma inv_smul_integral_comp_add_div (c d) :
  c‚Åª¬π ‚Ä¢ ‚à´ x in a..b, f (d + x / c) = ‚à´ x in d+a/c..d+b/c, f x :=
by by_cases hc : c = 0; simp [hc]
@[simp] lemma integral_comp_mul_sub (hc : c ‚â† 0) (d) :
  ‚à´ x in a..b, f (c * x - d) = c‚Åª¬π ‚Ä¢ ‚à´ x in c*a-d..c*b-d, f x :=
by simpa only [sub_eq_add_neg] using integral_comp_mul_add f hc (-d)
@[simp] lemma smul_integral_comp_mul_sub (c d) :
  c ‚Ä¢ ‚à´ x in a..b, f (c * x - d) = ‚à´ x in c*a-d..c*b-d, f x  :=
by by_cases hc : c = 0; simp [hc]
@[simp] lemma integral_comp_sub_mul (hc : c ‚â† 0) (d) :
  ‚à´ x in a..b, f (d - c * x) = c‚Åª¬π ‚Ä¢ ‚à´ x in d-c*b..d-c*a, f x :=
begin
  simp only [sub_eq_add_neg, neg_mul_eq_neg_mul],
  rw [integral_comp_add_mul f (neg_ne_zero.mpr hc) d, integral_symm],
  simp only [inv_neg, smul_neg, neg_neg, neg_smul],
end
@[simp] lemma smul_integral_comp_sub_mul (c d) :
  c ‚Ä¢ ‚à´ x in a..b, f (d - c * x) = ‚à´ x in d-c*b..d-c*a, f x  :=
by by_cases hc : c = 0; simp [hc]
@[simp] lemma integral_comp_div_sub (hc : c ‚â† 0) (d) :
  ‚à´ x in a..b, f (x / c - d) = c ‚Ä¢ ‚à´ x in a/c-d..b/c-d, f x :=
by simpa only [div_eq_inv_mul, inv_inv] using integral_comp_mul_sub f (inv_ne_zero hc) d
@[simp] lemma inv_smul_integral_comp_div_sub (c d) :
  c‚Åª¬π ‚Ä¢ ‚à´ x in a..b, f (x / c - d) = ‚à´ x in a/c-d..b/c-d, f x  :=
by by_cases hc : c = 0; simp [hc]
@[simp] lemma integral_comp_sub_div (hc : c ‚â† 0) (d) :
  ‚à´ x in a..b, f (d - x / c) = c ‚Ä¢ ‚à´ x in d-b/c..d-a/c, f x :=
by simpa only [div_eq_inv_mul, inv_inv] using integral_comp_sub_mul f (inv_ne_zero hc) d
@[simp] lemma inv_smul_integral_comp_sub_div (c d) :
  c‚Åª¬π ‚Ä¢ ‚à´ x in a..b, f (d - x / c) = ‚à´ x in d-b/c..d-a/c, f x :=
by by_cases hc : c = 0; simp [hc]
@[simp] lemma integral_comp_sub_right (d) :
  ‚à´ x in a..b, f (x - d) = ‚à´ x in a-d..b-d, f x :=
by simpa only [sub_eq_add_neg] using integral_comp_add_right f (-d)
@[simp] lemma integral_comp_sub_left (d) :
  ‚à´ x in a..b, f (d - x) = ‚à´ x in d-b..d-a, f x :=
by simpa only [one_mul, one_smul, inv_one] using integral_comp_sub_mul f one_ne_zero d
@[simp] lemma integral_comp_neg : ‚à´ x in a..b, f (-x) = ‚à´ x in -b..-a, f x :=
by simpa only [zero_sub] using integral_comp_sub_left f 0
end comp
section order_closed_topology
variables {a b c d : ‚Ñù} {f g : ‚Ñù ‚Üí E} {Œº : measure ‚Ñù}
lemma integral_congr {a b : ‚Ñù} (h : eq_on f g [a, b]) :
  ‚à´ x in a..b, f x ‚àÇŒº = ‚à´ x in a..b, g x ‚àÇŒº :=
by cases le_total a b with hab hab; simpa [hab, integral_of_le, integral_of_ge]
  using set_integral_congr measurable_set_Ioc (h.mono Ioc_subset_Icc_self)
lemma integral_add_adjacent_intervals_cancel (hab : interval_integrable f Œº a b)
  (hbc : interval_integrable f Œº b c) :
  ‚à´ x in a..b, f x ‚àÇŒº + ‚à´ x in b..c, f x ‚àÇŒº + ‚à´ x in c..a, f x ‚àÇŒº = 0 :=
begin
  have hac := hab.trans hbc,
  simp only [interval_integral, sub_add_sub_comm, sub_eq_zero],
  iterate 4 { rw ‚Üê integral_union },
  { suffices : Ioc a b ‚à™ Ioc b c ‚à™ Ioc c a = Ioc b a ‚à™ Ioc c b ‚à™ Ioc a c, by rw this,
    rw [Ioc_union_Ioc_union_Ioc_cycle, union_right_comm, Ioc_union_Ioc_union_Ioc_cycle,
      min_left_comm, max_left_comm] },
  all_goals { simp [*, measurable_set.union, measurable_set_Ioc, Ioc_disjoint_Ioc_same,
    Ioc_disjoint_Ioc_same.symm, hab.1, hab.2, hbc.1, hbc.2, hac.1, hac.2] }
end
lemma integral_add_adjacent_intervals (hab : interval_integrable f Œº a b)
  (hbc : interval_integrable f Œº b c) :
  ‚à´ x in a..b, f x ‚àÇŒº + ‚à´ x in b..c, f x ‚àÇŒº = ‚à´ x in a..c, f x ‚àÇŒº :=
by rw [‚Üê add_neg_eq_zero, ‚Üê integral_symm, integral_add_adjacent_intervals_cancel hab hbc]
lemma sum_integral_adjacent_intervals_Ico {a : ‚Ñï ‚Üí ‚Ñù} {m n : ‚Ñï} (hmn : m ‚â§ n)
  (hint : ‚àÄ k ‚àà Ico m n, interval_integrable f Œº (a k) (a $ k+1)) :
  ‚àë (k : ‚Ñï) in finset.Ico m n, ‚à´ x in (a k)..(a $ k+1), f x ‚àÇŒº = ‚à´ x in (a m)..(a n), f x ‚àÇŒº :=
begin
  revert hint,
  refine nat.le_induction _ _ n hmn,
  { simp },
  { assume p hmp IH h,
    rw [finset.sum_Ico_succ_top hmp, IH, integral_add_adjacent_intervals],
    { apply interval_integrable.trans_iterate_Ico hmp (Œª k hk, h k _),
      exact (Ico_subset_Ico le_rfl (nat.le_succ _)) hk },
    { apply h,
      simp [hmp] },
    { assume k hk,
      exact h _ (Ico_subset_Ico_right p.le_succ hk) } }
end
lemma sum_integral_adjacent_intervals {a : ‚Ñï ‚Üí ‚Ñù} {n : ‚Ñï}
  (hint : ‚àÄ k < n, interval_integrable f Œº (a k) (a $ k+1)) :
  ‚àë (k : ‚Ñï) in finset.range n, ‚à´ x in (a k)..(a $ k+1), f x ‚àÇŒº = ‚à´ x in (a 0)..(a n), f x ‚àÇŒº :=
begin
  rw ‚Üê nat.Ico_zero_eq_range,
  exact sum_integral_adjacent_intervals_Ico (zero_le n) (Œª k hk, hint k hk.2),
end
lemma integral_interval_sub_left (hab : interval_integrable f Œº a b)
  (hac : interval_integrable f Œº a c) :
  ‚à´ x in a..b, f x ‚àÇŒº - ‚à´ x in a..c, f x ‚àÇŒº = ‚à´ x in c..b, f x ‚àÇŒº :=
sub_eq_of_eq_add' $ eq.symm $ integral_add_adjacent_intervals hac (hac.symm.trans hab)
lemma integral_interval_add_interval_comm (hab : interval_integrable f Œº a b)
  (hcd : interval_integrable f Œº c d) (hac : interval_integrable f Œº a c) :
  ‚à´ x in a..b, f x ‚àÇŒº + ‚à´ x in c..d, f x ‚àÇŒº = ‚à´ x in a..d, f x ‚àÇŒº + ‚à´ x in c..b, f x ‚àÇŒº :=
by rw [‚Üê integral_add_adjacent_intervals hac hcd, add_assoc, add_left_comm,
  integral_add_adjacent_intervals hac (hac.symm.trans hab), add_comm]
lemma integral_interval_sub_interval_comm (hab : interval_integrable f Œº a b)
  (hcd : interval_integrable f Œº c d) (hac : interval_integrable f Œº a c) :
  ‚à´ x in a..b, f x ‚àÇŒº - ‚à´ x in c..d, f x ‚àÇŒº = ‚à´ x in a..c, f x ‚àÇŒº - ‚à´ x in b..d, f x ‚àÇŒº :=
by simp only [sub_eq_add_neg, ‚Üê integral_symm,
  integral_interval_add_interval_comm hab hcd.symm (hac.trans hcd)]
lemma integral_interval_sub_interval_comm' (hab : interval_integrable f Œº a b)
  (hcd : interval_integrable f Œº c d) (hac : interval_integrable f Œº a c) :
  ‚à´ x in a..b, f x ‚àÇŒº - ‚à´ x in c..d, f x ‚àÇŒº = ‚à´ x in d..b, f x ‚àÇŒº - ‚à´ x in c..a, f x ‚àÇŒº :=
by { rw [integral_interval_sub_interval_comm hab hcd hac, integral_symm b d, integral_symm a c,
  sub_neg_eq_add, sub_eq_neg_add], }
lemma integral_Iic_sub_Iic (ha : integrable_on f (Iic a) Œº) (hb : integrable_on f (Iic b) Œº) :
  ‚à´ x in Iic b, f x ‚àÇŒº - ‚à´ x in Iic a, f x ‚àÇŒº = ‚à´ x in a..b, f x ‚àÇŒº :=
begin
  wlog hab : a ‚â§ b using [a b] tactic.skip,
  { rw [sub_eq_iff_eq_add', integral_of_le hab, ‚Üê integral_union (Iic_disjoint_Ioc le_rfl),
      Iic_union_Ioc_eq_Iic hab],
    exacts [measurable_set_Ioc, ha, hb.mono_set (Œª _, and.right)] },
  { intros ha hb,
    rw [integral_symm, ‚Üê this hb ha, neg_sub] }
end
lemma integral_const_of_cdf [is_finite_measure Œº] (c : E) :
  ‚à´ x in a..b, c ‚àÇŒº = ((Œº (Iic b)).to_real - (Œº (Iic a)).to_real) ‚Ä¢ c :=
begin
  simp only [sub_smul, ‚Üê set_integral_const],
  refine (integral_Iic_sub_Iic _ _).symm;
    simp only [integrable_on_const, measure_lt_top, or_true]
end
lemma integral_eq_integral_of_support_subset {a b} (h : support f ‚äÜ Ioc a b) :
  ‚à´ x in a..b, f x ‚àÇŒº = ‚à´ x, f x ‚àÇŒº :=
begin
  cases le_total a b with hab hab,
  { rw [integral_of_le hab, ‚Üê integral_indicator measurable_set_Ioc, indicator_eq_self.2 h];
    apply_instance },
  { rw [Ioc_eq_empty hab.not_lt, subset_empty_iff, support_eq_empty_iff] at h,
    simp [h] }
end
lemma integral_congr_ae' (h : ‚àÄ·µê x ‚àÇŒº, x ‚àà Ioc a b ‚Üí f x = g x)
  (h' : ‚àÄ·µê x ‚àÇŒº, x ‚àà Ioc b a ‚Üí f x = g x) :
  ‚à´ x in a..b, f x ‚àÇŒº = ‚à´ x in a..b, g x ‚àÇŒº :=
by simp only [interval_integral, set_integral_congr_ae (measurable_set_Ioc) h,
              set_integral_congr_ae (measurable_set_Ioc) h']
lemma integral_congr_ae (h : ‚àÄ·µê x ‚àÇŒº, x ‚àà Œô a b ‚Üí f x = g x) :
  ‚à´ x in a..b, f x ‚àÇŒº = ‚à´ x in a..b, g x ‚àÇŒº :=
integral_congr_ae' (ae_interval_oc_iff.mp h).1 (ae_interval_oc_iff.mp h).2
lemma integral_zero_ae (h : ‚àÄ·µê x ‚àÇŒº, x ‚àà Œô a b ‚Üí f x = 0) :
  ‚à´ x in a..b, f x ‚àÇŒº = 0 :=
calc ‚à´ x in a..b, f x ‚àÇŒº = ‚à´ x in a..b, 0 ‚àÇŒº : integral_congr_ae h
                     ... = 0                 : integral_zero
lemma integral_indicator {a‚ÇÅ a‚ÇÇ a‚ÇÉ : ‚Ñù} (h : a‚ÇÇ ‚àà Icc a‚ÇÅ a‚ÇÉ) :
  ‚à´ x in a‚ÇÅ..a‚ÇÉ, indicator {x | x ‚â§ a‚ÇÇ} f x ‚àÇ Œº = ‚à´ x in a‚ÇÅ..a‚ÇÇ, f x ‚àÇ Œº :=
begin
  have : {x | x ‚â§ a‚ÇÇ} ‚à© Ioc a‚ÇÅ a‚ÇÉ = Ioc a‚ÇÅ a‚ÇÇ, from Iic_inter_Ioc_of_le h.2,
  rw [integral_of_le h.1, integral_of_le (h.1.trans h.2),
      integral_indicator, measure.restrict_restrict, this],
  exact measurable_set_Iic,
  all_goals { apply measurable_set_Iic },
end
lemma tendsto_integral_filter_of_dominated_convergence {Œπ} {l : filter Œπ}
  [l.is_countably_generated] {F : Œπ ‚Üí ‚Ñù ‚Üí E} (bound : ‚Ñù ‚Üí ‚Ñù)
  (hF_meas : ‚àÄ·∂† n in l, ae_strongly_measurable (F n) (Œº.restrict (Œô a b)))
  (h_bound : ‚àÄ·∂† n in l, ‚àÄ·µê x ‚àÇŒº, x ‚àà Œô a b ‚Üí ‚à•F n x‚à• ‚â§ bound x)
  (bound_integrable : interval_integrable bound Œº a b)
  (h_lim : ‚àÄ·µê x ‚àÇŒº, x ‚àà Œô a b ‚Üí tendsto (Œª n, F n x) l (ùìù (f x))) :
  tendsto (Œªn, ‚à´ x in a..b, F n x ‚àÇŒº) l (ùìù $ ‚à´ x in a..b, f x ‚àÇŒº) :=
begin
  simp only [interval_integrable_iff, interval_integral_eq_integral_interval_oc,
    ‚Üê ae_restrict_iff' measurable_set_interval_oc] at *,
  exact tendsto_const_nhds.smul
    (tendsto_integral_filter_of_dominated_convergence bound hF_meas h_bound bound_integrable h_lim)
end
lemma has_sum_integral_of_dominated_convergence {Œπ} [encodable Œπ]
  {F : Œπ ‚Üí ‚Ñù ‚Üí E} (bound : Œπ ‚Üí ‚Ñù ‚Üí ‚Ñù)
  (hF_meas : ‚àÄ n, ae_strongly_measurable (F n) (Œº.restrict (Œô a b)))
  (h_bound : ‚àÄ n, ‚àÄ·µê t ‚àÇŒº, t ‚àà Œô a b ‚Üí ‚à•F n t‚à• ‚â§ bound n t)
  (bound_summable : ‚àÄ·µê t ‚àÇŒº, t ‚àà Œô a b ‚Üí summable (Œª n, bound n t))
  (bound_integrable : interval_integrable (Œª t, ‚àë' n, bound n t) Œº a b)
  (h_lim : ‚àÄ·µê t ‚àÇŒº, t ‚àà Œô a b ‚Üí has_sum (Œª n, F n t) (f t)) :
  has_sum (Œªn, ‚à´ t in a..b, F n t ‚àÇŒº) (‚à´ t in a..b, f t ‚àÇŒº) :=
begin
  simp only [interval_integrable_iff, interval_integral_eq_integral_interval_oc,
    ‚Üê ae_restrict_iff' measurable_set_interval_oc] at *,
  exact (has_sum_integral_of_dominated_convergence bound hF_meas h_bound bound_summable
    bound_integrable h_lim).const_smul
end
open topological_space
variables {X : Type*} [topological_space X] [first_countable_topology X]
lemma continuous_within_at_of_dominated_interval
  {F : X ‚Üí ‚Ñù ‚Üí E} {x‚ÇÄ : X} {bound : ‚Ñù ‚Üí ‚Ñù} {a b : ‚Ñù} {s : set X}
  (hF_meas : ‚àÄ·∂† x in ùìù[s] x‚ÇÄ, ae_strongly_measurable (F x) (Œº.restrict $ Œô a b))
  (h_bound : ‚àÄ·∂† x in ùìù[s] x‚ÇÄ, ‚àÄ·µê t ‚àÇŒº, t ‚àà Œô a b ‚Üí ‚à•F x t‚à• ‚â§ bound t)
  (bound_integrable : interval_integrable bound Œº a b)
  (h_cont : ‚àÄ·µê t ‚àÇŒº, t ‚àà Œô a b ‚Üí continuous_within_at (Œª x, F x t) s x‚ÇÄ) :
  continuous_within_at (Œª x, ‚à´ t in a..b, F x t ‚àÇŒº) s x‚ÇÄ :=
tendsto_integral_filter_of_dominated_convergence bound hF_meas h_bound bound_integrable h_cont
lemma continuous_at_of_dominated_interval
  {F : X ‚Üí ‚Ñù ‚Üí E} {x‚ÇÄ : X} {bound : ‚Ñù ‚Üí ‚Ñù} {a b : ‚Ñù}
  (hF_meas : ‚àÄ·∂† x in ùìù x‚ÇÄ, ae_strongly_measurable (F x) (Œº.restrict $ Œô a b))
  (h_bound : ‚àÄ·∂† x in ùìù x‚ÇÄ, ‚àÄ·µê t ‚àÇŒº, t ‚àà Œô a b ‚Üí ‚à•F x t‚à• ‚â§ bound t)
  (bound_integrable : interval_integrable bound Œº a b)
  (h_cont : ‚àÄ·µê t ‚àÇŒº, t ‚àà Œô a b ‚Üí continuous_at (Œª x, F x t) x‚ÇÄ) :
  continuous_at (Œª x, ‚à´ t in a..b, F x t ‚àÇŒº) x‚ÇÄ :=
tendsto_integral_filter_of_dominated_convergence bound hF_meas h_bound bound_integrable h_cont
lemma continuous_of_dominated_interval {F : X ‚Üí ‚Ñù ‚Üí E} {bound : ‚Ñù ‚Üí ‚Ñù} {a b : ‚Ñù}
  (hF_meas : ‚àÄ x, ae_strongly_measurable (F x) $ Œº.restrict $ Œô a b)
  (h_bound : ‚àÄ x, ‚àÄ·µê t ‚àÇŒº, t ‚àà Œô a b ‚Üí ‚à•F x t‚à• ‚â§ bound t)
  (bound_integrable : interval_integrable bound Œº a b)
  (h_cont : ‚àÄ·µê t ‚àÇŒº, t ‚àà Œô a b ‚Üí continuous (Œª x, F x t)) :
  continuous (Œª x, ‚à´ t in a..b, F x t ‚àÇŒº) :=
continuous_iff_continuous_at.mpr (Œª x‚ÇÄ, continuous_at_of_dominated_interval
  (eventually_of_forall hF_meas) (eventually_of_forall h_bound) bound_integrable $ h_cont.mono $
  Œª x himp hx, (himp hx).continuous_at)
end order_closed_topology
section continuous_primitive
open topological_space
variables {a b b‚ÇÄ b‚ÇÅ b‚ÇÇ : ‚Ñù} {Œº : measure ‚Ñù} {f g : ‚Ñù ‚Üí E}
lemma continuous_within_at_primitive (hb‚ÇÄ : Œº {b‚ÇÄ} = 0)
  (h_int : interval_integrable f Œº (min a b‚ÇÅ) (max a b‚ÇÇ)) :
  continuous_within_at (Œª b, ‚à´ x in a .. b, f x ‚àÇ Œº) (Icc b‚ÇÅ b‚ÇÇ) b‚ÇÄ :=
begin
  by_cases h‚ÇÄ : b‚ÇÄ ‚àà Icc b‚ÇÅ b‚ÇÇ,
  { have h‚ÇÅ‚ÇÇ : b‚ÇÅ ‚â§ b‚ÇÇ := h‚ÇÄ.1.trans h‚ÇÄ.2,
    have min‚ÇÅ‚ÇÇ : min b‚ÇÅ b‚ÇÇ = b‚ÇÅ := min_eq_left h‚ÇÅ‚ÇÇ,
    have h_int' : ‚àÄ {x}, x ‚àà Icc b‚ÇÅ b‚ÇÇ ‚Üí interval_integrable f Œº b‚ÇÅ x,
    { rintros x ‚ü®h‚ÇÅ, h‚ÇÇ‚ü©,
      apply h_int.mono_set,
      apply interval_subset_interval,
      { exact ‚ü®min_le_of_left_le (min_le_right a b‚ÇÅ),
                h‚ÇÅ.trans (h‚ÇÇ.trans $ le_max_of_le_right $ le_max_right _ _)‚ü© },
      { exact ‚ü®min_le_of_left_le $ (min_le_right _ _).trans h‚ÇÅ,
                le_max_of_le_right $ h‚ÇÇ.trans $ le_max_right _ _‚ü© } },
    have : ‚àÄ b ‚àà Icc b‚ÇÅ b‚ÇÇ, ‚à´ x in a..b, f x ‚àÇŒº = ‚à´ x in a..b‚ÇÅ, f x ‚àÇŒº + ‚à´ x in b‚ÇÅ..b, f x ‚àÇŒº,
    { rintros b ‚ü®h‚ÇÅ, h‚ÇÇ‚ü©,
      rw ‚Üê integral_add_adjacent_intervals _ (h_int' ‚ü®h‚ÇÅ, h‚ÇÇ‚ü©),
      apply h_int.mono_set,
      apply interval_subset_interval,
      { exact ‚ü®min_le_of_left_le (min_le_left a b‚ÇÅ), le_max_of_le_right (le_max_left _ _)‚ü© },
      { exact ‚ü®min_le_of_left_le (min_le_right _ _),
                le_max_of_le_right (h‚ÇÅ.trans $ h‚ÇÇ.trans (le_max_right a b‚ÇÇ))‚ü© } },
    apply continuous_within_at.congr _ this (this _ h‚ÇÄ), clear this,
    refine continuous_within_at_const.add _,
    have : (Œª b, ‚à´ x in b‚ÇÅ..b, f x ‚àÇŒº) =·∂†[ùìù[Icc b‚ÇÅ b‚ÇÇ] b‚ÇÄ]
            Œª b, ‚à´ x in b‚ÇÅ..b‚ÇÇ, indicator {x | x ‚â§ b} f x ‚àÇ Œº,
    { apply eventually_eq_of_mem self_mem_nhds_within,
      exact Œª b b_in, (integral_indicator b_in).symm },
    apply continuous_within_at.congr_of_eventually_eq _ this (integral_indicator h‚ÇÄ).symm,
    have : interval_integrable (Œª x, ‚à•f x‚à•) Œº b‚ÇÅ b‚ÇÇ,
      from interval_integrable.norm (h_int' $ right_mem_Icc.mpr h‚ÇÅ‚ÇÇ),
    refine continuous_within_at_of_dominated_interval _ _ this _ ; clear this,
    { apply eventually.mono (self_mem_nhds_within),
      intros x hx,
      erw [ae_strongly_measurable_indicator_iff, measure.restrict_restrict, Iic_inter_Ioc_of_le],
      { rw min‚ÇÅ‚ÇÇ,
        exact (h_int' hx).1.ae_strongly_measurable },
      { exact le_max_of_le_right hx.2 },
      exacts [measurable_set_Iic, measurable_set_Iic] },
    { refine eventually_of_forall (Œª x, eventually_of_forall (Œª t, _)),
      dsimp [indicator],
      split_ifs ; simp },
    { have : ‚àÄ·µê t ‚àÇŒº, t < b‚ÇÄ ‚à® b‚ÇÄ < t,
      { apply eventually.mono (compl_mem_ae_iff.mpr hb‚ÇÄ),
        intros x hx,
        exact ne.lt_or_lt hx },
      apply this.mono,
      rintros x‚ÇÄ (hx‚ÇÄ | hx‚ÇÄ) -,
      { have : ‚àÄ·∂† x in ùìù[Icc b‚ÇÅ b‚ÇÇ] b‚ÇÄ, {t : ‚Ñù | t ‚â§ x}.indicator f x‚ÇÄ = f x‚ÇÄ,
        { apply mem_nhds_within_of_mem_nhds,
          apply eventually.mono (Ioi_mem_nhds hx‚ÇÄ),
          intros x hx,
          simp [hx.le] },
        apply continuous_within_at_const.congr_of_eventually_eq  this,
        simp [hx‚ÇÄ.le] },
      { have : ‚àÄ·∂† x in ùìù[Icc b‚ÇÅ b‚ÇÇ] b‚ÇÄ, {t : ‚Ñù | t ‚â§ x}.indicator f x‚ÇÄ = 0,
        { apply mem_nhds_within_of_mem_nhds,
          apply eventually.mono (Iio_mem_nhds hx‚ÇÄ),
          intros x hx,
          simp [hx] },
        apply continuous_within_at_const.congr_of_eventually_eq this,
        simp [hx‚ÇÄ] } } },
  { apply continuous_within_at_of_not_mem_closure,
    rwa [closure_Icc] }
end
lemma continuous_on_primitive [has_no_atoms Œº] (h_int : integrable_on f (Icc a b) Œº) :
  continuous_on (Œª x, ‚à´ t in Ioc a x, f t ‚àÇ Œº) (Icc a b) :=
begin
  by_cases h : a ‚â§ b,
  { have : ‚àÄ x ‚àà Icc a b, ‚à´ t in Ioc a x, f t ‚àÇŒº = ‚à´ t in a..x, f t ‚àÇŒº,
    { intros x x_in,
      simp_rw [‚Üê interval_oc_of_le h, integral_of_le x_in.1] },
    rw continuous_on_congr this,
    intros x‚ÇÄ hx‚ÇÄ,
    refine continuous_within_at_primitive (measure_singleton x‚ÇÄ) _,
    simp only [interval_integrable_iff_integrable_Ioc_of_le, min_eq_left, max_eq_right, h],
    exact h_int.mono Ioc_subset_Icc_self le_rfl },
  { rw Icc_eq_empty h,
    exact continuous_on_empty _ },
end
lemma continuous_on_primitive_Icc [has_no_atoms Œº] (h_int : integrable_on f (Icc a b) Œº) :
  continuous_on (Œª x, ‚à´ t in Icc a x, f t ‚àÇ Œº) (Icc a b) :=
begin
  rw show (Œª x, ‚à´ t in Icc a x, f t ‚àÇŒº) = Œª x, ‚à´ t in Ioc a x, f t ‚àÇŒº,
    by { ext x, exact integral_Icc_eq_integral_Ioc },
  exact continuous_on_primitive h_int
end
lemma continuous_on_primitive_interval' [has_no_atoms Œº]
  (h_int : interval_integrable f Œº b‚ÇÅ b‚ÇÇ) (ha : a ‚àà [b‚ÇÅ, b‚ÇÇ]) :
  continuous_on (Œª b, ‚à´ x in a..b, f x ‚àÇ Œº) [b‚ÇÅ, b‚ÇÇ] :=
begin
  intros b‚ÇÄ hb‚ÇÄ,
  refine continuous_within_at_primitive (measure_singleton _) _,
  rw [min_eq_right ha.1, max_eq_right ha.2],
  simpa [interval_integrable_iff, interval_oc] using h_int,
end
lemma continuous_on_primitive_interval [has_no_atoms Œº]
  (h_int : integrable_on f (interval a b) Œº) :
  continuous_on (Œª x, ‚à´ t in a..x, f t ‚àÇ Œº) (interval a b) :=
continuous_on_primitive_interval' h_int.interval_integrable left_mem_interval
lemma continuous_on_primitive_interval_left [has_no_atoms Œº]
  (h_int : integrable_on f (interval a b) Œº) :
  continuous_on (Œª x, ‚à´ t in x..b, f t ‚àÇ Œº) (interval a b) :=
begin
  rw interval_swap a b at h_int ‚ä¢,
  simp only [integral_symm b],
  exact (continuous_on_primitive_interval h_int).neg,
end
variables [has_no_atoms Œº]
lemma continuous_primitive (h_int : ‚àÄ a b, interval_integrable f Œº a b) (a : ‚Ñù) :
  continuous (Œª b, ‚à´ x in a..b, f x ‚àÇ Œº) :=
begin
  rw continuous_iff_continuous_at,
  intro b‚ÇÄ,
  cases exists_lt b‚ÇÄ with b‚ÇÅ hb‚ÇÅ,
  cases exists_gt b‚ÇÄ with b‚ÇÇ hb‚ÇÇ,
  apply continuous_within_at.continuous_at _ (Icc_mem_nhds hb‚ÇÅ hb‚ÇÇ),
  exact continuous_within_at_primitive (measure_singleton b‚ÇÄ) (h_int _ _)
end
lemma _root_.measure_theory.integrable.continuous_primitive (h_int : integrable f Œº) (a : ‚Ñù) :
  continuous (Œª b, ‚à´ x in a..b, f x ‚àÇ Œº) :=
continuous_primitive (Œª _ _, h_int.interval_integrable) a
end continuous_primitive
section
variables {f g : ‚Ñù ‚Üí ‚Ñù} {a b : ‚Ñù} {Œº : measure ‚Ñù}
lemma integral_eq_zero_iff_of_le_of_nonneg_ae (hab : a ‚â§ b)
  (hf : 0 ‚â§·µê[Œº.restrict (Ioc a b)] f) (hfi : interval_integrable f Œº a b) :
  ‚à´ x in a..b, f x ‚àÇŒº = 0 ‚Üî f =·µê[Œº.restrict (Ioc a b)] 0 :=
by rw [integral_of_le hab, integral_eq_zero_iff_of_nonneg_ae hf hfi.1]
lemma integral_eq_zero_iff_of_nonneg_ae
  (hf : 0 ‚â§·µê[Œº.restrict (Ioc a b ‚à™ Ioc b a)] f) (hfi : interval_integrable f Œº a b) :
  ‚à´ x in a..b, f x ‚àÇŒº = 0 ‚Üî f =·µê[Œº.restrict (Ioc a b ‚à™ Ioc b a)] 0 :=
begin
  cases le_total a b with hab hab;
    simp only [Ioc_eq_empty hab.not_lt, empty_union, union_empty] at hf ‚ä¢,
  { exact integral_eq_zero_iff_of_le_of_nonneg_ae hab hf hfi },
  { rw [integral_symm, neg_eq_zero, integral_eq_zero_iff_of_le_of_nonneg_ae hab hf hfi.symm] }
end
lemma integral_pos_iff_support_of_nonneg_ae'
  (hf : 0 ‚â§·µê[Œº.restrict (Œô a b)] f) (hfi : interval_integrable f Œº a b) :
  0 < ‚à´ x in a..b, f x ‚àÇŒº ‚Üî a < b ‚àß 0 < Œº (support f ‚à© Ioc a b) :=
begin
  cases lt_or_le a b with hab hba,
  { rw interval_oc_of_le hab.le at hf,
    simp only [hab, true_and, integral_of_le hab.le,
      set_integral_pos_iff_support_of_nonneg_ae hf hfi.1] },
  { suffices : ‚à´ x in a..b, f x ‚àÇŒº ‚â§ 0, by simp only [this.not_lt, hba.not_lt, false_and],
    rw [integral_of_ge hba, neg_nonpos],
    rw [interval_oc_swap, interval_oc_of_le hba] at hf,
    exact integral_nonneg_of_ae hf }
end
lemma integral_pos_iff_support_of_nonneg_ae (hf : 0 ‚â§·µê[Œº] f) (hfi : interval_integrable f Œº a b) :
  0 < ‚à´ x in a..b, f x ‚àÇŒº ‚Üî a < b ‚àß 0 < Œº (support f ‚à© Ioc a b) :=
integral_pos_iff_support_of_nonneg_ae' (ae_mono measure.restrict_le_self hf) hfi
lemma interval_integral_pos_of_pos {f : ‚Ñù ‚Üí ‚Ñù} {a b : ‚Ñù}
  (hfi : interval_integrable f measure_space.volume a b) (h : ‚àÄ x, 0 < f x) (hab : a < b) :
  0 < ‚à´ x in a..b, f x :=
begin
  have hsupp : support f = univ := eq_univ_iff_forall.mpr (Œª t, (h t).ne.symm),
  replace h‚ÇÄ : 0 ‚â§·µê[volume] f := eventually_of_forall (Œª x, (h x).le),
  rw integral_pos_iff_support_of_nonneg_ae h‚ÇÄ hfi,
  exact ‚ü®hab, by simp [hsupp, hab]‚ü©,
end
lemma integral_lt_integral_of_ae_le_of_measure_set_of_lt_ne_zero (hab : a ‚â§ b)
  (hfi : interval_integrable f Œº a b) (hgi : interval_integrable g Œº a b)
  (hle : f ‚â§·µê[Œº.restrict (Ioc a b)] g) (hlt : Œº.restrict (Ioc a b) {x | f x < g x} ‚â† 0) :
  ‚à´ x in a..b, f x ‚àÇŒº < ‚à´ x in a..b, g x ‚àÇŒº :=
begin
  rw [‚Üê sub_pos, ‚Üê integral_sub hgi hfi, integral_of_le hab,
    measure_theory.integral_pos_iff_support_of_nonneg_ae],
  { refine pos_iff_ne_zero.2 (mt (measure_mono_null _) hlt),
    exact Œª x hx, (sub_pos.2 hx).ne' },
  exacts [hle.mono (Œª x, sub_nonneg.2), hgi.1.sub hfi.1]
end
lemma integral_lt_integral_of_continuous_on_of_le_of_exists_lt {f g : ‚Ñù ‚Üí ‚Ñù} {a b : ‚Ñù}
  (hab : a < b) (hfc : continuous_on f (Icc a b)) (hgc : continuous_on g (Icc a b))
  (hle : ‚àÄ x ‚àà Ioc a b, f x ‚â§ g x) (hlt : ‚àÉ c ‚àà Icc a b, f c < g c) :
  ‚à´ x in a..b, f x < ‚à´ x in a..b, g x :=
begin
  refine integral_lt_integral_of_ae_le_of_measure_set_of_lt_ne_zero hab.le
    (hfc.interval_integrable_of_Icc hab.le) (hgc.interval_integrable_of_Icc hab.le)
    ((ae_restrict_mem measurable_set_Ioc).mono hle) _,
  contrapose! hlt,
  have h_eq : f =·µê[volume.restrict (Ioc a b)] g,
  { simp only [‚Üê not_le, ‚Üê ae_iff] at hlt,
    exact eventually_le.antisymm ((ae_restrict_iff' measurable_set_Ioc).2 $
      eventually_of_forall hle) hlt },
  simp only [measure.restrict_congr_set Ioc_ae_eq_Icc] at h_eq,
  exact Œª c hc, (measure.eq_on_Icc_of_ae_eq volume hab.ne h_eq hfc hgc hc).ge
end
lemma integral_nonneg_of_ae_restrict (hab : a ‚â§ b) (hf : 0 ‚â§·µê[Œº.restrict (Icc a b)] f) :
  0 ‚â§ (‚à´ u in a..b, f u ‚àÇŒº) :=
let H := ae_restrict_of_ae_restrict_of_subset Ioc_subset_Icc_self hf in
by simpa only [integral_of_le hab] using set_integral_nonneg_of_ae_restrict H
lemma integral_nonneg_of_ae (hab : a ‚â§ b) (hf : 0 ‚â§·µê[Œº] f) :
  0 ‚â§ (‚à´ u in a..b, f u ‚àÇŒº) :=
integral_nonneg_of_ae_restrict hab $ ae_restrict_of_ae hf
lemma integral_nonneg_of_forall (hab : a ‚â§ b) (hf : ‚àÄ u, 0 ‚â§ f u) :
  0 ‚â§ (‚à´ u in a..b, f u ‚àÇŒº) :=
integral_nonneg_of_ae hab $ eventually_of_forall hf
lemma integral_nonneg (hab : a ‚â§ b) (hf : ‚àÄ u, u ‚àà Icc a b ‚Üí 0 ‚â§ f u) :
  0 ‚â§ (‚à´ u in a..b, f u ‚àÇŒº) :=
integral_nonneg_of_ae_restrict hab $ (ae_restrict_iff' measurable_set_Icc).mpr $ ae_of_all Œº hf
lemma abs_integral_le_integral_abs (hab : a ‚â§ b) :
  |‚à´ x in a..b, f x ‚àÇŒº| ‚â§ ‚à´ x in a..b, |f x| ‚àÇŒº :=
by simpa only [‚Üê real.norm_eq_abs] using norm_integral_le_integral_norm hab
section mono
variables (hab : a ‚â§ b) (hf : interval_integrable f Œº a b) (hg : interval_integrable g Œº a b)
include hab hf hg
lemma integral_mono_ae_restrict (h : f ‚â§·µê[Œº.restrict (Icc a b)] g) :
  ‚à´ u in a..b, f u ‚àÇŒº ‚â§ ‚à´ u in a..b, g u ‚àÇŒº :=
let H := h.filter_mono $ ae_mono $ measure.restrict_mono Ioc_subset_Icc_self $ le_refl Œº in
by simpa only [integral_of_le hab] using set_integral_mono_ae_restrict hf.1 hg.1 H
lemma integral_mono_ae (h : f ‚â§·µê[Œº] g) :
  ‚à´ u in a..b, f u ‚àÇŒº ‚â§ ‚à´ u in a..b, g u ‚àÇŒº :=
by simpa only [integral_of_le hab] using set_integral_mono_ae hf.1 hg.1 h
lemma integral_mono_on (h : ‚àÄ x ‚àà Icc a b, f x ‚â§ g x) :
  ‚à´ u in a..b, f u ‚àÇŒº ‚â§ ‚à´ u in a..b, g u ‚àÇŒº :=
let H := Œª x hx, h x $ Ioc_subset_Icc_self hx in
by simpa only [integral_of_le hab] using set_integral_mono_on hf.1 hg.1 measurable_set_Ioc H
lemma integral_mono (h : f ‚â§ g) :
  ‚à´ u in a..b, f u ‚àÇŒº ‚â§ ‚à´ u in a..b, g u ‚àÇŒº :=
integral_mono_ae hab hf hg $ ae_of_all _ h
omit hg hab
lemma integral_mono_interval {c d} (hca : c ‚â§ a) (hab : a ‚â§ b) (hbd : b ‚â§ d)
  (hf : 0 ‚â§·µê[Œº.restrict (Ioc c d)] f) (hfi : interval_integrable f Œº c d):
  ‚à´ x in a..b, f x ‚àÇŒº ‚â§ ‚à´ x in c..d, f x ‚àÇŒº :=
begin
  rw [integral_of_le hab, integral_of_le (hca.trans (hab.trans hbd))],
  exact set_integral_mono_set hfi.1 hf (Ioc_subset_Ioc hca hbd).eventually_le
end
lemma abs_integral_mono_interval {c d } (h : Œô a b ‚äÜ Œô c d)
  (hf : 0 ‚â§·µê[Œº.restrict (Œô c d)] f) (hfi : interval_integrable f Œº c d) :
  |‚à´ x in a..b, f x ‚àÇŒº| ‚â§ |‚à´ x in c..d, f x ‚àÇŒº| :=
have hf' : 0 ‚â§·µê[Œº.restrict (Œô a b)] f, from ae_mono (measure.restrict_mono h le_rfl) hf,
calc |‚à´ x in a..b, f x ‚àÇŒº| = |‚à´ x in Œô a b, f x ‚àÇŒº| : abs_integral_eq_abs_integral_interval_oc f
... = ‚à´ x in Œô a b, f x ‚àÇŒº : abs_of_nonneg (measure_theory.integral_nonneg_of_ae hf')
... ‚â§ ‚à´ x in Œô c d, f x ‚àÇŒº : set_integral_mono_set hfi.def hf h.eventually_le
... ‚â§ |‚à´ x in Œô c d, f x ‚àÇŒº| : le_abs_self _
... = |‚à´ x in c..d, f x ‚àÇŒº| : (abs_integral_eq_abs_integral_interval_oc f).symm
end mono
end
class FTC_filter (a : out_param ‚Ñù) (outer : filter ‚Ñù) (inner : out_param $ filter ‚Ñù)
  extends tendsto_Ixx_class Ioc outer inner : Prop :=
(pure_le : pure a ‚â§ outer)
(le_nhds : inner ‚â§ ùìù a)
[meas_gen : is_measurably_generated inner]
attribute [nolint dangerous_instance] FTC_filter.to_tendsto_Ixx_class
namespace FTC_filter
instance pure (a : ‚Ñù) : FTC_filter a (pure a) ‚ä• :=
{ pure_le := le_rfl,
  le_nhds := bot_le }
instance nhds_within_singleton (a : ‚Ñù) : FTC_filter a (ùìù[{a}] a) ‚ä• :=
by { rw [nhds_within, principal_singleton, inf_eq_right.2 (pure_le_nhds a)], apply_instance }
lemma finite_at_inner {a : ‚Ñù} (l : filter ‚Ñù) {l'} [h : FTC_filter a l l']
  {Œº : measure ‚Ñù} [is_locally_finite_measure Œº] :
  Œº.finite_at_filter l' :=
(Œº.finite_at_nhds a).filter_mono h.le_nhds
instance nhds (a : ‚Ñù) : FTC_filter a (ùìù a) (ùìù a) :=
{ pure_le := pure_le_nhds a,
  le_nhds := le_rfl }
instance nhds_univ (a : ‚Ñù) : FTC_filter a (ùìù[univ] a) (ùìù a) :=
by { rw nhds_within_univ, apply_instance }
instance nhds_left (a : ‚Ñù) : FTC_filter a (ùìù[‚â§] a) (ùìù[‚â§] a) :=
{ pure_le := pure_le_nhds_within right_mem_Iic,
  le_nhds := inf_le_left }
instance nhds_right (a : ‚Ñù) : FTC_filter a (ùìù[‚â•] a) (ùìù[>] a) :=
{ pure_le := pure_le_nhds_within left_mem_Ici,
  le_nhds := inf_le_left }
instance nhds_Icc {x a b : ‚Ñù} [h : fact (x ‚àà Icc a b)] :
  FTC_filter x (ùìù[Icc a b] x) (ùìù[Icc a b] x) :=
{ pure_le := pure_le_nhds_within h.out,
  le_nhds := inf_le_left }
instance nhds_interval {x a b : ‚Ñù} [h : fact (x ‚àà [a, b])] :
  FTC_filter x (ùìù[[a, b]] x) (ùìù[[a, b]] x) :=
by { haveI : fact (x ‚àà set.Icc (min a b) (max a b)) := h, exact FTC_filter.nhds_Icc }
end FTC_filter
open asymptotics
section
variables {f : ‚Ñù ‚Üí E} {a b : ‚Ñù} {c ca cb : E} {l l' la la' lb lb' : filter ‚Ñù} {lt : filter Œπ}
  {Œº : measure ‚Ñù} {u v ua va ub vb : Œπ ‚Üí ‚Ñù}
lemma measure_integral_sub_linear_is_o_of_tendsto_ae'
  [is_measurably_generated l'] [tendsto_Ixx_class Ioc l l']
  (hfm : strongly_measurable_at_filter f l' Œº) (hf : tendsto f (l' ‚äì Œº.ae) (ùìù c))
  (hl : Œº.finite_at_filter l')
  (hu : tendsto u lt l) (hv : tendsto v lt l) :
  (Œª t, ‚à´ x in u t..v t, f x ‚àÇŒº - ‚à´ x in u t..v t, c ‚àÇŒº) =o[lt] (Œª t, ‚à´ x in u t..v t, (1:‚Ñù) ‚àÇŒº) :=
begin
  have A := hf.integral_sub_linear_is_o_ae hfm hl (hu.Ioc hv),
  have B := hf.integral_sub_linear_is_o_ae hfm hl (hv.Ioc hu),
  simp only [integral_const'],
  convert (A.trans_le _).sub (B.trans_le _),
  { ext t,
    simp_rw [interval_integral, sub_smul],
    abel },
  all_goals { intro t, cases le_total (u t) (v t) with huv huv; simp [huv] }
end
lemma measure_integral_sub_linear_is_o_of_tendsto_ae_of_le'
  [is_measurably_generated l'] [tendsto_Ixx_class Ioc l l']
  (hfm : strongly_measurable_at_filter f l' Œº) (hf : tendsto f (l' ‚äì Œº.ae) (ùìù c))
  (hl : Œº.finite_at_filter l') (hu : tendsto u lt l) (hv : tendsto v lt l) (huv : u ‚â§·∂†[lt] v) :
  (Œª t, ‚à´ x in u t..v t, f x ‚àÇŒº - (Œº (Ioc (u t) (v t))).to_real ‚Ä¢ c) =o[lt]
    (Œª t, (Œº $ Ioc (u t) (v t)).to_real) :=
(measure_integral_sub_linear_is_o_of_tendsto_ae' hfm hf hl hu hv).congr'
  (huv.mono $ Œª x hx, by simp [integral_const', hx])
  (huv.mono $ Œª x hx, by simp [integral_const', hx])
lemma measure_integral_sub_linear_is_o_of_tendsto_ae_of_ge'
  [is_measurably_generated l'] [tendsto_Ixx_class Ioc l l']
  (hfm : strongly_measurable_at_filter f l' Œº) (hf : tendsto f (l' ‚äì Œº.ae) (ùìù c))
  (hl : Œº.finite_at_filter l') (hu : tendsto u lt l) (hv : tendsto v lt l) (huv : v ‚â§·∂†[lt] u) :
  (Œª t, ‚à´ x in u t..v t, f x ‚àÇŒº + (Œº (Ioc (v t) (u t))).to_real ‚Ä¢ c) =o[lt]
    (Œª t, (Œº $ Ioc (v t) (u t)).to_real) :=
(measure_integral_sub_linear_is_o_of_tendsto_ae_of_le' hfm hf hl hv hu huv).neg_left.congr_left $
  Œª t, by simp [integral_symm (u t), add_comm]
section
variables [is_locally_finite_measure Œº] [FTC_filter a l l']
include a
local attribute [instance] FTC_filter.meas_gen
lemma measure_integral_sub_linear_is_o_of_tendsto_ae (hfm : strongly_measurable_at_filter f l' Œº)
  (hf : tendsto f (l' ‚äì Œº.ae) (ùìù c)) (hu : tendsto u lt l) (hv : tendsto v lt l) :
  (Œª t, ‚à´ x in u t..v t, f x ‚àÇŒº - ‚à´ x in u t..v t, c ‚àÇŒº) =o[lt] (Œª t, ‚à´ x in u t..v t, (1:‚Ñù) ‚àÇŒº) :=
measure_integral_sub_linear_is_o_of_tendsto_ae' hfm hf (FTC_filter.finite_at_inner l) hu hv
lemma measure_integral_sub_linear_is_o_of_tendsto_ae_of_le
  (hfm : strongly_measurable_at_filter f l' Œº) (hf : tendsto f (l' ‚äì Œº.ae) (ùìù c))
  (hu : tendsto u lt l) (hv : tendsto v lt l) (huv : u ‚â§·∂†[lt] v) :
  (Œª t, ‚à´ x in u t..v t, f x ‚àÇŒº - (Œº (Ioc (u t) (v t))).to_real ‚Ä¢ c) =o[lt]
    (Œª t, (Œº $ Ioc (u t) (v t)).to_real) :=
measure_integral_sub_linear_is_o_of_tendsto_ae_of_le' hfm hf (FTC_filter.finite_at_inner l)
  hu hv huv
lemma measure_integral_sub_linear_is_o_of_tendsto_ae_of_ge
  (hfm : strongly_measurable_at_filter f l' Œº) (hf : tendsto f (l' ‚äì Œº.ae) (ùìù c))
  (hu : tendsto u lt l) (hv : tendsto v lt l) (huv : v ‚â§·∂†[lt] u) :
  (Œª t, ‚à´ x in u t..v t, f x ‚àÇŒº + (Œº (Ioc (v t) (u t))).to_real ‚Ä¢ c) =o[lt]
    (Œª t, (Œº $ Ioc (v t) (u t)).to_real) :=
measure_integral_sub_linear_is_o_of_tendsto_ae_of_ge' hfm hf (FTC_filter.finite_at_inner l)
  hu hv huv
end
local attribute [instance] FTC_filter.meas_gen
variables [FTC_filter a la la'] [FTC_filter b lb lb'] [is_locally_finite_measure Œº]
lemma measure_integral_sub_integral_sub_linear_is_o_of_tendsto_ae
  (hab : interval_integrable f Œº a b)
  (hmeas_a : strongly_measurable_at_filter f la' Œº)
  (hmeas_b : strongly_measurable_at_filter f lb' Œº)
  (ha_lim : tendsto f (la' ‚äì Œº.ae) (ùìù ca)) (hb_lim : tendsto f (lb' ‚äì Œº.ae) (ùìù cb))
  (hua : tendsto ua lt la) (hva : tendsto va lt la)
  (hub : tendsto ub lt lb) (hvb : tendsto vb lt lb) :
  (Œª t, (‚à´ x in va t..vb t, f x ‚àÇŒº) - (‚à´ x in ua t..ub t, f x ‚àÇŒº) -
    (‚à´ x in ub t..vb t, cb ‚àÇŒº - ‚à´ x in ua t..va t, ca ‚àÇŒº)) =o[lt]
    (Œª t, ‚à•‚à´ x in ua t..va t, (1:‚Ñù) ‚àÇŒº‚à• + ‚à•‚à´ x in ub t..vb t, (1:‚Ñù) ‚àÇŒº‚à•) :=
begin
  refine
    ((measure_integral_sub_linear_is_o_of_tendsto_ae hmeas_a ha_lim hua hva).neg_left.add_add
    (measure_integral_sub_linear_is_o_of_tendsto_ae hmeas_b hb_lim hub hvb)).congr'
      _ eventually_eq.rfl,
  have A : ‚àÄ·∂† t in lt, interval_integrable f Œº (ua t) (va t) :=
    ha_lim.eventually_interval_integrable_ae hmeas_a (FTC_filter.finite_at_inner la) hua hva,
  have A' : ‚àÄ·∂† t in lt, interval_integrable f Œº a (ua t) :=
    ha_lim.eventually_interval_integrable_ae hmeas_a (FTC_filter.finite_at_inner la)
      (tendsto_const_pure.mono_right FTC_filter.pure_le) hua,
  have B : ‚àÄ·∂† t in lt, interval_integrable f Œº (ub t) (vb t) :=
    hb_lim.eventually_interval_integrable_ae hmeas_b (FTC_filter.finite_at_inner lb) hub hvb,
  have B' : ‚àÄ·∂† t in lt, interval_integrable f Œº b (ub t) :=
    hb_lim.eventually_interval_integrable_ae hmeas_b (FTC_filter.finite_at_inner lb)
      (tendsto_const_pure.mono_right FTC_filter.pure_le) hub,
  filter_upwards [A, A', B, B'] with _ ua_va a_ua ub_vb b_ub,
  rw [‚Üê integral_interval_sub_interval_comm'],
  { dsimp only [], abel, },
  exacts [ub_vb, ua_va, b_ub.symm.trans $ hab.symm.trans a_ua]
end
lemma measure_integral_sub_integral_sub_linear_is_o_of_tendsto_ae_right
  (hab : interval_integrable f Œº a b) (hmeas : strongly_measurable_at_filter f lb' Œº)
  (hf : tendsto f (lb' ‚äì Œº.ae) (ùìù c)) (hu : tendsto u lt lb) (hv : tendsto v lt lb) :
  (Œª t, ‚à´ x in a..v t, f x ‚àÇŒº - ‚à´ x in a..u t, f x ‚àÇŒº - ‚à´ x in u t..v t, c ‚àÇŒº) =o[lt]
    (Œª t, ‚à´ x in u t..v t, (1:‚Ñù) ‚àÇŒº) :=
by simpa using measure_integral_sub_integral_sub_linear_is_o_of_tendsto_ae
  hab strongly_measurable_at_bot hmeas ((tendsto_bot : tendsto _ ‚ä• (ùìù 0)).mono_left inf_le_left)
  hf (tendsto_const_pure : tendsto _ _ (pure a)) tendsto_const_pure hu hv
lemma measure_integral_sub_integral_sub_linear_is_o_of_tendsto_ae_left
  (hab : interval_integrable f Œº a b) (hmeas : strongly_measurable_at_filter f la' Œº)
  (hf : tendsto f (la' ‚äì Œº.ae) (ùìù c)) (hu : tendsto u lt la) (hv : tendsto v lt la) :
  (Œª t, ‚à´ x in v t..b, f x ‚àÇŒº - ‚à´ x in u t..b, f x ‚àÇŒº + ‚à´ x in u t..v t, c ‚àÇŒº) =o[lt]
    (Œª t, ‚à´ x in u t..v t, (1:‚Ñù) ‚àÇŒº) :=
by simpa using measure_integral_sub_integral_sub_linear_is_o_of_tendsto_ae
  hab hmeas strongly_measurable_at_bot hf ((tendsto_bot : tendsto _ ‚ä• (ùìù 0)).mono_left inf_le_left)
  hu hv (tendsto_const_pure : tendsto _ _ (pure b)) tendsto_const_pure
end
variables {f : ‚Ñù ‚Üí E} {c ca cb : E} {l l' la la' lb lb' : filter ‚Ñù} {lt : filter Œπ}
  {a b z : ‚Ñù} {u v ua ub va vb : Œπ ‚Üí ‚Ñù} [FTC_filter a la la'] [FTC_filter b lb lb']
lemma integral_sub_linear_is_o_of_tendsto_ae [FTC_filter a l l']
  (hfm : strongly_measurable_at_filter f l') (hf : tendsto f (l' ‚äì volume.ae) (ùìù c))
  {u v : Œπ ‚Üí ‚Ñù} (hu : tendsto u lt l) (hv : tendsto v lt l) :
  (Œª t, (‚à´ x in u t..v t, f x) - (v t - u t) ‚Ä¢ c) =o[lt] (v - u) :=
by simpa [integral_const] using measure_integral_sub_linear_is_o_of_tendsto_ae hfm hf hu hv
lemma integral_sub_integral_sub_linear_is_o_of_tendsto_ae
  (hab : interval_integrable f volume a b)
  (hmeas_a : strongly_measurable_at_filter f la') (hmeas_b : strongly_measurable_at_filter f lb')
  (ha_lim : tendsto f (la' ‚äì volume.ae) (ùìù ca)) (hb_lim : tendsto f (lb' ‚äì volume.ae) (ùìù cb))
  (hua : tendsto ua lt la) (hva : tendsto va lt la)
  (hub : tendsto ub lt lb) (hvb : tendsto vb lt lb) :
  (Œª t, (‚à´ x in va t..vb t, f x) - (‚à´ x in ua t..ub t, f x) -
    ((vb t - ub t) ‚Ä¢ cb - (va t - ua t) ‚Ä¢ ca)) =o[lt] (Œª t, ‚à•va t - ua t‚à• + ‚à•vb t - ub t‚à•) :=
by simpa [integral_const]
  using measure_integral_sub_integral_sub_linear_is_o_of_tendsto_ae hab hmeas_a hmeas_b
    ha_lim hb_lim hua hva hub hvb
lemma integral_sub_integral_sub_linear_is_o_of_tendsto_ae_right
  (hab : interval_integrable f volume a b) (hmeas : strongly_measurable_at_filter f lb')
  (hf : tendsto f (lb' ‚äì volume.ae) (ùìù c)) (hu : tendsto u lt lb) (hv : tendsto v lt lb) :
  (Œª t, (‚à´ x in a..v t, f x) - (‚à´ x in a..u t, f x) - (v t - u t) ‚Ä¢ c) =o[lt] (v - u) :=
by simpa only [integral_const, smul_eq_mul, mul_one] using
  measure_integral_sub_integral_sub_linear_is_o_of_tendsto_ae_right hab hmeas hf hu hv
lemma integral_sub_integral_sub_linear_is_o_of_tendsto_ae_left
  (hab : interval_integrable f volume a b) (hmeas : strongly_measurable_at_filter f la')
  (hf : tendsto f (la' ‚äì volume.ae) (ùìù c)) (hu : tendsto u lt la) (hv : tendsto v lt la) :
  (Œª t, (‚à´ x in v t..b, f x) - (‚à´ x in u t..b, f x) + (v t - u t) ‚Ä¢ c) =o[lt] (v - u) :=
by simpa only [integral_const, smul_eq_mul, mul_one] using
  measure_integral_sub_integral_sub_linear_is_o_of_tendsto_ae_left hab hmeas hf hu hv
open continuous_linear_map (fst snd smul_right sub_apply smul_right_apply coe_fst' coe_snd' map_sub)
lemma integral_has_strict_fderiv_at_of_tendsto_ae
  (hf : interval_integrable f volume a b)
  (hmeas_a : strongly_measurable_at_filter f (ùìù a))
  (hmeas_b : strongly_measurable_at_filter f (ùìù b))
  (ha : tendsto f (ùìù a ‚äì volume.ae) (ùìù ca)) (hb : tendsto f (ùìù b ‚äì volume.ae) (ùìù cb)) :
  has_strict_fderiv_at (Œª p : ‚Ñù √ó ‚Ñù, ‚à´ x in p.1..p.2, f x)
    ((snd ‚Ñù ‚Ñù ‚Ñù).smul_right cb - (fst ‚Ñù ‚Ñù ‚Ñù).smul_right ca) (a, b) :=
begin
  have := integral_sub_integral_sub_linear_is_o_of_tendsto_ae hf hmeas_a hmeas_b ha hb
    ((continuous_fst.comp continuous_snd).tendsto ((a, b), (a, b)))
    ((continuous_fst.comp continuous_fst).tendsto ((a, b), (a, b)))
    ((continuous_snd.comp continuous_snd).tendsto ((a, b), (a, b)))
    ((continuous_snd.comp continuous_fst).tendsto ((a, b), (a, b))),
  refine (this.congr_left _).trans_is_O _,
  { intro x, simp [sub_smul] },
  { exact is_O_fst_prod.norm_left.add is_O_snd_prod.norm_left }
end
lemma integral_has_strict_fderiv_at
  (hf : interval_integrable f volume a b)
  (hmeas_a : strongly_measurable_at_filter f (ùìù a))
  (hmeas_b : strongly_measurable_at_filter f (ùìù b))
  (ha : continuous_at f a) (hb : continuous_at f b) :
  has_strict_fderiv_at (Œª p : ‚Ñù √ó ‚Ñù, ‚à´ x in p.1..p.2, f x)
    ((snd ‚Ñù ‚Ñù ‚Ñù).smul_right (f b) - (fst ‚Ñù ‚Ñù ‚Ñù).smul_right (f a)) (a, b) :=
integral_has_strict_fderiv_at_of_tendsto_ae hf hmeas_a hmeas_b
  (ha.mono_left inf_le_left) (hb.mono_left inf_le_left)
lemma integral_has_strict_deriv_at_of_tendsto_ae_right
  (hf : interval_integrable f volume a b) (hmeas : strongly_measurable_at_filter f (ùìù b))
  (hb : tendsto f (ùìù b ‚äì volume.ae) (ùìù c)) : has_strict_deriv_at (Œª u, ‚à´ x in a..u, f x) c b :=
integral_sub_integral_sub_linear_is_o_of_tendsto_ae_right hf hmeas hb continuous_at_snd
  continuous_at_fst
lemma integral_has_strict_deriv_at_right
  (hf : interval_integrable f volume a b) (hmeas : strongly_measurable_at_filter f (ùìù b))
  (hb : continuous_at f b) : has_strict_deriv_at (Œª u, ‚à´ x in a..u, f x) (f b) b :=
integral_has_strict_deriv_at_of_tendsto_ae_right hf hmeas (hb.mono_left inf_le_left)
lemma integral_has_strict_deriv_at_of_tendsto_ae_left
  (hf : interval_integrable f volume a b) (hmeas : strongly_measurable_at_filter f (ùìù a))
  (ha : tendsto f (ùìù a ‚äì volume.ae) (ùìù c)) : has_strict_deriv_at (Œª u, ‚à´ x in u..b, f x) (-c) a :=
by simpa only [‚Üê integral_symm]
  using (integral_has_strict_deriv_at_of_tendsto_ae_right hf.symm hmeas ha).neg
lemma integral_has_strict_deriv_at_left
  (hf : interval_integrable f volume a b) (hmeas : strongly_measurable_at_filter f (ùìù a))
  (ha : continuous_at f a) : has_strict_deriv_at (Œª u, ‚à´ x in u..b, f x) (-f a) a :=
by simpa only [‚Üê integral_symm] using (integral_has_strict_deriv_at_right hf.symm hmeas ha).neg
lemma integral_has_fderiv_at_of_tendsto_ae (hf : interval_integrable f volume a b)
  (hmeas_a : strongly_measurable_at_filter f (ùìù a))
  (hmeas_b : strongly_measurable_at_filter f (ùìù b))
  (ha : tendsto f (ùìù a ‚äì volume.ae) (ùìù ca)) (hb : tendsto f (ùìù b ‚äì volume.ae) (ùìù cb)) :
  has_fderiv_at (Œª p : ‚Ñù √ó ‚Ñù, ‚à´ x in p.1..p.2, f x)
    ((snd ‚Ñù ‚Ñù ‚Ñù).smul_right cb - (fst ‚Ñù ‚Ñù ‚Ñù).smul_right ca) (a, b) :=
(integral_has_strict_fderiv_at_of_tendsto_ae hf hmeas_a hmeas_b ha hb).has_fderiv_at
lemma integral_has_fderiv_at (hf : interval_integrable f volume a b)
  (hmeas_a : strongly_measurable_at_filter f (ùìù a))
  (hmeas_b : strongly_measurable_at_filter f (ùìù b))
  (ha : continuous_at f a) (hb : continuous_at f b) :
  has_fderiv_at (Œª p : ‚Ñù √ó ‚Ñù, ‚à´ x in p.1..p.2, f x)
    ((snd ‚Ñù ‚Ñù ‚Ñù).smul_right (f b) - (fst ‚Ñù ‚Ñù ‚Ñù).smul_right (f a)) (a, b) :=
(integral_has_strict_fderiv_at hf hmeas_a hmeas_b ha hb).has_fderiv_at
lemma fderiv_integral_of_tendsto_ae (hf : interval_integrable f volume a b)
  (hmeas_a : strongly_measurable_at_filter f (ùìù a))
  (hmeas_b : strongly_measurable_at_filter f (ùìù b))
  (ha : tendsto f (ùìù a ‚äì volume.ae) (ùìù ca)) (hb : tendsto f (ùìù b ‚äì volume.ae) (ùìù cb)) :
  fderiv ‚Ñù (Œª p : ‚Ñù √ó ‚Ñù, ‚à´ x in p.1..p.2, f x) (a, b) =
    (snd ‚Ñù ‚Ñù ‚Ñù).smul_right cb - (fst ‚Ñù ‚Ñù ‚Ñù).smul_right ca :=
(integral_has_fderiv_at_of_tendsto_ae hf hmeas_a hmeas_b ha hb).fderiv
lemma fderiv_integral (hf : interval_integrable f volume a b)
  (hmeas_a : strongly_measurable_at_filter f (ùìù a))
  (hmeas_b : strongly_measurable_at_filter f (ùìù b))
  (ha : continuous_at f a) (hb : continuous_at f b) :
  fderiv ‚Ñù (Œª p : ‚Ñù √ó ‚Ñù, ‚à´ x in p.1..p.2, f x) (a, b) =
    (snd ‚Ñù ‚Ñù ‚Ñù).smul_right (f b) - (fst ‚Ñù ‚Ñù ‚Ñù).smul_right (f a) :=
(integral_has_fderiv_at hf hmeas_a hmeas_b ha hb).fderiv
lemma integral_has_deriv_at_of_tendsto_ae_right
  (hf : interval_integrable f volume a b) (hmeas : strongly_measurable_at_filter f (ùìù b))
  (hb : tendsto f (ùìù b ‚äì volume.ae) (ùìù c)) : has_deriv_at (Œª u, ‚à´ x in a..u, f x) c b :=
(integral_has_strict_deriv_at_of_tendsto_ae_right hf hmeas hb).has_deriv_at
lemma integral_has_deriv_at_right
  (hf : interval_integrable f volume a b) (hmeas : strongly_measurable_at_filter f (ùìù b))
  (hb : continuous_at f b) : has_deriv_at (Œª u, ‚à´ x in a..u, f x) (f b) b :=
(integral_has_strict_deriv_at_right hf hmeas hb).has_deriv_at
lemma deriv_integral_of_tendsto_ae_right
  (hf : interval_integrable f volume a b) (hmeas : strongly_measurable_at_filter f (ùìù b))
  (hb : tendsto f (ùìù b ‚äì volume.ae) (ùìù c)) : deriv (Œª u, ‚à´ x in a..u, f x) b = c :=
(integral_has_deriv_at_of_tendsto_ae_right hf hmeas hb).deriv
lemma deriv_integral_right
  (hf : interval_integrable f volume a b) (hmeas : strongly_measurable_at_filter f (ùìù b))
  (hb : continuous_at f b) :
  deriv (Œª u, ‚à´ x in a..u, f x) b = f b :=
(integral_has_deriv_at_right hf hmeas hb).deriv
lemma integral_has_deriv_at_of_tendsto_ae_left
  (hf : interval_integrable f volume a b) (hmeas : strongly_measurable_at_filter f (ùìù a))
  (ha : tendsto f (ùìù a ‚äì volume.ae) (ùìù c)) : has_deriv_at (Œª u, ‚à´ x in u..b, f x) (-c) a :=
(integral_has_strict_deriv_at_of_tendsto_ae_left hf hmeas ha).has_deriv_at
lemma integral_has_deriv_at_left
  (hf : interval_integrable f volume a b) (hmeas : strongly_measurable_at_filter f (ùìù a))
  (ha : continuous_at f a) :
  has_deriv_at (Œª u, ‚à´ x in u..b, f x) (-f a) a :=
(integral_has_strict_deriv_at_left hf hmeas ha).has_deriv_at
lemma deriv_integral_of_tendsto_ae_left
  (hf : interval_integrable f volume a b) (hmeas : strongly_measurable_at_filter f (ùìù a))
  (hb : tendsto f (ùìù a ‚äì volume.ae) (ùìù c)) : deriv (Œª u, ‚à´ x in u..b, f x) a = -c :=
(integral_has_deriv_at_of_tendsto_ae_left hf hmeas hb).deriv
lemma deriv_integral_left
  (hf : interval_integrable f volume a b) (hmeas : strongly_measurable_at_filter f (ùìù a))
  (hb : continuous_at f a) :
  deriv (Œª u, ‚à´ x in u..b, f x) a = -f a :=
(integral_has_deriv_at_left hf hmeas hb).deriv
lemma integral_has_fderiv_within_at_of_tendsto_ae
  (hf : interval_integrable f volume a b)
  {s t : set ‚Ñù} [FTC_filter a (ùìù[s] a) la] [FTC_filter b (ùìù[t] b) lb]
  (hmeas_a : strongly_measurable_at_filter f la) (hmeas_b : strongly_measurable_at_filter f lb)
  (ha : tendsto f (la ‚äì volume.ae) (ùìù ca)) (hb : tendsto f (lb ‚äì volume.ae) (ùìù cb)) :
  has_fderiv_within_at (Œª p : ‚Ñù √ó ‚Ñù, ‚à´ x in p.1..p.2, f x)
    ((snd ‚Ñù ‚Ñù ‚Ñù).smul_right cb - (fst ‚Ñù ‚Ñù ‚Ñù).smul_right ca) (s √óÀ¢ t) (a, b) :=
begin
  rw [has_fderiv_within_at, nhds_within_prod_eq],
  have := integral_sub_integral_sub_linear_is_o_of_tendsto_ae hf hmeas_a hmeas_b ha hb
    (tendsto_const_pure.mono_right FTC_filter.pure_le : tendsto _ _ (ùìù[s] a)) tendsto_fst
    (tendsto_const_pure.mono_right FTC_filter.pure_le : tendsto _ _ (ùìù[t] b)) tendsto_snd,
  refine (this.congr_left _).trans_is_O _,
  { intro x, simp [sub_smul] },
  { exact is_O_fst_prod.norm_left.add is_O_snd_prod.norm_left }
end
lemma integral_has_fderiv_within_at
  (hf : interval_integrable f volume a b)
  (hmeas_a : strongly_measurable_at_filter f la) (hmeas_b : strongly_measurable_at_filter f lb)
  {s t : set ‚Ñù} [FTC_filter a (ùìù[s] a) la] [FTC_filter b (ùìù[t] b) lb]
  (ha : tendsto f la (ùìù $ f a)) (hb : tendsto f lb (ùìù $ f b)) :
  has_fderiv_within_at (Œª p : ‚Ñù √ó ‚Ñù, ‚à´ x in p.1..p.2, f x)
    ((snd ‚Ñù ‚Ñù ‚Ñù).smul_right (f b) - (fst ‚Ñù ‚Ñù ‚Ñù).smul_right (f a)) (s √óÀ¢ t) (a, b) :=
integral_has_fderiv_within_at_of_tendsto_ae hf hmeas_a hmeas_b (ha.mono_left inf_le_left)
  (hb.mono_left inf_le_left)
meta def unique_diff_within_at_Ici_Iic_univ : tactic unit :=
`[apply_rules [unique_diff_on.unique_diff_within_at, unique_diff_on_Ici, unique_diff_on_Iic,
  left_mem_Ici, right_mem_Iic, unique_diff_within_at_univ]]
lemma fderiv_within_integral_of_tendsto_ae
  (hf : interval_integrable f volume a b)
  (hmeas_a : strongly_measurable_at_filter f la) (hmeas_b : strongly_measurable_at_filter f lb)
  {s t : set ‚Ñù} [FTC_filter a (ùìù[s] a) la] [FTC_filter b (ùìù[t] b) lb]
  (ha : tendsto f (la ‚äì volume.ae) (ùìù ca)) (hb : tendsto f (lb ‚äì volume.ae) (ùìù cb))
  (hs : unique_diff_within_at ‚Ñù s a . unique_diff_within_at_Ici_Iic_univ)
  (ht : unique_diff_within_at ‚Ñù t b . unique_diff_within_at_Ici_Iic_univ) :
  fderiv_within ‚Ñù (Œª p : ‚Ñù √ó ‚Ñù, ‚à´ x in p.1..p.2, f x) (s √óÀ¢ t) (a, b) =
    ((snd ‚Ñù ‚Ñù ‚Ñù).smul_right cb - (fst ‚Ñù ‚Ñù ‚Ñù).smul_right ca) :=
(integral_has_fderiv_within_at_of_tendsto_ae hf hmeas_a hmeas_b ha hb).fderiv_within $ hs.prod ht
lemma integral_has_deriv_within_at_of_tendsto_ae_right
  (hf : interval_integrable f volume a b) {s t : set ‚Ñù} [FTC_filter b (ùìù[s] b) (ùìù[t] b)]
  (hmeas : strongly_measurable_at_filter f (ùìù[t] b)) (hb : tendsto f (ùìù[t] b ‚äì volume.ae) (ùìù c)) :
  has_deriv_within_at (Œª u, ‚à´ x in a..u, f x) c s b :=
integral_sub_integral_sub_linear_is_o_of_tendsto_ae_right hf hmeas hb
  (tendsto_const_pure.mono_right FTC_filter.pure_le) tendsto_id
lemma integral_has_deriv_within_at_right
  (hf : interval_integrable f volume a b) {s t : set ‚Ñù} [FTC_filter b (ùìù[s] b) (ùìù[t] b)]
  (hmeas : strongly_measurable_at_filter f (ùìù[t] b)) (hb : continuous_within_at f t b) :
  has_deriv_within_at (Œª u, ‚à´ x in a..u, f x) (f b) s b :=
integral_has_deriv_within_at_of_tendsto_ae_right hf hmeas (hb.mono_left inf_le_left)
lemma deriv_within_integral_of_tendsto_ae_right
  (hf : interval_integrable f volume a b) {s t : set ‚Ñù} [FTC_filter b (ùìù[s] b) (ùìù[t] b)]
  (hmeas: strongly_measurable_at_filter f (ùìù[t] b)) (hb : tendsto f (ùìù[t] b ‚äì volume.ae) (ùìù c))
  (hs : unique_diff_within_at ‚Ñù s b . unique_diff_within_at_Ici_Iic_univ) :
  deriv_within (Œª u, ‚à´ x in a..u, f x) s b = c :=
(integral_has_deriv_within_at_of_tendsto_ae_right hf hmeas hb).deriv_within hs
lemma deriv_within_integral_right
  (hf : interval_integrable f volume a b) {s t : set ‚Ñù} [FTC_filter b (ùìù[s] b) (ùìù[t] b)]
  (hmeas : strongly_measurable_at_filter f (ùìù[t] b)) (hb : continuous_within_at f t b)
  (hs : unique_diff_within_at ‚Ñù s b . unique_diff_within_at_Ici_Iic_univ) :
  deriv_within (Œª u, ‚à´ x in a..u, f x) s b = f b :=
(integral_has_deriv_within_at_right hf hmeas hb).deriv_within hs
lemma integral_has_deriv_within_at_of_tendsto_ae_left
  (hf : interval_integrable f volume a b) {s t : set ‚Ñù} [FTC_filter a (ùìù[s] a) (ùìù[t] a)]
  (hmeas : strongly_measurable_at_filter f (ùìù[t] a))
  (ha : tendsto f (ùìù[t] a ‚äì volume.ae) (ùìù c)) :
  has_deriv_within_at (Œª u, ‚à´ x in u..b, f x) (-c) s a :=
by { simp only [integral_symm b],
  exact (integral_has_deriv_within_at_of_tendsto_ae_right hf.symm hmeas ha).neg }
lemma integral_has_deriv_within_at_left
  (hf : interval_integrable f volume a b) {s t : set ‚Ñù} [FTC_filter a (ùìù[s] a) (ùìù[t] a)]
  (hmeas : strongly_measurable_at_filter f (ùìù[t] a)) (ha : continuous_within_at f t a) :
  has_deriv_within_at (Œª u, ‚à´ x in u..b, f x) (-f a) s a :=
integral_has_deriv_within_at_of_tendsto_ae_left hf hmeas (ha.mono_left inf_le_left)
lemma deriv_within_integral_of_tendsto_ae_left
  (hf : interval_integrable f volume a b) {s t : set ‚Ñù} [FTC_filter a (ùìù[s] a) (ùìù[t] a)]
  (hmeas : strongly_measurable_at_filter f (ùìù[t] a)) (ha : tendsto f (ùìù[t] a ‚äì volume.ae) (ùìù c))
  (hs : unique_diff_within_at ‚Ñù s a . unique_diff_within_at_Ici_Iic_univ) :
  deriv_within (Œª u, ‚à´ x in u..b, f x) s a = -c :=
(integral_has_deriv_within_at_of_tendsto_ae_left hf hmeas ha).deriv_within hs
lemma deriv_within_integral_left
  (hf : interval_integrable f volume a b) {s t : set ‚Ñù} [FTC_filter a (ùìù[s] a) (ùìù[t] a)]
  (hmeas : strongly_measurable_at_filter f (ùìù[t] a)) (ha : continuous_within_at f t a)
  (hs : unique_diff_within_at ‚Ñù s a . unique_diff_within_at_Ici_Iic_univ) :
  deriv_within (Œª u, ‚à´ x in u..b, f x) s a = -f a :=
(integral_has_deriv_within_at_left hf hmeas ha).deriv_within hs
theorem differentiable_on_integral_of_continuous {s : set ‚Ñù}
  (hintg : ‚àÄ x ‚àà s, interval_integrable f volume a x) (hcont : continuous f) :
  differentiable_on ‚Ñù (Œª u, ‚à´ x in a..u, f x) s :=
Œª y hy, (integral_has_deriv_at_right (hintg y hy)
  hcont.ae_strongly_measurable.strongly_measurable_at_filter
    hcont.continuous_at) .differentiable_at.differentiable_within_at
variables {g' g œÜ : ‚Ñù ‚Üí ‚Ñù}
lemma sub_le_integral_of_has_deriv_right_of_le_Ico (hab : a ‚â§ b) (hcont : continuous_on g (Icc a b))
  (hderiv : ‚àÄ x ‚àà Ico a b, has_deriv_within_at g (g' x) (Ioi x) x)
  (œÜint : integrable_on œÜ (Icc a b)) (hœÜg : ‚àÄ x ‚àà Ico a b, g' x ‚â§ œÜ x) :
  g b - g a ‚â§ ‚à´ y in a..b, œÜ y :=
begin
  refine le_of_forall_pos_le_add (Œª Œµ Œµpos, _),
lemma sub_le_integral_of_has_deriv_right_of_le (hab : a ‚â§ b)
  (hcont : continuous_on g (Icc a b))
  (hderiv : ‚àÄ x ‚àà Ioo a b, has_deriv_within_at g (g' x) (Ioi x) x)
  (œÜint : integrable_on œÜ (Icc a b)) (hœÜg : ‚àÄ x ‚àà Ioo a b, g' x ‚â§ œÜ x) :
  g b - g a ‚â§ ‚à´ y in a..b, œÜ y :=
begin
lemma integral_le_sub_of_has_deriv_right_of_le (hab : a ‚â§ b)
  (hcont : continuous_on g (Icc a b))
  (hderiv : ‚àÄ x ‚àà Ioo a b, has_deriv_within_at g (g' x) (Ioi x) x)
  (œÜint : integrable_on œÜ (Icc a b)) (hœÜg : ‚àÄ x ‚àà Ioo a b, œÜ x ‚â§ g' x) :
  ‚à´ y in a..b, œÜ y ‚â§ g b - g a :=
begin
  rw ‚Üê neg_le_neg_iff,
  convert sub_le_integral_of_has_deriv_right_of_le hab hcont.neg (Œª x hx, (hderiv x hx).neg)
    œÜint.neg (Œª x hx, neg_le_neg (hœÜg x hx)),
  { abel },
  { simp only [‚Üê integral_neg], refl },
end
lemma integral_eq_sub_of_has_deriv_right_of_le_real (hab : a ‚â§ b)
  (hcont : continuous_on g (Icc a b))
  (hderiv : ‚àÄ x ‚àà Ioo a b, has_deriv_within_at g (g' x) (Ioi x) x)
  (g'int : integrable_on g' (Icc a b)) :
  ‚à´ y in a..b, g' y = g b - g a :=
le_antisymm
  (integral_le_sub_of_has_deriv_right_of_le hab hcont hderiv g'int (Œª x hx, le_rfl))
  (sub_le_integral_of_has_deriv_right_of_le hab hcont hderiv g'int (Œª x hx, le_rfl))
variable {f' : ‚Ñù ‚Üí E}
theorem integral_eq_sub_of_has_deriv_right_of_le (hab : a ‚â§ b) (hcont : continuous_on f (Icc a b))
  (hderiv : ‚àÄ x ‚àà Ioo a b, has_deriv_within_at f (f' x) (Ioi x) x)
  (f'int : interval_integrable f' volume a b) :
  ‚à´ y in a..b, f' y = f b - f a :=
begin
  refine (normed_space.eq_iff_forall_dual_eq ‚Ñù).2 (Œª g, _),
  rw [‚Üê g.interval_integral_comp_comm f'int, g.map_sub],
  exact integral_eq_sub_of_has_deriv_right_of_le_real hab (g.continuous.comp_continuous_on hcont)
    (Œª x hx, g.has_fderiv_at.comp_has_deriv_within_at x (hderiv x hx))
    (g.integrable_comp ((interval_integrable_iff_integrable_Icc_of_le hab).1 f'int))
end
theorem integral_eq_sub_of_has_deriv_right (hcont : continuous_on f (interval a b))
  (hderiv : ‚àÄ x ‚àà Ioo (min a b) (max a b), has_deriv_within_at f (f' x) (Ioi x) x)
  (hint : interval_integrable f' volume a b) :
  ‚à´ y in a..b, f' y = f b - f a :=
begin
  cases le_total a b with hab hab,
  { simp only [interval_of_le, min_eq_left, max_eq_right, hab] at hcont hderiv hint,
    apply integral_eq_sub_of_has_deriv_right_of_le hab hcont hderiv hint },
  { simp only [interval_of_ge, min_eq_right, max_eq_left, hab] at hcont hderiv,
    rw [integral_symm, integral_eq_sub_of_has_deriv_right_of_le hab hcont hderiv hint.symm,
        neg_sub] }
end
theorem integral_eq_sub_of_has_deriv_at_of_le (hab : a ‚â§ b)
  (hcont : continuous_on f (Icc a b))
  (hderiv : ‚àÄ x ‚àà Ioo a b, has_deriv_at f (f' x) x) (hint : interval_integrable f' volume a b) :
  ‚à´ y in a..b, f' y = f b - f a :=
integral_eq_sub_of_has_deriv_right_of_le hab hcont (Œª x hx, (hderiv x hx).has_deriv_within_at) hint
theorem integral_eq_sub_of_has_deriv_at
  (hderiv : ‚àÄ x ‚àà interval a b, has_deriv_at f (f' x) x)
  (hint : interval_integrable f' volume a b) :
  ‚à´ y in a..b, f' y = f b - f a :=
integral_eq_sub_of_has_deriv_right (has_deriv_at.continuous_on hderiv)
  (Œª x hx, (hderiv _ (mem_Icc_of_Ioo hx)).has_deriv_within_at) hint
theorem integral_eq_sub_of_has_deriv_at_of_tendsto (hab : a < b) {fa fb}
  (hderiv : ‚àÄ x ‚àà Ioo a b, has_deriv_at f (f' x) x) (hint : interval_integrable f' volume a b)
  (ha : tendsto f (ùìù[>] a) (ùìù fa)) (hb : tendsto f (ùìù[<] b) (ùìù fb)) :
  ‚à´ y in a..b, f' y = fb - fa :=
begin
  set F : ‚Ñù ‚Üí E := update (update f a fa) b fb,
  have Fderiv : ‚àÄ x ‚àà Ioo a b, has_deriv_at F (f' x) x,
  { refine Œª x hx, (hderiv x hx).congr_of_eventually_eq _,
    filter_upwards [Ioo_mem_nhds hx.1 hx.2] with _ hy, simp only [F],
    rw [update_noteq hy.2.ne, update_noteq hy.1.ne'], },
  have hcont : continuous_on F (Icc a b),
  { rw [continuous_on_update_iff, continuous_on_update_iff, Icc_diff_right, Ico_diff_left],
    refine ‚ü®‚ü®Œª z hz, (hderiv z hz).continuous_at.continuous_within_at, _‚ü©, _‚ü©,
    { exact Œª _, ha.mono_left (nhds_within_mono _ Ioo_subset_Ioi_self) },
    { rintro -,
      refine (hb.congr' _).mono_left (nhds_within_mono _ Ico_subset_Iio_self),
      filter_upwards [Ioo_mem_nhds_within_Iio (right_mem_Ioc.2 hab)]
        with _ hz using (update_noteq hz.1.ne' _ _).symm } },
  simpa [F, hab.ne, hab.ne'] using integral_eq_sub_of_has_deriv_at_of_le hab.le hcont Fderiv hint
end
theorem integral_deriv_eq_sub (hderiv : ‚àÄ x ‚àà interval a b, differentiable_at ‚Ñù f x)
  (hint : interval_integrable (deriv f) volume a b) :
  ‚à´ y in a..b, deriv f y = f b - f a :=
integral_eq_sub_of_has_deriv_at (Œª x hx, (hderiv x hx).has_deriv_at) hint
theorem integral_deriv_eq_sub' (f) (hderiv : deriv f = f')
  (hdiff : ‚àÄ x ‚àà interval a b, differentiable_at ‚Ñù f x)
  (hcont : continuous_on f' (interval a b)) :
  ‚à´ y in a..b, f' y = f b - f a :=
begin
  rw [‚Üê hderiv, integral_deriv_eq_sub hdiff],
  rw hderiv,
  exact hcont.interval_integrable
end
lemma integrable_on_deriv_right_of_nonneg (hab : a ‚â§ b) (hcont : continuous_on g (Icc a b))
  (hderiv : ‚àÄ x ‚àà Ioo a b, has_deriv_within_at g (g' x) (Ioi x) x)
  (g'pos : ‚àÄ x ‚àà Ioo a b, 0 ‚â§ g' x) :
  integrable_on g' (Ioc a b) :=
begin
  rw integrable_on_Ioc_iff_integrable_on_Ioo,
  have meas_g' : ae_measurable g' (volume.restrict (Ioo a b)),
  { apply (ae_measurable_deriv_within_Ioi g _).congr,
    refine (ae_restrict_mem measurable_set_Ioo).mono (Œª x hx, _),
    exact (hderiv x hx).deriv_within (unique_diff_within_at_Ioi _) },
  suffices H : ‚à´‚Åª x in Ioo a b, ‚à•g' x‚à•‚Çä ‚â§ ennreal.of_real (g b - g a),
    from ‚ü®meas_g'.ae_strongly_measurable, H.trans_lt ennreal.of_real_lt_top‚ü©,
  by_contra' H,
  obtain ‚ü®f, fle, fint, hf‚ü© :
    ‚àÉ (f : simple_func ‚Ñù ‚Ñù‚â•0), (‚àÄ x, f x ‚â§ ‚à•g' x‚à•‚Çä) ‚àß ‚à´‚Åª (x : ‚Ñù) in Ioo a b, f x < ‚àû
      ‚àß ennreal.of_real (g b - g a) < ‚à´‚Åª (x : ‚Ñù) in Ioo a b, f x :=
    exists_lt_lintegral_simple_func_of_lt_lintegral H,
  let F : ‚Ñù ‚Üí ‚Ñù := coe ‚àò f,
  have intF : integrable_on F (Ioo a b),
  { refine ‚ü®f.measurable.coe_nnreal_real.ae_strongly_measurable, _‚ü©,
    simpa only [has_finite_integral, nnreal.nnnorm_eq] using fint },
  have A : ‚à´‚Åª (x : ‚Ñù) in Ioo a b, f x = ennreal.of_real (‚à´ x in Ioo a b, F x) :=
    lintegral_coe_eq_integral _ intF,
  rw A at hf,
  have B : ‚à´ (x : ‚Ñù) in Ioo a b, F x ‚â§ g b - g a,
  { rw [‚Üê integral_Ioc_eq_integral_Ioo, ‚Üê interval_integral.integral_of_le hab],
    apply integral_le_sub_of_has_deriv_right_of_le hab hcont hderiv _ (Œª x hx, _),
    { rwa integrable_on_Icc_iff_integrable_on_Ioo },
    { convert nnreal.coe_le_coe.2 (fle x),
      simp only [real.norm_of_nonneg (g'pos x hx), coe_nnnorm] } },
  exact lt_irrefl _ (hf.trans_le (ennreal.of_real_le_of_real B)),
end
lemma integrable_on_deriv_of_nonneg (hab : a ‚â§ b) (hcont : continuous_on g (Icc a b))
  (hderiv : ‚àÄ x ‚àà Ioo a b, has_deriv_at g (g' x) x)
  (g'pos : ‚àÄ x ‚àà Ioo a b, 0 ‚â§ g' x) :
  integrable_on g' (Ioc a b) :=
integrable_on_deriv_right_of_nonneg hab hcont (Œª x hx, (hderiv x hx).has_deriv_within_at) g'pos
theorem interval_integrable_deriv_of_nonneg (hcont : continuous_on g (interval a b))
  (hderiv : ‚àÄ x ‚àà Ioo (min a b) (max a b), has_deriv_at g (g' x) x)
  (hpos : ‚àÄ x ‚àà Ioo (min a b) (max a b), 0 ‚â§ g' x) :
  interval_integrable g' volume a b :=
begin
  cases le_total a b with hab hab,
  { simp only [interval_of_le, min_eq_left, max_eq_right, hab, interval_integrable,
      hab, Ioc_eq_empty_of_le, integrable_on_empty, and_true] at hcont hderiv hpos ‚ä¢,
    exact integrable_on_deriv_of_nonneg hab hcont hderiv hpos, },
  { simp only [interval_of_ge, min_eq_right, max_eq_left, hab, interval_integrable,
      Ioc_eq_empty_of_le, integrable_on_empty, true_and] at hcont hderiv hpos ‚ä¢,
    exact integrable_on_deriv_of_nonneg hab hcont hderiv hpos }
end
theorem integral_deriv_mul_eq_sub {u v u' v' : ‚Ñù ‚Üí ‚Ñù}
  (hu : ‚àÄ x ‚àà interval a b, has_deriv_at u (u' x) x)
  (hv : ‚àÄ x ‚àà interval a b, has_deriv_at v (v' x) x)
  (hu' : interval_integrable u' volume a b) (hv' : interval_integrable v' volume a b) :
  ‚à´ x in a..b, u' x * v x + u x * v' x = u b * v b - u a * v a :=
integral_eq_sub_of_has_deriv_at (Œª x hx, (hu x hx).mul (hv x hx)) $
  (hu'.mul_continuous_on (has_deriv_at.continuous_on hv)).add
    (hv'.continuous_on_mul ((has_deriv_at.continuous_on hu)))
theorem integral_mul_deriv_eq_deriv_mul {u v u' v' : ‚Ñù ‚Üí ‚Ñù}
  (hu : ‚àÄ x ‚àà interval a b, has_deriv_at u (u' x) x)
  (hv : ‚àÄ x ‚àà interval a b, has_deriv_at v (v' x) x)
  (hu' : interval_integrable u' volume a b) (hv' : interval_integrable v' volume a b) :
  ‚à´ x in a..b, u x * v' x = u b * v b - u a * v a - ‚à´ x in a..b, v x * u' x :=
begin
  rw [‚Üê integral_deriv_mul_eq_sub hu hv hu' hv', ‚Üê integral_sub],
  { exact integral_congr (Œª x hx, by simp only [mul_comm, add_sub_cancel']) },
  { exact ((hu'.mul_continuous_on (has_deriv_at.continuous_on hv)).add
      (hv'.continuous_on_mul (has_deriv_at.continuous_on hu))) },
  { exact hu'.continuous_on_mul (has_deriv_at.continuous_on hv) },
end
section smul
theorem integral_comp_smul_deriv'' {f f' : ‚Ñù ‚Üí ‚Ñù} {g : ‚Ñù ‚Üí E}
  (hf : continuous_on f [a, b])
  (hff' : ‚àÄ x ‚àà Ioo (min a b) (max a b), has_deriv_within_at f (f' x) (Ioi x) x)
  (hf' : continuous_on f' [a, b])
  (hg : continuous_on g (f '' [a, b])) :
  ‚à´ x in a..b, f' x ‚Ä¢ (g ‚àò f) x= ‚à´ u in f a..f b, g u :=
begin
  have h_cont : continuous_on (Œª u, ‚à´ t in f a..f u, g t) [a, b],
  { rw [hf.image_interval] at hg,
    refine (continuous_on_primitive_interval' hg.interval_integrable _).comp hf _,
    { rw ‚Üê hf.image_interval, exact mem_image_of_mem f left_mem_interval },
    { rw ‚Üê hf.image_interval, exact maps_to_image _ _ } },
  have h_der : ‚àÄ x ‚àà Ioo (min a b) (max a b), has_deriv_within_at
    (Œª u, ‚à´ t in f a..f u, g t) (f' x ‚Ä¢ ((g ‚àò f) x)) (Ioi x) x,
  { intros x hx,
    let I := [Inf (f '' [a, b]), Sup (f '' [a, b])],
    have hI : f '' [a, b] = I := hf.image_interval,
    have h2x : f x ‚àà I, { rw [‚Üê hI], exact mem_image_of_mem f (Ioo_subset_Icc_self hx) },
    have h2g : interval_integrable g volume (f a) (f x),
    { refine (hg.mono $ _).interval_integrable,
      exact hf.surj_on_interval left_mem_interval (Ioo_subset_Icc_self hx) },
    rw [hI] at hg,
    have h3g : strongly_measurable_at_filter g (ùìù[I] f x) volume :=
    hg.strongly_measurable_at_filter_nhds_within measurable_set_Icc (f x),
    haveI : fact (f x ‚àà I) := ‚ü®h2x‚ü©,
    have : has_deriv_within_at (Œª u, ‚à´ x in f a..u, g x) (g (f x)) I (f x) :=
    integral_has_deriv_within_at_right h2g h3g (hg (f x) h2x),
    refine (this.scomp x ((hff' x hx).Ioo_of_Ioi hx.2) _).Ioi_of_Ioo hx.2,
    rw ‚Üê hI,
    exact (maps_to_image _ _).mono (Ioo_subset_Icc_self.trans $ Icc_subset_Icc_left hx.1.le)
      subset.rfl },
  have h_int : interval_integrable (Œª (x : ‚Ñù), f' x ‚Ä¢ (g ‚àò f) x) volume a b :=
  (hf'.smul (hg.comp hf $ subset_preimage_image f _)).interval_integrable,
  simp_rw [integral_eq_sub_of_has_deriv_right h_cont h_der h_int, integral_same, sub_zero],
end
theorem integral_comp_smul_deriv' {f f' : ‚Ñù ‚Üí ‚Ñù} {g : ‚Ñù ‚Üí E}
  (h : ‚àÄ x ‚àà interval a b, has_deriv_at f (f' x) x)
  (h' : continuous_on f' (interval a b)) (hg : continuous_on g (f '' [a, b])) :
  ‚à´ x in a..b, f' x ‚Ä¢ (g ‚àò f) x = ‚à´ x in f a..f b, g x :=
integral_comp_smul_deriv'' (Œª x hx, (h x hx).continuous_at.continuous_within_at)
  (Œª x hx, (h x $ Ioo_subset_Icc_self hx).has_deriv_within_at) h' hg
theorem integral_comp_smul_deriv {f f' : ‚Ñù ‚Üí ‚Ñù} {g : ‚Ñù ‚Üí E}
  (h : ‚àÄ x ‚àà interval a b, has_deriv_at f (f' x) x)
  (h' : continuous_on f' (interval a b)) (hg : continuous g) :
  ‚à´ x in a..b, f' x ‚Ä¢ (g ‚àò f) x = ‚à´ x in f a..f b, g x :=
integral_comp_smul_deriv' h h' hg.continuous_on
theorem integral_deriv_comp_smul_deriv' {f f' : ‚Ñù ‚Üí ‚Ñù} {g g' : ‚Ñù ‚Üí E}
  (hf : continuous_on f [a, b])
  (hff' : ‚àÄ x ‚àà Ioo (min a b) (max a b), has_deriv_within_at f (f' x) (Ioi x) x)
  (hf' : continuous_on f' [a, b])
  (hg : continuous_on g [f a, f b])
  (hgg' : ‚àÄ x ‚àà Ioo (min (f a) (f b)) (max (f a) (f b)), has_deriv_within_at g (g' x) (Ioi x) x)
  (hg' : continuous_on g' (f '' [a, b])) :
  ‚à´ x in a..b, f' x ‚Ä¢ (g' ‚àò f) x = (g ‚àò f) b - (g ‚àò f) a :=
begin
  rw [integral_comp_smul_deriv'' hf hff' hf' hg',
  integral_eq_sub_of_has_deriv_right hg hgg' (hg'.mono _).interval_integrable],
  exact intermediate_value_interval hf
end
theorem integral_deriv_comp_smul_deriv {f f' : ‚Ñù ‚Üí ‚Ñù} {g g' : ‚Ñù ‚Üí E}
  (hf : ‚àÄ x ‚àà interval a b, has_deriv_at f (f' x) x)
  (hg : ‚àÄ x ‚àà interval a b, has_deriv_at g (g' (f x)) (f x))
  (hf' : continuous_on f' (interval a b)) (hg' : continuous g') :
  ‚à´ x in a..b, f' x ‚Ä¢ (g' ‚àò f) x = (g ‚àò f) b - (g ‚àò f) a :=
integral_eq_sub_of_has_deriv_at (Œª x hx, (hg x hx).scomp x $ hf x hx)
  (hf'.smul (hg'.comp_continuous_on $ has_deriv_at.continuous_on hf)).interval_integrable
end smul
section mul
theorem integral_comp_mul_deriv'' {f f' g : ‚Ñù ‚Üí ‚Ñù}
  (hf : continuous_on f [a, b])
  (hff' : ‚àÄ x ‚àà Ioo (min a b) (max a b), has_deriv_within_at f (f' x) (Ioi x) x)
  (hf' : continuous_on f' [a, b])
  (hg : continuous_on g (f '' [a, b])) :
  ‚à´ x in a..b, (g ‚àò f) x * f' x = ‚à´ u in f a..f b, g u :=
by simpa [mul_comm] using integral_comp_smul_deriv'' hf hff' hf' hg
theorem integral_comp_mul_deriv' {f f' g : ‚Ñù ‚Üí ‚Ñù}
  (h : ‚àÄ x ‚àà interval a b, has_deriv_at f (f' x) x)
  (h' : continuous_on f' (interval a b)) (hg : continuous_on g (f '' [a, b])) :
  ‚à´ x in a..b, (g ‚àò f) x * f' x = ‚à´ x in f a..f b, g x :=
by simpa [mul_comm] using integral_comp_smul_deriv' h h' hg
theorem integral_comp_mul_deriv {f f' g : ‚Ñù ‚Üí ‚Ñù}
  (h : ‚àÄ x ‚àà interval a b, has_deriv_at f (f' x) x)
  (h' : continuous_on f' (interval a b)) (hg : continuous g) :
  ‚à´ x in a..b, (g ‚àò f) x * f' x = ‚à´ x in f a..f b, g x :=
integral_comp_mul_deriv' h h' hg.continuous_on
theorem integral_deriv_comp_mul_deriv' {f f' g g' : ‚Ñù ‚Üí ‚Ñù}
  (hf : continuous_on f [a, b])
  (hff' : ‚àÄ x ‚àà Ioo (min a b) (max a b), has_deriv_within_at f (f' x) (Ioi x) x)
  (hf' : continuous_on f' [a, b])
  (hg : continuous_on g [f a, f b])
  (hgg' : ‚àÄ x ‚àà Ioo (min (f a) (f b)) (max (f a) (f b)), has_deriv_within_at g (g' x) (Ioi x) x)
  (hg' : continuous_on g' (f '' [a, b])) :
  ‚à´ x in a..b, (g' ‚àò f) x * f' x = (g ‚àò f) b - (g ‚àò f) a :=
by simpa [mul_comm] using integral_deriv_comp_smul_deriv' hf hff' hf' hg hgg' hg'
theorem integral_deriv_comp_mul_deriv {f f' g g' : ‚Ñù ‚Üí ‚Ñù}
  (hf : ‚àÄ x ‚àà interval a b, has_deriv_at f (f' x) x)
  (hg : ‚àÄ x ‚àà interval a b, has_deriv_at g (g' (f x)) (f x))
  (hf' : continuous_on f' (interval a b)) (hg' : continuous g') :
  ‚à´ x in a..b, (g' ‚àò f) x * f' x = (g ‚àò f) b - (g ‚àò f) a :=
by simpa [mul_comm] using integral_deriv_comp_smul_deriv hf hg hf' hg'
end mul
end interval_integral
