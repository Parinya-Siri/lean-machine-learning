import measure_theory.measure.complex_lebesgue
import measure_theory.integral.divergence_theorem
import measure_theory.integral.circle_integral
import analysis.calculus.dslope
import analysis.analytic.basic
import analysis.complex.re_im_topology
import analysis.calculus.diff_on_int_cont
import data.real.cardinality
open topological_space set measure_theory interval_integral metric filter function
open_locale interval real nnreal ennreal topological_space big_operators
noncomputable theory
universes u
variables {E : Type u} [normed_group E] [normed_space â„‚ E] [complete_space E]
namespace complex
lemma integral_boundary_rect_of_has_fderiv_at_real_off_countable (f : â„‚ â†’ E)
  (f' : â„‚ â†’ â„‚ â†’L[â„] E) (z w : â„‚) (s : set â„‚) (hs : s.countable)
  (Hc : continuous_on f ([z.re, w.re] Ã—â„‚ [z.im, w.im]))
  (Hd : âˆ€ x âˆˆ (Ioo (min z.re w.re) (max z.re w.re) Ã—â„‚ Ioo (min z.im w.im) (max z.im w.im)) \ s,
    has_fderiv_at f (f' x) x)
  (Hi : integrable_on (Î» z, I â€¢ f' z 1 - f' z I) ([z.re, w.re] Ã—â„‚ [z.im, w.im])) :
  (âˆ« x : â„ in z.re..w.re, f (x + z.im * I)) - (âˆ« x : â„ in z.re..w.re, f (x + w.im * I)) +
    (I â€¢ âˆ« y : â„ in z.im..w.im, f (re w + y * I)) - I â€¢ âˆ« y : â„ in z.im..w.im, f (re z + y * I) =
    âˆ« x : â„ in z.re..w.re, âˆ« y : â„ in z.im..w.im, I â€¢ f' (x + y * I) 1 - f' (x + y * I) I :=
begin
  set e : (â„ Ã— â„) â‰ƒL[â„] â„‚ := equiv_real_prodâ‚—.symm,
  have he : âˆ€ x y : â„, â†‘x + â†‘y * I = e (x, y), from Î» x y, (mk_eq_add_mul_I x y).symm,
  have heâ‚ : e (1, 0) = 1 := rfl, have heâ‚‚ : e (0, 1) = I := rfl,
  simp only [he] at *,
  set F : (â„ Ã— â„) â†’ E := f âˆ˜ e,
  set F' : (â„ Ã— â„) â†’ (â„ Ã— â„) â†’L[â„] E := Î» p, (f' (e p)).comp (e : (â„ Ã— â„) â†’L[â„] â„‚),
  have hF' : âˆ€ p : â„ Ã— â„, (-(I â€¢ F' p)) (1, 0) + F' p (0, 1) = -(I â€¢ f' (e p) 1 - f' (e p) I),
  { rintro âŸ¨x, yâŸ©, simp [F', heâ‚, heâ‚‚, â† sub_eq_neg_add], },
  set R : set (â„ Ã— â„) := [z.re, w.re] Ã—Ë¢ [w.im, z.im],
  set t : set (â„ Ã— â„) := e â»Â¹' s,
  rw [interval_swap z.im] at Hc Hi, rw [min_comm z.im, max_comm z.im] at Hd,
  have hR : e â»Â¹' ([z.re, w.re] Ã—â„‚ [w.im, z.im]) = R := rfl,
  have htc : continuous_on F R, from Hc.comp e.continuous_on hR.ge,
  have htd : âˆ€ p âˆˆ Ioo (min z.re w.re) (max z.re w.re) Ã—Ë¢ Ioo (min w.im z.im) (max w.im z.im) \ t,
    has_fderiv_at F (F' p) p := Î» p hp, (Hd (e p) hp).comp p e.has_fderiv_at,
  simp_rw [â† interval_integral.integral_smul, interval_integral.integral_symm w.im z.im,
    â† interval_integral.integral_neg, â† hF'],
  refine (integral2_divergence_prod_of_has_fderiv_within_at_off_countable
      (Î» p, -(I â€¢ F p)) F (Î» p, - (I â€¢ F' p)) F' z.re w.im w.re z.im t (hs.preimage e.injective)
      (htc.const_smul _).neg htc (Î» p hp, ((htd p hp).const_smul I).neg) htd _).symm,
  rw [â† (volume_preserving_equiv_real_prod.symm _).integrable_on_comp_preimage
    (measurable_equiv.measurable_embedding _)] at Hi,
  simpa only [hF'] using Hi.neg
end
lemma integral_boundary_rect_of_continuous_on_of_has_fderiv_at_real (f : â„‚ â†’ E)
  (f' : â„‚ â†’ â„‚ â†’L[â„] E) (z w : â„‚)
  (Hc : continuous_on f ([z.re, w.re] Ã—â„‚ [z.im, w.im]))
  (Hd : âˆ€ x âˆˆ (Ioo (min z.re w.re) (max z.re w.re) Ã—â„‚ Ioo (min z.im w.im) (max z.im w.im)),
    has_fderiv_at f (f' x) x)
  (Hi : integrable_on (Î» z, I â€¢ f' z 1 - f' z I) ([z.re, w.re] Ã—â„‚ [z.im, w.im])) :
  (âˆ« x : â„ in z.re..w.re, f (x + z.im * I)) - (âˆ« x : â„ in z.re..w.re, f (x + w.im * I)) +
    (I â€¢ âˆ« y : â„ in z.im..w.im, f (re w + y * I)) - I â€¢ âˆ« y : â„ in z.im..w.im, f (re z + y * I) =
    âˆ« x : â„ in z.re..w.re, âˆ« y : â„ in z.im..w.im, I â€¢ f' (x + y * I) 1 - f' (x + y * I) I :=
integral_boundary_rect_of_has_fderiv_at_real_off_countable f f' z w âˆ… countable_empty Hc
  (Î» x hx, Hd x hx.1) Hi
lemma integral_boundary_rect_of_differentiable_on_real (f : â„‚ â†’ E) (z w : â„‚)
  (Hd : differentiable_on â„ f ([z.re, w.re] Ã—â„‚ [z.im, w.im]))
  (Hi : integrable_on (Î» z, I â€¢ fderiv â„ f z 1 - fderiv â„ f z I) ([z.re, w.re] Ã—â„‚ [z.im, w.im])) :
  (âˆ« x : â„ in z.re..w.re, f (x + z.im * I)) - (âˆ« x : â„ in z.re..w.re, f (x + w.im * I)) +
    (I â€¢ âˆ« y : â„ in z.im..w.im, f (re w + y * I)) - I â€¢ âˆ« y : â„ in z.im..w.im, f (re z + y * I) =
    âˆ« x : â„ in z.re..w.re, âˆ« y : â„ in z.im..w.im,
      I â€¢ fderiv â„ f (x + y * I) 1 - fderiv â„ f (x + y * I) I :=
integral_boundary_rect_of_has_fderiv_at_real_off_countable f (fderiv â„ f) z w âˆ… countable_empty
  Hd.continuous_on
  (Î» x hx, Hd.has_fderiv_at $ by simpa only [â† mem_interior_iff_mem_nhds,
    interior_re_prod_im, interval, interior_Icc] using hx.1) Hi
lemma integral_boundary_rect_eq_zero_of_differentiable_on_off_countable (f : â„‚ â†’ E)
  (z w : â„‚) (s : set â„‚) (hs : s.countable) (Hc : continuous_on f ([z.re, w.re] Ã—â„‚ [z.im, w.im]))
  (Hd : âˆ€ x âˆˆ (Ioo (min z.re w.re) (max z.re w.re) Ã—â„‚ Ioo (min z.im w.im) (max z.im w.im)) \ s,
    differentiable_at â„‚ f x) :
  (âˆ« x : â„ in z.re..w.re, f (x + z.im * I)) - (âˆ« x : â„ in z.re..w.re, f (x + w.im * I)) +
    (I â€¢ âˆ« y : â„ in z.im..w.im, f (re w + y * I)) -
      I â€¢ âˆ« y : â„ in z.im..w.im, f (re z + y * I) = 0 :=
by refine (integral_boundary_rect_of_has_fderiv_at_real_off_countable f
  (Î» z, (fderiv â„‚ f z).restrict_scalars â„) z w s hs Hc
  (Î» x hx, (Hd x hx).has_fderiv_at.restrict_scalars â„) _).trans _;
    simp [â† continuous_linear_map.map_smul]
lemma integral_boundary_rect_eq_zero_of_continuous_on_of_differentiable_on (f : â„‚ â†’ E) (z w : â„‚)
  (Hc : continuous_on f ([z.re, w.re] Ã—â„‚ [z.im, w.im]))
  (Hd : differentiable_on â„‚ f
    (Ioo (min z.re w.re) (max z.re w.re) Ã—â„‚ Ioo (min z.im w.im) (max z.im w.im))) :
  (âˆ« x : â„ in z.re..w.re, f (x + z.im * I)) - (âˆ« x : â„ in z.re..w.re, f (x + w.im * I)) +
    (I â€¢ âˆ« y : â„ in z.im..w.im, f (re w + y * I)) -
      I â€¢ âˆ« y : â„ in z.im..w.im, f (re z + y * I) = 0 :=
integral_boundary_rect_eq_zero_of_differentiable_on_off_countable f z w âˆ… countable_empty
  Hc $ Î» x hx, Hd.differentiable_at $ (is_open_Ioo.re_prod_im is_open_Ioo).mem_nhds hx.1
lemma integral_boundary_rect_eq_zero_of_differentiable_on (f : â„‚ â†’ E) (z w : â„‚)
  (H : differentiable_on â„‚ f ([z.re, w.re] Ã—â„‚ [z.im, w.im])) :
  (âˆ« x : â„ in z.re..w.re, f (x + z.im * I)) - (âˆ« x : â„ in z.re..w.re, f (x + w.im * I)) +
    (I â€¢ âˆ« y : â„ in z.im..w.im, f (re w + y * I)) -
      I â€¢ âˆ« y : â„ in z.im..w.im, f (re z + y * I) = 0 :=
integral_boundary_rect_eq_zero_of_continuous_on_of_differentiable_on f z w H.continuous_on $
  H.mono $
    inter_subset_inter (preimage_mono Ioo_subset_Icc_self) (preimage_mono Ioo_subset_Icc_self)
lemma circle_integral_sub_center_inv_smul_eq_of_differentiable_on_annulus_off_countable
  {c : â„‚} {r R : â„} (h0 : 0 < r) (hle : r â‰¤ R) {f : â„‚ â†’ E} {s : set â„‚} (hs : s.countable)
  (hc : continuous_on f (closed_ball c R \ ball c r))
  (hd : âˆ€ z âˆˆ ball c R \ closed_ball c r \ s, differentiable_at â„‚ f z) :
  âˆ® z in C(c, R), (z - c)â»Â¹ â€¢ f z = âˆ® z in C(c, r), (z - c)â»Â¹ â€¢ f z :=
begin
  set A := closed_ball c R \ ball c r,
  obtain âŸ¨a, rflâŸ© : âˆƒ a, real.exp a = r, from âŸ¨real.log r, real.exp_log h0âŸ©,
  obtain âŸ¨b, rflâŸ© : âˆƒ b, real.exp b = R, from âŸ¨real.log R, real.exp_log (h0.trans_le hle)âŸ©,
  rw [real.exp_le_exp] at hle,
lemma circle_integral_eq_of_differentiable_on_annulus_off_countable
  {c : â„‚} {r R : â„} (h0 : 0 < r) (hle : r â‰¤ R) {f : â„‚ â†’ E} {s : set â„‚} (hs : s.countable)
  (hc : continuous_on f (closed_ball c R \ ball c r))
  (hd : âˆ€ z âˆˆ ball c R \ closed_ball c r \ s, differentiable_at â„‚ f z) :
  âˆ® z in C(c, R), f z = âˆ® z in C(c, r), f z :=
calc âˆ® z in C(c, R), f z = âˆ® z in C(c, R), (z - c)â»Â¹ â€¢ (z - c) â€¢ f z :
  (circle_integral.integral_sub_inv_smul_sub_smul _ _ _ _).symm
... = âˆ® z in C(c, r), (z - c)â»Â¹ â€¢ (z - c) â€¢ f z :
  circle_integral_sub_center_inv_smul_eq_of_differentiable_on_annulus_off_countable h0 hle hs
    ((continuous_on_id.sub continuous_on_const).smul hc)
    (Î» z hz, (differentiable_at_id.sub_const _).smul (hd z hz))
... = âˆ® z in C(c, r), f z : circle_integral.integral_sub_inv_smul_sub_smul _ _ _ _
lemma circle_integral_sub_center_inv_smul_of_differentiable_on_off_countable_of_tendsto
  {c : â„‚} {R : â„} (h0 : 0 < R) {f : â„‚ â†’ E} {y : E} {s : set â„‚} (hs : s.countable)
  (hc : continuous_on f (closed_ball c R \ {c}))
  (hd : âˆ€ z âˆˆ ball c R \ {c} \ s, differentiable_at â„‚ f z) (hy : tendsto f (ğ“[{c}á¶œ] c) (ğ“ y)) :
  âˆ® z in C(c, R), (z - c)â»Â¹ â€¢ f z = (2 * Ï€ * I : â„‚) â€¢ y :=
begin
  rw [â† sub_eq_zero, â† norm_le_zero_iff],
  refine le_of_forall_le_of_dense (Î» Îµ Îµ0, _),
  obtain âŸ¨Î´, Î´0, hÎ´âŸ© :
    âˆƒ Î´ > (0 : â„), âˆ€ z âˆˆ closed_ball c Î´ \ {c}, dist (f z) y < Îµ / (2 * Ï€),
    from ((nhds_within_has_basis nhds_basis_closed_ball _).tendsto_iff nhds_basis_ball).1 hy _
      (div_pos Îµ0 real.two_pi_pos),
  obtain âŸ¨r, hr0, hrÎ´, hrRâŸ© : âˆƒ r, 0 < r âˆ§ r â‰¤ Î´ âˆ§ r â‰¤ R :=
    âŸ¨min Î´ R, lt_min Î´0 h0, min_le_left _ _, min_le_right _ _âŸ©,
  have hsub : closed_ball c R \ ball c r âŠ† closed_ball c R \ {c},
    from diff_subset_diff_right (singleton_subset_iff.2 $ mem_ball_self hr0),
  have hsub' : ball c R \ closed_ball c r âŠ† ball c R \ {c},
    from diff_subset_diff_right (singleton_subset_iff.2 $ mem_closed_ball_self hr0.le),
  have hzne : âˆ€ z âˆˆ sphere c r, z â‰  c,
    from Î» z hz, ne_of_mem_of_not_mem hz (Î» h, hr0.ne' $ dist_self c â–¸ eq.symm h),
  calc âˆ¥(âˆ® z in C(c, R), (z - c)â»Â¹ â€¢ f z) - (2 * â†‘Ï€ * I) â€¢ yâˆ¥
      = âˆ¥(âˆ® z in C(c, r), (z - c)â»Â¹ â€¢ f z) - âˆ® z in C(c, r), (z - c)â»Â¹ â€¢ yâˆ¥ :
    begin
      congr' 2,
      { exact circle_integral_sub_center_inv_smul_eq_of_differentiable_on_annulus_off_countable
          hr0 hrR hs (hc.mono hsub) (Î» z hz, hd z âŸ¨hsub' hz.1, hz.2âŸ©) },
      { simp [hr0.ne'] }
    end
  ... = âˆ¥âˆ® z in C(c, r), (z - c)â»Â¹ â€¢ (f z - y)âˆ¥ :
    begin
      simp only [smul_sub],
      have hc' : continuous_on (Î» z, (z - c)â»Â¹) (sphere c r),
        from (continuous_on_id.sub continuous_on_const).invâ‚€ (Î» z hz, sub_ne_zero.2 $ hzne _ hz),
      rw circle_integral.integral_sub; refine (hc'.smul _).circle_integrable hr0.le,
      { exact hc.mono (subset_inter (sphere_subset_closed_ball.trans $
          closed_ball_subset_closed_ball hrR) hzne) },
      { exact continuous_on_const }
    end
  ... â‰¤ 2 * Ï€ * r * (râ»Â¹ * (Îµ / (2 * Ï€))) :
    begin
      refine circle_integral.norm_integral_le_of_norm_le_const hr0.le (Î» z hz, _),
      specialize hzne z hz,
      rw [mem_sphere, dist_eq_norm] at hz,
      rw [norm_smul, norm_inv, hz, â† dist_eq_norm],
      refine mul_le_mul_of_nonneg_left (hÎ´ _ âŸ¨_, hzneâŸ©).le (inv_nonneg.2 hr0.le),
      rwa [mem_closed_ball_iff_norm, hz]
    end
  ... = Îµ : by { field_simp [hr0.ne', real.two_pi_pos.ne'], ac_refl }
end
lemma circle_integral_sub_center_inv_smul_of_differentiable_on_off_countable {R : â„} (h0 : 0 < R)
  {f : â„‚ â†’ E} {c : â„‚} {s : set â„‚} (hs : s.countable)
  (hc : continuous_on f (closed_ball c R)) (hd : âˆ€ z âˆˆ ball c R \ s, differentiable_at â„‚ f z) :
  âˆ® z in C(c, R), (z - c)â»Â¹ â€¢ f z = (2 * Ï€ * I : â„‚) â€¢ f c :=
circle_integral_sub_center_inv_smul_of_differentiable_on_off_countable_of_tendsto h0 hs
  (hc.mono $ diff_subset _ _) (Î» z hz, hd z âŸ¨hz.1.1, hz.2âŸ©)
  (hc.continuous_at $ closed_ball_mem_nhds _ h0).continuous_within_at
lemma circle_integral_eq_zero_of_differentiable_on_off_countable {R : â„} (h0 : 0 â‰¤ R) {f : â„‚ â†’ E}
  {c : â„‚} {s : set â„‚} (hs : s.countable) (hc : continuous_on f (closed_ball c R))
  (hd : âˆ€ z âˆˆ ball c R \ s, differentiable_at â„‚ f z) :
  âˆ® z in C(c, R), f z = 0 :=
begin
  rcases h0.eq_or_lt with rfl|h0, { apply circle_integral.integral_radius_zero },
  calc âˆ® z in C(c, R), f z = âˆ® z in C(c, R), (z - c)â»Â¹ â€¢ (z - c) â€¢ f z :
    (circle_integral.integral_sub_inv_smul_sub_smul _ _ _ _).symm
  ... = (2 * â†‘Ï€ * I : â„‚) â€¢ (c - c) â€¢ f c :
    circle_integral_sub_center_inv_smul_of_differentiable_on_off_countable h0 hs
      ((continuous_on_id.sub continuous_on_const).smul hc)
      (Î» z hz, (differentiable_at_id.sub_const _).smul (hd z hz))
  ... = 0 : by rw [sub_self, zero_smul, smul_zero]
end
lemma circle_integral_sub_inv_smul_of_differentiable_on_off_countable_aux {R : â„} {c w : â„‚}
  {f : â„‚ â†’ E} {s : set â„‚} (hs : s.countable) (hw : w âˆˆ ball c R \ s)
  (hc : continuous_on f (closed_ball c R)) (hd : âˆ€ x âˆˆ ball c R \ s, differentiable_at â„‚ f x) :
  âˆ® z in C(c, R), (z - w)â»Â¹ â€¢ f z = (2 * Ï€ * I : â„‚) â€¢ f w :=
begin
  have hR : 0 < R := dist_nonneg.trans_lt hw.1,
  set F : â„‚ â†’ E := dslope f w,
  have hws : (insert w s).countable := hs.insert w,
  have hnhds : closed_ball c R âˆˆ ğ“ w, from closed_ball_mem_nhds_of_mem hw.1,
  have hcF : continuous_on F (closed_ball c R),
    from (continuous_on_dslope $ closed_ball_mem_nhds_of_mem hw.1).2 âŸ¨hc, hd _ hwâŸ©,
  have hdF : âˆ€ z âˆˆ ball (c : â„‚) R \ (insert w s), differentiable_at â„‚ F z,
    from Î» z hz, (differentiable_at_dslope_of_ne
      (ne_of_mem_of_not_mem (mem_insert _ _) hz.2).symm).2
      (hd _ (diff_subset_diff_right (subset_insert _ _) hz)),
  have HI := circle_integral_eq_zero_of_differentiable_on_off_countable hR.le hws hcF hdF,
  have hne : âˆ€ z âˆˆ sphere c R, z â‰  w, from Î» z hz, ne_of_mem_of_not_mem hz (ne_of_lt hw.1),
  have hFeq : eq_on F (Î» z, (z - w)â»Â¹ â€¢ f z - (z - w)â»Â¹ â€¢ f w) (sphere c R),
  { intros z hz,
    calc F z = (z - w)â»Â¹ â€¢ (f z - f w) : update_noteq (hne z hz) _ _
    ... = (z - w)â»Â¹ â€¢ f z - (z - w)â»Â¹ â€¢ f w : smul_sub _ _ _ },
  have hc' : continuous_on (Î» z, (z - w)â»Â¹) (sphere c R),
    from (continuous_on_id.sub continuous_on_const).invâ‚€ (Î» z hz, sub_ne_zero.2 $ hne z hz),
  rw [â† circle_integral.integral_sub_inv_of_mem_ball hw.1, â† circle_integral.integral_smul_const,
    â† sub_eq_zero, â† circle_integral.integral_sub, â† circle_integral.integral_congr hR.le hFeq, HI],
  exacts [(hc'.smul (hc.mono sphere_subset_closed_ball)).circle_integrable hR.le,
    (hc'.smul continuous_on_const).circle_integrable hR.le]
end
lemma two_pi_I_inv_smul_circle_integral_sub_inv_smul_of_differentiable_on_off_countable
  {R : â„} {c w : â„‚} {f : â„‚ â†’ E} {s : set â„‚} (hs : s.countable) (hw : w âˆˆ ball c R)
  (hc : continuous_on f (closed_ball c R)) (hd : âˆ€ x âˆˆ ball c R \ s, differentiable_at â„‚ f x) :
  (2 * Ï€ * I : â„‚)â»Â¹ â€¢ âˆ® z in C(c, R), (z - w)â»Â¹ â€¢ f z = f w :=
begin
  have hR : 0 < R := dist_nonneg.trans_lt hw,
  suffices : w âˆˆ closure (ball c R \ s),
  { lift R to â„â‰¥0 using hR.le,
    have A : continuous_at (Î» w, (2 * Ï€ * I : â„‚)â»Â¹ â€¢ âˆ® z in C(c, R), (z - w)â»Â¹ â€¢ f z) w,
    { have := has_fpower_series_on_cauchy_integral
      ((hc.mono sphere_subset_closed_ball).circle_integrable R.coe_nonneg) hR,
      refine this.continuous_on.continuous_at (emetric.is_open_ball.mem_nhds _),
      rwa metric.emetric_ball_nnreal },
    have B : continuous_at f w, from hc.continuous_at (closed_ball_mem_nhds_of_mem hw),
    refine tendsto_nhds_unique_of_frequently_eq A B ((mem_closure_iff_frequently.1 this).mono _),
    intros z hz,
    rw [circle_integral_sub_inv_smul_of_differentiable_on_off_countable_aux hs hz hc hd,
      inv_smul_smulâ‚€],
    simp [real.pi_ne_zero, I_ne_zero] },
  refine mem_closure_iff_nhds.2 (Î» t ht, _),
lemma circle_integral_sub_inv_smul_of_differentiable_on_off_countable
  {R : â„} {c w : â„‚} {f : â„‚ â†’ E} {s : set â„‚} (hs : s.countable) (hw : w âˆˆ ball c R)
  (hc : continuous_on f (closed_ball c R)) (hd : âˆ€ x âˆˆ ball c R \ s, differentiable_at â„‚ f x) :
  âˆ® z in C(c, R), (z - w)â»Â¹ â€¢ f z = (2 * Ï€ * I : â„‚) â€¢ f w :=
by { rw [â† two_pi_I_inv_smul_circle_integral_sub_inv_smul_of_differentiable_on_off_countable
  hs hw hc hd, smul_inv_smulâ‚€], simp [real.pi_ne_zero, I_ne_zero] }
lemma _root_.diff_cont_on_cl.circle_integral_sub_inv_smul {R : â„} {c w : â„‚} {f : â„‚ â†’ E}
  (h : diff_cont_on_cl â„‚ f (ball c R)) (hw : w âˆˆ ball c R) :
  âˆ® z in C(c, R), (z - w)â»Â¹ â€¢ f z = (2 * Ï€ * I : â„‚) â€¢ f w :=
circle_integral_sub_inv_smul_of_differentiable_on_off_countable countable_empty hw
  h.continuous_on_ball $ Î» x hx, h.differentiable_at is_open_ball hx.1
lemma _root_.differentiable_on.circle_integral_sub_inv_smul {R : â„} {c w : â„‚} {f : â„‚ â†’ E}
  (hd : differentiable_on â„‚ f (closed_ball c R)) (hw : w âˆˆ ball c R)  :
  âˆ® z in C(c, R), (z - w)â»Â¹ â€¢ f z = (2 * Ï€ * I : â„‚) â€¢ f w :=
(hd.mono closure_ball_subset_closed_ball).diff_cont_on_cl.circle_integral_sub_inv_smul hw
lemma circle_integral_div_sub_of_differentiable_on_off_countable {R : â„} {c w : â„‚} {s : set â„‚}
  (hs : s.countable) (hw : w âˆˆ ball c R) {f : â„‚ â†’ â„‚} (hc : continuous_on f (closed_ball c R))
  (hd : âˆ€ z âˆˆ ball c R \ s, differentiable_at â„‚ f z) :
  âˆ® z in C(c, R), f z / (z - w) = 2 * Ï€ * I * f w :=
by simpa only [smul_eq_mul, div_eq_inv_mul]
  using circle_integral_sub_inv_smul_of_differentiable_on_off_countable hs hw hc hd
lemma has_fpower_series_on_ball_of_differentiable_off_countable {R : â„â‰¥0} {c : â„‚} {f : â„‚ â†’ E}
  {s : set â„‚} (hs : s.countable) (hc : continuous_on f (closed_ball c R))
  (hd : âˆ€ z âˆˆ ball c R \ s, differentiable_at â„‚ f z) (hR : 0 < R) :
  has_fpower_series_on_ball f (cauchy_power_series f c R) c R :=
{ r_le := le_radius_cauchy_power_series _ _ _,
  r_pos := ennreal.coe_pos.2 hR,
  has_sum := Î» w hw,
    begin
      have hw' : c + w âˆˆ ball c R,
        by simpa only [add_mem_ball_iff_norm, â† coe_nnnorm, mem_emetric_ball_zero_iff,
          nnreal.coe_lt_coe, ennreal.coe_lt_coe] using hw,
      rw â† two_pi_I_inv_smul_circle_integral_sub_inv_smul_of_differentiable_on_off_countable hs
        hw' hc hd,
      exact (has_fpower_series_on_cauchy_integral
        ((hc.mono sphere_subset_closed_ball).circle_integrable R.2) hR).has_sum hw
    end }
lemma _root_.diff_cont_on_cl.has_fpower_series_on_ball {R : â„â‰¥0} {c : â„‚} {f : â„‚ â†’ E}
  (hf : diff_cont_on_cl â„‚ f (ball c R)) (hR : 0 < R) :
  has_fpower_series_on_ball f (cauchy_power_series f c R) c R :=
has_fpower_series_on_ball_of_differentiable_off_countable countable_empty hf.continuous_on_ball
  (Î» z hz, hf.differentiable_at is_open_ball hz.1) hR
protected lemma _root_.differentiable_on.has_fpower_series_on_ball {R : â„â‰¥0} {c : â„‚} {f : â„‚ â†’ E}
  (hd : differentiable_on â„‚ f (closed_ball c R)) (hR : 0 < R) :
  has_fpower_series_on_ball f (cauchy_power_series f c R) c R :=
(hd.mono closure_ball_subset_closed_ball).diff_cont_on_cl.has_fpower_series_on_ball hR
protected lemma _root_.differentiable_on.analytic_at {s : set â„‚} {f : â„‚ â†’ E} {z : â„‚}
  (hd : differentiable_on â„‚ f s) (hz : s âˆˆ ğ“ z) : analytic_at â„‚ f z :=
begin
  rcases nhds_basis_closed_ball.mem_iff.1 hz with âŸ¨R, hR0, hRsâŸ©,
  lift R to â„â‰¥0 using hR0.le,
  exact ((hd.mono hRs).has_fpower_series_on_ball hR0).analytic_at
end
protected lemma _root_.differentiable.analytic_at {f : â„‚ â†’ E} (hf : differentiable â„‚ f) (z : â„‚) :
  analytic_at â„‚ f z :=
hf.differentiable_on.analytic_at univ_mem
protected lemma _root_.differentiable.has_fpower_series_on_ball {f : â„‚ â†’ E}
  (h : differentiable â„‚ f) (z : â„‚) {R : â„â‰¥0} (hR : 0 < R) :
  has_fpower_series_on_ball f (cauchy_power_series f z R) z âˆ :=
(h.differentiable_on.has_fpower_series_on_ball hR).r_eq_top_of_exists $ Î» r hr,
  âŸ¨_, h.differentiable_on.has_fpower_series_on_ball hrâŸ©
end complex
