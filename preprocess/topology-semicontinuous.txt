import algebra.indicator_function
import topology.algebra.group
import topology.continuous_on
import topology.instances.ennreal
open_locale topological_space big_operators ennreal
open set
variables {Î± : Type*} [topological_space Î±] {Î² : Type*} [preorder Î²]
{f g : Î± â†’ Î²} {x : Î±} {s t : set Î±} {y z : Î²}
def lower_semicontinuous_within_at (f : Î± â†’ Î²) (s : set Î±) (x : Î±) :=
âˆ€ y < f x, âˆ€á¶  x' in ð“[s] x, y < f x'
def lower_semicontinuous_on (f : Î± â†’ Î²) (s : set Î±) :=
âˆ€ x âˆˆ s, lower_semicontinuous_within_at f s x
def lower_semicontinuous_at (f : Î± â†’ Î²) (x : Î±) :=
âˆ€ y < f x, âˆ€á¶  x' in ð“ x, y < f x'
def lower_semicontinuous (f : Î± â†’ Î²) :=
âˆ€ x, lower_semicontinuous_at f x
def upper_semicontinuous_within_at (f : Î± â†’ Î²) (s : set Î±) (x : Î±) :=
âˆ€ y, f x < y â†’ âˆ€á¶  x' in ð“[s] x, f x' < y
def upper_semicontinuous_on (f : Î± â†’ Î²) (s : set Î±) :=
âˆ€ x âˆˆ s, upper_semicontinuous_within_at f s x
def upper_semicontinuous_at (f : Î± â†’ Î²) (x : Î±) :=
âˆ€ y, f x < y â†’ âˆ€á¶  x' in ð“ x, f x' < y
def upper_semicontinuous (f : Î± â†’ Î²) :=
âˆ€ x, upper_semicontinuous_at f x
lemma lower_semicontinuous_within_at.mono (h : lower_semicontinuous_within_at f s x)
  (hst : t âŠ† s) : lower_semicontinuous_within_at f t x :=
Î» y hy, filter.eventually.filter_mono (nhds_within_mono _ hst) (h y hy)
lemma lower_semicontinuous_within_at_univ_iff :
  lower_semicontinuous_within_at f univ x â†” lower_semicontinuous_at f x :=
by simp [lower_semicontinuous_within_at, lower_semicontinuous_at, nhds_within_univ]
lemma lower_semicontinuous_at.lower_semicontinuous_within_at
  (s : set Î±) (h : lower_semicontinuous_at f x) : lower_semicontinuous_within_at f s x :=
Î» y hy, filter.eventually.filter_mono nhds_within_le_nhds (h y hy)
lemma lower_semicontinuous_on.lower_semicontinuous_within_at
  (h : lower_semicontinuous_on f s) (hx : x âˆˆ s) :
  lower_semicontinuous_within_at f s x :=
h x hx
lemma lower_semicontinuous_on.mono (h : lower_semicontinuous_on f s) (hst : t âŠ† s) :
  lower_semicontinuous_on f t :=
Î» x hx, (h x (hst hx)).mono hst
lemma lower_semicontinuous_on_univ_iff :
  lower_semicontinuous_on f univ â†” lower_semicontinuous f :=
by simp [lower_semicontinuous_on, lower_semicontinuous, lower_semicontinuous_within_at_univ_iff]
lemma lower_semicontinuous.lower_semicontinuous_at
  (h : lower_semicontinuous f) (x : Î±) : lower_semicontinuous_at f x :=
h x
lemma lower_semicontinuous.lower_semicontinuous_within_at
  (h : lower_semicontinuous f) (s : set Î±) (x : Î±) : lower_semicontinuous_within_at f s x :=
(h x).lower_semicontinuous_within_at s
lemma lower_semicontinuous.lower_semicontinuous_on
  (h : lower_semicontinuous f) (s : set Î±) : lower_semicontinuous_on f s :=
Î» x hx, h.lower_semicontinuous_within_at s x
lemma lower_semicontinuous_within_at_const :
  lower_semicontinuous_within_at (Î» x, z) s x :=
Î» y hy, filter.eventually_of_forall (Î» x, hy)
lemma lower_semicontinuous_at_const :
  lower_semicontinuous_at (Î» x, z) x :=
Î» y hy, filter.eventually_of_forall (Î» x, hy)
lemma lower_semicontinuous_on_const :
  lower_semicontinuous_on (Î» x, z) s :=
Î» x hx, lower_semicontinuous_within_at_const
lemma lower_semicontinuous_const :
  lower_semicontinuous (Î» (x : Î±), z) :=
Î» x, lower_semicontinuous_at_const
section
variables [has_zero Î²]
lemma is_open.lower_semicontinuous_indicator (hs : is_open s) (hy : 0 â‰¤ y) :
  lower_semicontinuous (indicator s (Î» x, y)) :=
begin
  assume x z hz,
  by_cases h : x âˆˆ s; simp [h] at hz,
  { filter_upwards [hs.mem_nhds h],
    simp [hz] { contextual := tt} },
  { apply filter.eventually_of_forall (Î» x', _),
    by_cases h' : x' âˆˆ s;
    simp [h', hz.trans_le hy, hz] }
end
lemma is_open.lower_semicontinuous_on_indicator (hs : is_open s) (hy : 0 â‰¤ y) :
  lower_semicontinuous_on (indicator s (Î» x, y)) t :=
(hs.lower_semicontinuous_indicator hy).lower_semicontinuous_on t
lemma is_open.lower_semicontinuous_at_indicator (hs : is_open s) (hy : 0 â‰¤ y) :
  lower_semicontinuous_at (indicator s (Î» x, y)) x :=
(hs.lower_semicontinuous_indicator hy).lower_semicontinuous_at x
lemma is_open.lower_semicontinuous_within_at_indicator (hs : is_open s) (hy : 0 â‰¤ y) :
  lower_semicontinuous_within_at (indicator s (Î» x, y)) t x :=
(hs.lower_semicontinuous_indicator hy).lower_semicontinuous_within_at t x
lemma is_closed.lower_semicontinuous_indicator (hs : is_closed s) (hy : y â‰¤ 0) :
  lower_semicontinuous (indicator s (Î» x, y)) :=
begin
  assume x z hz,
  by_cases h : x âˆˆ s; simp [h] at hz,
  { apply filter.eventually_of_forall (Î» x', _),
    by_cases h' : x' âˆˆ s;
    simp [h', hz, hz.trans_le hy], },
  { filter_upwards [hs.is_open_compl.mem_nhds h],
    simp [hz] { contextual := tt } }
end
lemma is_closed.lower_semicontinuous_on_indicator (hs : is_closed s) (hy : y â‰¤ 0) :
  lower_semicontinuous_on (indicator s (Î» x, y)) t :=
(hs.lower_semicontinuous_indicator hy).lower_semicontinuous_on t
lemma is_closed.lower_semicontinuous_at_indicator (hs : is_closed s) (hy : y â‰¤ 0) :
  lower_semicontinuous_at (indicator s (Î» x, y)) x :=
(hs.lower_semicontinuous_indicator hy).lower_semicontinuous_at x
lemma is_closed.lower_semicontinuous_within_at_indicator (hs : is_closed s) (hy : y â‰¤ 0) :
  lower_semicontinuous_within_at (indicator s (Î» x, y)) t x :=
(hs.lower_semicontinuous_indicator hy).lower_semicontinuous_within_at t x
end
theorem lower_semicontinuous_iff_is_open :
  lower_semicontinuous f â†” âˆ€ y, is_open (f â»Â¹' (Ioi y)) :=
âŸ¨Î» H y, is_open_iff_mem_nhds.2 (Î» x hx, H x y hx), Î» H x y y_lt, is_open.mem_nhds (H y) y_ltâŸ©
lemma lower_semicontinuous.is_open_preimage (hf : lower_semicontinuous f) (y : Î²) :
  is_open (f â»Â¹' (Ioi y)) :=
lower_semicontinuous_iff_is_open.1 hf y
section
variables {Î³ : Type*} [linear_order Î³] [topological_space Î³] [order_topology Î³]
lemma continuous_within_at.lower_semicontinuous_within_at {f : Î± â†’ Î³}
  (h : continuous_within_at f s x) : lower_semicontinuous_within_at f s x :=
Î» y hy, h (Ioi_mem_nhds hy)
lemma continuous_at.lower_semicontinuous_at {f : Î± â†’ Î³}
  (h : continuous_at f x) : lower_semicontinuous_at f x :=
Î» y hy, h (Ioi_mem_nhds hy)
lemma continuous_on.lower_semicontinuous_on {f : Î± â†’ Î³}
  (h : continuous_on f s) : lower_semicontinuous_on f s :=
Î» x hx, (h x hx).lower_semicontinuous_within_at
lemma continuous.lower_semicontinuous {f : Î± â†’ Î³}
  (h : continuous f) : lower_semicontinuous f :=
Î» x, h.continuous_at.lower_semicontinuous_at
end
section
variables {Î³ : Type*} [linear_order Î³] [topological_space Î³] [order_topology Î³]
variables {Î´ : Type*} [linear_order Î´] [topological_space Î´] [order_topology Î´]
lemma continuous_at.comp_lower_semicontinuous_within_at
  {g : Î³ â†’ Î´} {f : Î± â†’ Î³} (hg : continuous_at g (f x)) (hf : lower_semicontinuous_within_at f s x)
  (gmon : monotone g) : lower_semicontinuous_within_at (g âˆ˜ f) s x :=
begin
  assume y hy,
  by_cases h : âˆƒ l, l < f x,
  { obtain âŸ¨z, zlt, hzâŸ© : âˆƒ z < f x, Ioc z (f x) âŠ† g â»Â¹' (Ioi y) :=
      exists_Ioc_subset_of_mem_nhds (hg (Ioi_mem_nhds hy)) h,
    filter_upwards [hf z zlt] with a ha,
    calc y < g (min (f x) (f a)) : hz (by simp [zlt, ha, le_refl])
    ... â‰¤ g (f a) : gmon (min_le_right _ _) },
  { simp only [not_exists, not_lt] at h,
    exact filter.eventually_of_forall (Î» a, hy.trans_le (gmon (h (f a)))) }
end
lemma continuous_at.comp_lower_semicontinuous_at
  {g : Î³ â†’ Î´} {f : Î± â†’ Î³} (hg : continuous_at g (f x)) (hf : lower_semicontinuous_at f x)
  (gmon : monotone g) : lower_semicontinuous_at (g âˆ˜ f) x :=
begin
  simp only [â† lower_semicontinuous_within_at_univ_iff] at hf âŠ¢,
  exact hg.comp_lower_semicontinuous_within_at hf gmon
end
lemma continuous.comp_lower_semicontinuous_on
  {g : Î³ â†’ Î´} {f : Î± â†’ Î³} (hg : continuous g) (hf : lower_semicontinuous_on f s)
  (gmon : monotone g) : lower_semicontinuous_on (g âˆ˜ f) s :=
Î» x hx, (hg.continuous_at).comp_lower_semicontinuous_within_at (hf x hx) gmon
lemma continuous.comp_lower_semicontinuous
  {g : Î³ â†’ Î´} {f : Î± â†’ Î³} (hg : continuous g) (hf : lower_semicontinuous f)
  (gmon : monotone g) : lower_semicontinuous (g âˆ˜ f) :=
Î» x, (hg.continuous_at).comp_lower_semicontinuous_at (hf x) gmon
lemma continuous_at.comp_lower_semicontinuous_within_at_antitone
  {g : Î³ â†’ Î´} {f : Î± â†’ Î³} (hg : continuous_at g (f x)) (hf : lower_semicontinuous_within_at f s x)
  (gmon : antitone g) : upper_semicontinuous_within_at (g âˆ˜ f) s x :=
@continuous_at.comp_lower_semicontinuous_within_at Î± _ x s Î³ _ _ _ Î´áµ’áµˆ _ _ _ g f hg hf gmon
lemma continuous_at.comp_lower_semicontinuous_at_antitone
  {g : Î³ â†’ Î´} {f : Î± â†’ Î³} (hg : continuous_at g (f x)) (hf : lower_semicontinuous_at f x)
  (gmon : antitone g) : upper_semicontinuous_at (g âˆ˜ f) x :=
@continuous_at.comp_lower_semicontinuous_at Î± _ x Î³ _ _ _ Î´áµ’áµˆ _ _ _ g f hg hf gmon
lemma continuous.comp_lower_semicontinuous_on_antitone
  {g : Î³ â†’ Î´} {f : Î± â†’ Î³} (hg : continuous g) (hf : lower_semicontinuous_on f s)
  (gmon : antitone g) : upper_semicontinuous_on (g âˆ˜ f) s :=
Î» x hx, (hg.continuous_at).comp_lower_semicontinuous_within_at_antitone (hf x hx) gmon
lemma continuous.comp_lower_semicontinuous_antitone
  {g : Î³ â†’ Î´} {f : Î± â†’ Î³} (hg : continuous g) (hf : lower_semicontinuous f)
  (gmon : antitone g) : upper_semicontinuous (g âˆ˜ f) :=
Î» x, (hg.continuous_at).comp_lower_semicontinuous_at_antitone (hf x) gmon
end
section
variables {Î¹ : Type*} {Î³ : Type*} [linear_ordered_add_comm_monoid Î³]
[topological_space Î³] [order_topology Î³]
lemma lower_semicontinuous_within_at.add' {f g : Î± â†’ Î³}
  (hf : lower_semicontinuous_within_at f s x) (hg : lower_semicontinuous_within_at g s x)
  (hcont : continuous_at (Î» (p : Î³ Ã— Î³), p.1 + p.2) (f x, g x)) :
  lower_semicontinuous_within_at (Î» z, f z + g z) s x :=
begin
  assume y hy,
  obtain âŸ¨u, v, u_open, xu, v_open, xv, hâŸ© : âˆƒ (u v : set Î³), is_open u âˆ§ f x âˆˆ u âˆ§ is_open v âˆ§
    g x âˆˆ v âˆ§ u Ã—Ë¢ v âŠ† {p : Î³ Ã— Î³ | y < p.fst + p.snd} :=
  mem_nhds_prod_iff'.1 (hcont (is_open_Ioi.mem_nhds hy)),
  by_cases hxâ‚ : âˆƒ l, l < f x,
  { obtain âŸ¨zâ‚, zâ‚lt, hâ‚âŸ© : âˆƒ zâ‚ < f x, Ioc zâ‚ (f x) âŠ† u :=
      exists_Ioc_subset_of_mem_nhds (u_open.mem_nhds xu) hxâ‚,
    by_cases hxâ‚‚ : âˆƒ l, l < g x,
    { obtain âŸ¨zâ‚‚, zâ‚‚lt, hâ‚‚âŸ© : âˆƒ zâ‚‚ < g x, Ioc zâ‚‚ (g x) âŠ† v :=
        exists_Ioc_subset_of_mem_nhds (v_open.mem_nhds xv) hxâ‚‚,
      filter_upwards [hf zâ‚ zâ‚lt, hg zâ‚‚ zâ‚‚lt] with z hâ‚z hâ‚‚z,
      have A1 : min (f z) (f x) âˆˆ u,
      { by_cases H : f z â‰¤ f x,
        { simp [H], exact hâ‚ âŸ¨hâ‚z, HâŸ© },
        { simp [le_of_not_le H], exact hâ‚ âŸ¨zâ‚lt, le_rflâŸ©, } },
      have A2 : min (g z) (g x) âˆˆ v,
      { by_cases H : g z â‰¤ g x,
        { simp [H], exact hâ‚‚ âŸ¨hâ‚‚z, HâŸ© },
        { simp [le_of_not_le H], exact hâ‚‚ âŸ¨zâ‚‚lt, le_rflâŸ©, } },
      have : (min (f z) (f x), min (g z) (g x)) âˆˆ u Ã—Ë¢ v := âŸ¨A1, A2âŸ©,
      calc y < min (f z) (f x) + min (g z) (g x) : h this
      ... â‰¤ f z + g z : add_le_add (min_le_left _ _) (min_le_left _ _) },
    { simp only [not_exists, not_lt] at hxâ‚‚,
      filter_upwards [hf zâ‚ zâ‚lt] with z hâ‚z,
      have A1 : min (f z) (f x) âˆˆ u,
      { by_cases H : f z â‰¤ f x,
        { simp [H], exact hâ‚ âŸ¨hâ‚z, HâŸ© },
        { simp [le_of_not_le H], exact hâ‚ âŸ¨zâ‚lt, le_rflâŸ©, } },
      have : (min (f z) (f x), g x) âˆˆ u Ã—Ë¢ v := âŸ¨A1, xvâŸ©,
      calc y < min (f z) (f x) + g x : h this
      ... â‰¤ f z + g z : add_le_add (min_le_left _ _) (hxâ‚‚ (g z)) } },
  { simp only [not_exists, not_lt] at hxâ‚,
    by_cases hxâ‚‚ : âˆƒ l, l < g x,
    { obtain âŸ¨zâ‚‚, zâ‚‚lt, hâ‚‚âŸ© : âˆƒ zâ‚‚ < g x, Ioc zâ‚‚ (g x) âŠ† v :=
        exists_Ioc_subset_of_mem_nhds (v_open.mem_nhds xv) hxâ‚‚,
      filter_upwards [hg zâ‚‚ zâ‚‚lt] with z hâ‚‚z,
      have A2 : min (g z) (g x) âˆˆ v,
      { by_cases H : g z â‰¤ g x,
        { simp [H], exact hâ‚‚ âŸ¨hâ‚‚z, HâŸ© },
        { simp [le_of_not_le H], exact hâ‚‚ âŸ¨zâ‚‚lt, le_rflâŸ©, } },
      have : (f x, min (g z) (g x)) âˆˆ u Ã—Ë¢ v := âŸ¨xu, A2âŸ©,
      calc y < f x + min (g z) (g x) : h this
      ... â‰¤ f z + g z : add_le_add (hxâ‚ (f z)) (min_le_left _ _) },
    { simp only [not_exists, not_lt] at hxâ‚ hxâ‚‚,
      apply filter.eventually_of_forall,
      assume z,
      have : (f x, g x) âˆˆ u Ã—Ë¢ v := âŸ¨xu, xvâŸ©,
      calc y < f x + g x : h this
      ... â‰¤ f z + g z : add_le_add (hxâ‚ (f z)) (hxâ‚‚ (g z)) } },
end
lemma lower_semicontinuous_at.add' {f g : Î± â†’ Î³}
  (hf : lower_semicontinuous_at f x) (hg : lower_semicontinuous_at g x)
  (hcont : continuous_at (Î» (p : Î³ Ã— Î³), p.1 + p.2) (f x, g x)) :
  lower_semicontinuous_at (Î» z, f z + g z) x :=
by { simp_rw [â† lower_semicontinuous_within_at_univ_iff] at *, exact hf.add' hg hcont }
lemma lower_semicontinuous_on.add' {f g : Î± â†’ Î³}
  (hf : lower_semicontinuous_on f s) (hg : lower_semicontinuous_on g s)
  (hcont : âˆ€ x âˆˆ s, continuous_at (Î» (p : Î³ Ã— Î³), p.1 + p.2) (f x, g x)) :
  lower_semicontinuous_on (Î» z, f z + g z) s :=
Î» x hx, (hf x hx).add' (hg x hx) (hcont x hx)
lemma lower_semicontinuous.add' {f g : Î± â†’ Î³}
  (hf : lower_semicontinuous f) (hg : lower_semicontinuous g)
  (hcont : âˆ€ x, continuous_at (Î» (p : Î³ Ã— Î³), p.1 + p.2) (f x, g x)) :
  lower_semicontinuous (Î» z, f z + g z) :=
Î» x, (hf x).add' (hg x) (hcont x)
variable [has_continuous_add Î³]
lemma lower_semicontinuous_within_at.add {f g : Î± â†’ Î³}
  (hf : lower_semicontinuous_within_at f s x) (hg : lower_semicontinuous_within_at g s x) :
  lower_semicontinuous_within_at (Î» z, f z + g z) s x :=
hf.add' hg continuous_add.continuous_at
lemma lower_semicontinuous_at.add {f g : Î± â†’ Î³}
  (hf : lower_semicontinuous_at f x) (hg : lower_semicontinuous_at g x) :
  lower_semicontinuous_at (Î» z, f z + g z) x :=
hf.add' hg continuous_add.continuous_at
lemma lower_semicontinuous_on.add {f g : Î± â†’ Î³}
  (hf : lower_semicontinuous_on f s) (hg : lower_semicontinuous_on g s) :
  lower_semicontinuous_on (Î» z, f z + g z) s :=
hf.add' hg (Î» x hx, continuous_add.continuous_at)
lemma lower_semicontinuous.add {f g : Î± â†’ Î³}
  (hf : lower_semicontinuous f) (hg : lower_semicontinuous g) :
  lower_semicontinuous (Î» z, f z + g z) :=
hf.add' hg (Î» x, continuous_add.continuous_at)
lemma lower_semicontinuous_within_at_sum {f : Î¹ â†’ Î± â†’ Î³} {a : finset Î¹}
  (ha : âˆ€ i âˆˆ a, lower_semicontinuous_within_at (f i) s x) :
  lower_semicontinuous_within_at (Î» z, (âˆ‘ i in a, f i z)) s x :=
begin
  classical,
  induction a using finset.induction_on with i a ia IH generalizing ha,
  { exact lower_semicontinuous_within_at_const },
  { simp only [ia, finset.sum_insert, not_false_iff],
    exact lower_semicontinuous_within_at.add (ha _ (finset.mem_insert_self i a))
      (IH (Î» j ja, ha j (finset.mem_insert_of_mem ja))) }
end
lemma lower_semicontinuous_at_sum {f : Î¹ â†’ Î± â†’ Î³} {a : finset Î¹}
  (ha : âˆ€ i âˆˆ a, lower_semicontinuous_at (f i) x) :
  lower_semicontinuous_at (Î» z, (âˆ‘ i in a, f i z)) x :=
begin
  simp_rw [â† lower_semicontinuous_within_at_univ_iff] at *,
  exact lower_semicontinuous_within_at_sum ha
end
lemma lower_semicontinuous_on_sum {f : Î¹ â†’ Î± â†’ Î³} {a : finset Î¹}
  (ha : âˆ€ i âˆˆ a, lower_semicontinuous_on (f i) s) :
  lower_semicontinuous_on (Î» z, (âˆ‘ i in a, f i z)) s :=
Î» x hx, lower_semicontinuous_within_at_sum (Î» i hi, ha i hi x hx)
lemma lower_semicontinuous_sum {f : Î¹ â†’ Î± â†’ Î³} {a : finset Î¹}
  (ha : âˆ€ i âˆˆ a, lower_semicontinuous (f i)) :
  lower_semicontinuous (Î» z, (âˆ‘ i in a, f i z)) :=
Î» x, lower_semicontinuous_at_sum (Î» i hi, ha i hi x)
end
section
variables {Î¹ : Sort*} {Î´ : Type*} [complete_linear_order Î´]
lemma lower_semicontinuous_within_at_supr {f : Î¹ â†’ Î± â†’ Î´}
  (h : âˆ€ i, lower_semicontinuous_within_at (f i) s x) :
  lower_semicontinuous_within_at (Î» x', â¨† i, f i x') s x :=
begin
  assume y hy,
  rcases lt_supr_iff.1 hy with âŸ¨i, hiâŸ©,
  filter_upwards [h i y hi] with _ hx' using lt_supr_iff.2 âŸ¨i, hx'âŸ©,
end
lemma lower_semicontinuous_within_at_bsupr {p : Î¹ â†’ Prop} {f : Î  i (h : p i), Î± â†’ Î´}
  (h : âˆ€ i hi, lower_semicontinuous_within_at (f i hi) s x) :
  lower_semicontinuous_within_at (Î» x', â¨† i hi, f i hi x') s x :=
lower_semicontinuous_within_at_supr $ Î» i, lower_semicontinuous_within_at_supr $ Î» hi, h i hi
lemma lower_semicontinuous_at_supr {f : Î¹ â†’ Î± â†’ Î´}
  (h : âˆ€ i, lower_semicontinuous_at (f i) x) :
  lower_semicontinuous_at (Î» x', â¨† i, f i x') x :=
begin
  simp_rw [â† lower_semicontinuous_within_at_univ_iff] at *,
  exact lower_semicontinuous_within_at_supr h
end
lemma lower_semicontinuous_at_bsupr {p : Î¹ â†’ Prop} {f : Î  i (h : p i), Î± â†’ Î´}
  (h : âˆ€ i hi, lower_semicontinuous_at (f i hi) x) :
  lower_semicontinuous_at (Î» x', â¨† i hi, f i hi x') x :=
lower_semicontinuous_at_supr $ Î» i, lower_semicontinuous_at_supr $ Î» hi, h i hi
lemma lower_semicontinuous_on_supr {f : Î¹ â†’ Î± â†’ Î´}
  (h : âˆ€ i, lower_semicontinuous_on (f i) s) :
  lower_semicontinuous_on (Î» x', â¨† i, f i x') s :=
Î» x hx, lower_semicontinuous_within_at_supr (Î» i, h i x hx)
lemma lower_semicontinuous_on_bsupr {p : Î¹ â†’ Prop} {f : Î  i (h : p i), Î± â†’ Î´}
  (h : âˆ€ i hi, lower_semicontinuous_on (f i hi) s) :
  lower_semicontinuous_on (Î» x', â¨† i hi, f i hi x') s :=
lower_semicontinuous_on_supr $ Î» i, lower_semicontinuous_on_supr $ Î» hi, h i hi
lemma lower_semicontinuous_supr {f : Î¹ â†’ Î± â†’ Î´}
  (h : âˆ€ i, lower_semicontinuous (f i)) :
  lower_semicontinuous (Î» x', â¨† i, f i x') :=
Î» x, lower_semicontinuous_at_supr (Î» i, h i x)
lemma lower_semicontinuous_bsupr {p : Î¹ â†’ Prop} {f : Î  i (h : p i), Î± â†’ Î´}
  (h : âˆ€ i hi, lower_semicontinuous (f i hi)) :
  lower_semicontinuous (Î» x', â¨† i hi, f i hi x') :=
lower_semicontinuous_supr $ Î» i, lower_semicontinuous_supr $ Î» hi, h i hi
end
section
variables {Î¹ : Type*}
lemma lower_semicontinuous_within_at_tsum {f : Î¹ â†’ Î± â†’ â„â‰¥0âˆž}
  (h : âˆ€ i, lower_semicontinuous_within_at (f i) s x) :
  lower_semicontinuous_within_at (Î» x', âˆ‘' i, f i x') s x :=
begin
  simp_rw ennreal.tsum_eq_supr_sum,
  apply lower_semicontinuous_within_at_supr (Î» b, _),
  exact lower_semicontinuous_within_at_sum (Î» i hi, h i),
end
lemma lower_semicontinuous_at_tsum {f : Î¹ â†’ Î± â†’ â„â‰¥0âˆž}
  (h : âˆ€ i, lower_semicontinuous_at (f i) x) :
  lower_semicontinuous_at (Î» x', âˆ‘' i, f i x') x :=
begin
  simp_rw [â† lower_semicontinuous_within_at_univ_iff] at *,
  exact lower_semicontinuous_within_at_tsum h
end
lemma lower_semicontinuous_on_tsum {f : Î¹ â†’ Î± â†’ â„â‰¥0âˆž}
  (h : âˆ€ i, lower_semicontinuous_on (f i) s) :
  lower_semicontinuous_on (Î» x', âˆ‘' i, f i x') s :=
Î» x hx, lower_semicontinuous_within_at_tsum (Î» i, h i x hx)
lemma lower_semicontinuous_tsum {f : Î¹ â†’ Î± â†’ â„â‰¥0âˆž}
  (h : âˆ€ i, lower_semicontinuous (f i)) :
  lower_semicontinuous (Î» x', âˆ‘' i, f i x') :=
Î» x, lower_semicontinuous_at_tsum (Î» i, h i x)
end
lemma upper_semicontinuous_within_at.mono (h : upper_semicontinuous_within_at f s x)
  (hst : t âŠ† s) : upper_semicontinuous_within_at f t x :=
Î» y hy, filter.eventually.filter_mono (nhds_within_mono _ hst) (h y hy)
lemma upper_semicontinuous_within_at_univ_iff :
  upper_semicontinuous_within_at f univ x â†” upper_semicontinuous_at f x :=
by simp [upper_semicontinuous_within_at, upper_semicontinuous_at, nhds_within_univ]
lemma upper_semicontinuous_at.upper_semicontinuous_within_at
  (s : set Î±) (h : upper_semicontinuous_at f x) : upper_semicontinuous_within_at f s x :=
Î» y hy, filter.eventually.filter_mono nhds_within_le_nhds (h y hy)
lemma upper_semicontinuous_on.upper_semicontinuous_within_at
  (h : upper_semicontinuous_on f s) (hx : x âˆˆ s) :
  upper_semicontinuous_within_at f s x :=
h x hx
lemma upper_semicontinuous_on.mono (h : upper_semicontinuous_on f s) (hst : t âŠ† s) :
  upper_semicontinuous_on f t :=
Î» x hx, (h x (hst hx)).mono hst
lemma upper_semicontinuous_on_univ_iff :
  upper_semicontinuous_on f univ â†” upper_semicontinuous f :=
by simp [upper_semicontinuous_on, upper_semicontinuous, upper_semicontinuous_within_at_univ_iff]
lemma upper_semicontinuous.upper_semicontinuous_at
  (h : upper_semicontinuous f) (x : Î±) : upper_semicontinuous_at f x :=
h x
lemma upper_semicontinuous.upper_semicontinuous_within_at
  (h : upper_semicontinuous f) (s : set Î±) (x : Î±) : upper_semicontinuous_within_at f s x :=
(h x).upper_semicontinuous_within_at s
lemma upper_semicontinuous.upper_semicontinuous_on
  (h : upper_semicontinuous f) (s : set Î±) : upper_semicontinuous_on f s :=
Î» x hx, h.upper_semicontinuous_within_at s x
lemma upper_semicontinuous_within_at_const :
  upper_semicontinuous_within_at (Î» x, z) s x :=
Î» y hy, filter.eventually_of_forall (Î» x, hy)
lemma upper_semicontinuous_at_const :
  upper_semicontinuous_at (Î» x, z) x :=
Î» y hy, filter.eventually_of_forall (Î» x, hy)
lemma upper_semicontinuous_on_const :
  upper_semicontinuous_on (Î» x, z) s :=
Î» x hx, upper_semicontinuous_within_at_const
lemma upper_semicontinuous_const :
  upper_semicontinuous (Î» (x : Î±), z) :=
Î» x, upper_semicontinuous_at_const
section
variables [has_zero Î²]
lemma is_open.upper_semicontinuous_indicator (hs : is_open s) (hy : y â‰¤ 0) :
  upper_semicontinuous (indicator s (Î» x, y)) :=
@is_open.lower_semicontinuous_indicator Î± _ Î²áµ’áµˆ _ s y _ hs hy
lemma is_open.upper_semicontinuous_on_indicator (hs : is_open s) (hy : y â‰¤ 0) :
  upper_semicontinuous_on (indicator s (Î» x, y)) t :=
(hs.upper_semicontinuous_indicator hy).upper_semicontinuous_on t
lemma is_open.upper_semicontinuous_at_indicator (hs : is_open s) (hy : y â‰¤ 0) :
  upper_semicontinuous_at (indicator s (Î» x, y)) x :=
(hs.upper_semicontinuous_indicator hy).upper_semicontinuous_at x
lemma is_open.upper_semicontinuous_within_at_indicator (hs : is_open s) (hy : y â‰¤ 0) :
  upper_semicontinuous_within_at (indicator s (Î» x, y)) t x :=
(hs.upper_semicontinuous_indicator hy).upper_semicontinuous_within_at t x
lemma is_closed.upper_semicontinuous_indicator (hs : is_closed s) (hy : 0 â‰¤ y) :
  upper_semicontinuous (indicator s (Î» x, y)) :=
@is_closed.lower_semicontinuous_indicator Î± _ Î²áµ’áµˆ _ s y _ hs hy
lemma is_closed.upper_semicontinuous_on_indicator (hs : is_closed s) (hy : 0 â‰¤ y) :
  upper_semicontinuous_on (indicator s (Î» x, y)) t :=
(hs.upper_semicontinuous_indicator hy).upper_semicontinuous_on t
lemma is_closed.upper_semicontinuous_at_indicator (hs : is_closed s) (hy : 0 â‰¤ y) :
  upper_semicontinuous_at (indicator s (Î» x, y)) x :=
(hs.upper_semicontinuous_indicator hy).upper_semicontinuous_at x
lemma is_closed.upper_semicontinuous_within_at_indicator (hs : is_closed s) (hy : 0 â‰¤ y) :
  upper_semicontinuous_within_at (indicator s (Î» x, y)) t x :=
(hs.upper_semicontinuous_indicator hy).upper_semicontinuous_within_at t x
end
theorem upper_semicontinuous_iff_is_open :
  upper_semicontinuous f â†” âˆ€ y, is_open (f â»Â¹' (Iio y)) :=
âŸ¨Î» H y, is_open_iff_mem_nhds.2 (Î» x hx, H x y hx), Î» H x y y_lt, is_open.mem_nhds (H y) y_ltâŸ©
lemma upper_semicontinuous.is_open_preimage (hf : upper_semicontinuous f) (y : Î²) :
  is_open (f â»Â¹' (Iio y)) :=
upper_semicontinuous_iff_is_open.1 hf y
section
variables {Î³ : Type*} [linear_order Î³] [topological_space Î³] [order_topology Î³]
lemma continuous_within_at.upper_semicontinuous_within_at {f : Î± â†’ Î³}
  (h : continuous_within_at f s x) : upper_semicontinuous_within_at f s x :=
Î» y hy, h (Iio_mem_nhds hy)
lemma continuous_at.upper_semicontinuous_at {f : Î± â†’ Î³}
  (h : continuous_at f x) : upper_semicontinuous_at f x :=
Î» y hy, h (Iio_mem_nhds hy)
lemma continuous_on.upper_semicontinuous_on {f : Î± â†’ Î³}
  (h : continuous_on f s) : upper_semicontinuous_on f s :=
Î» x hx, (h x hx).upper_semicontinuous_within_at
lemma continuous.upper_semicontinuous {f : Î± â†’ Î³}
  (h : continuous f) : upper_semicontinuous f :=
Î» x, h.continuous_at.upper_semicontinuous_at
end
section
variables {Î³ : Type*} [linear_order Î³] [topological_space Î³] [order_topology Î³]
variables {Î´ : Type*} [linear_order Î´] [topological_space Î´] [order_topology Î´]
lemma continuous_at.comp_upper_semicontinuous_within_at
  {g : Î³ â†’ Î´} {f : Î± â†’ Î³} (hg : continuous_at g (f x)) (hf : upper_semicontinuous_within_at f s x)
  (gmon : monotone g) : upper_semicontinuous_within_at (g âˆ˜ f) s x :=
@continuous_at.comp_lower_semicontinuous_within_at Î± _ x s Î³áµ’áµˆ _ _ _ Î´áµ’áµˆ _ _ _ g f hg hf gmon.dual
lemma continuous_at.comp_upper_semicontinuous_at
  {g : Î³ â†’ Î´} {f : Î± â†’ Î³} (hg : continuous_at g (f x)) (hf : upper_semicontinuous_at f x)
  (gmon : monotone g) : upper_semicontinuous_at (g âˆ˜ f) x :=
@continuous_at.comp_lower_semicontinuous_at Î± _ x Î³áµ’áµˆ _ _ _ Î´áµ’áµˆ _ _ _ g f hg hf gmon.dual
lemma continuous.comp_upper_semicontinuous_on
  {g : Î³ â†’ Î´} {f : Î± â†’ Î³} (hg : continuous g) (hf : upper_semicontinuous_on f s)
  (gmon : monotone g) : upper_semicontinuous_on (g âˆ˜ f) s :=
Î» x hx, (hg.continuous_at).comp_upper_semicontinuous_within_at (hf x hx) gmon
lemma continuous.comp_upper_semicontinuous
  {g : Î³ â†’ Î´} {f : Î± â†’ Î³} (hg : continuous g) (hf : upper_semicontinuous f)
  (gmon : monotone g) : upper_semicontinuous (g âˆ˜ f) :=
Î» x, (hg.continuous_at).comp_upper_semicontinuous_at (hf x) gmon
lemma continuous_at.comp_upper_semicontinuous_within_at_antitone
  {g : Î³ â†’ Î´} {f : Î± â†’ Î³} (hg : continuous_at g (f x)) (hf : upper_semicontinuous_within_at f s x)
  (gmon : antitone g) : lower_semicontinuous_within_at (g âˆ˜ f) s x :=
@continuous_at.comp_upper_semicontinuous_within_at Î± _ x s Î³ _ _ _ Î´áµ’áµˆ _ _ _ g f hg hf gmon
lemma continuous_at.comp_upper_semicontinuous_at_antitone
  {g : Î³ â†’ Î´} {f : Î± â†’ Î³} (hg : continuous_at g (f x)) (hf : upper_semicontinuous_at f x)
  (gmon : antitone g) : lower_semicontinuous_at (g âˆ˜ f) x :=
@continuous_at.comp_upper_semicontinuous_at Î± _ x Î³ _ _ _ Î´áµ’áµˆ _ _ _ g f hg hf gmon
lemma continuous.comp_upper_semicontinuous_on_antitone
  {g : Î³ â†’ Î´} {f : Î± â†’ Î³} (hg : continuous g) (hf : upper_semicontinuous_on f s)
  (gmon : antitone g) : lower_semicontinuous_on (g âˆ˜ f) s :=
Î» x hx, (hg.continuous_at).comp_upper_semicontinuous_within_at_antitone (hf x hx) gmon
lemma continuous.comp_upper_semicontinuous_antitone
  {g : Î³ â†’ Î´} {f : Î± â†’ Î³} (hg : continuous g) (hf : upper_semicontinuous f)
  (gmon : antitone g) : lower_semicontinuous (g âˆ˜ f) :=
Î» x, (hg.continuous_at).comp_upper_semicontinuous_at_antitone (hf x) gmon
end
section
variables {Î¹ : Type*} {Î³ : Type*} [linear_ordered_add_comm_monoid Î³]
[topological_space Î³] [order_topology Î³]
lemma upper_semicontinuous_within_at.add' {f g : Î± â†’ Î³}
  (hf : upper_semicontinuous_within_at f s x) (hg : upper_semicontinuous_within_at g s x)
  (hcont : continuous_at (Î» (p : Î³ Ã— Î³), p.1 + p.2) (f x, g x)) :
  upper_semicontinuous_within_at (Î» z, f z + g z) s x :=
@lower_semicontinuous_within_at.add' Î± _ x s Î³áµ’áµˆ _ _ _ _ _ hf hg hcont
lemma upper_semicontinuous_at.add' {f g : Î± â†’ Î³}
  (hf : upper_semicontinuous_at f x) (hg : upper_semicontinuous_at g x)
  (hcont : continuous_at (Î» (p : Î³ Ã— Î³), p.1 + p.2) (f x, g x)) :
  upper_semicontinuous_at (Î» z, f z + g z) x :=
by { simp_rw [â† upper_semicontinuous_within_at_univ_iff] at *, exact hf.add' hg hcont }
lemma upper_semicontinuous_on.add' {f g : Î± â†’ Î³}
  (hf : upper_semicontinuous_on f s) (hg : upper_semicontinuous_on g s)
  (hcont : âˆ€ x âˆˆ s, continuous_at (Î» (p : Î³ Ã— Î³), p.1 + p.2) (f x, g x)) :
  upper_semicontinuous_on (Î» z, f z + g z) s :=
Î» x hx, (hf x hx).add' (hg x hx) (hcont x hx)
lemma upper_semicontinuous.add' {f g : Î± â†’ Î³}
  (hf : upper_semicontinuous f) (hg : upper_semicontinuous g)
  (hcont : âˆ€ x, continuous_at (Î» (p : Î³ Ã— Î³), p.1 + p.2) (f x, g x)) :
  upper_semicontinuous (Î» z, f z + g z) :=
Î» x, (hf x).add' (hg x) (hcont x)
variable [has_continuous_add Î³]
lemma upper_semicontinuous_within_at.add {f g : Î± â†’ Î³}
  (hf : upper_semicontinuous_within_at f s x) (hg : upper_semicontinuous_within_at g s x) :
  upper_semicontinuous_within_at (Î» z, f z + g z) s x :=
hf.add' hg continuous_add.continuous_at
lemma upper_semicontinuous_at.add {f g : Î± â†’ Î³}
  (hf : upper_semicontinuous_at f x) (hg : upper_semicontinuous_at g x) :
  upper_semicontinuous_at (Î» z, f z + g z) x :=
hf.add' hg continuous_add.continuous_at
lemma upper_semicontinuous_on.add {f g : Î± â†’ Î³}
  (hf : upper_semicontinuous_on f s) (hg : upper_semicontinuous_on g s) :
  upper_semicontinuous_on (Î» z, f z + g z) s :=
hf.add' hg (Î» x hx, continuous_add.continuous_at)
lemma upper_semicontinuous.add {f g : Î± â†’ Î³}
  (hf : upper_semicontinuous f) (hg : upper_semicontinuous g) :
  upper_semicontinuous (Î» z, f z + g z) :=
hf.add' hg (Î» x, continuous_add.continuous_at)
lemma upper_semicontinuous_within_at_sum {f : Î¹ â†’ Î± â†’ Î³} {a : finset Î¹}
  (ha : âˆ€ i âˆˆ a, upper_semicontinuous_within_at (f i) s x) :
  upper_semicontinuous_within_at (Î» z, (âˆ‘ i in a, f i z)) s x :=
@lower_semicontinuous_within_at_sum Î± _ x s Î¹ Î³áµ’áµˆ _ _ _ _ f a ha
lemma upper_semicontinuous_at_sum {f : Î¹ â†’ Î± â†’ Î³} {a : finset Î¹}
  (ha : âˆ€ i âˆˆ a, upper_semicontinuous_at (f i) x) :
  upper_semicontinuous_at (Î» z, (âˆ‘ i in a, f i z)) x :=
begin
  simp_rw [â† upper_semicontinuous_within_at_univ_iff] at *,
  exact upper_semicontinuous_within_at_sum ha
end
lemma upper_semicontinuous_on_sum {f : Î¹ â†’ Î± â†’ Î³} {a : finset Î¹}
  (ha : âˆ€ i âˆˆ a, upper_semicontinuous_on (f i) s) :
  upper_semicontinuous_on (Î» z, (âˆ‘ i in a, f i z)) s :=
Î» x hx, upper_semicontinuous_within_at_sum (Î» i hi, ha i hi x hx)
lemma upper_semicontinuous_sum {f : Î¹ â†’ Î± â†’ Î³} {a : finset Î¹}
  (ha : âˆ€ i âˆˆ a, upper_semicontinuous (f i)) :
  upper_semicontinuous (Î» z, (âˆ‘ i in a, f i z)) :=
Î» x, upper_semicontinuous_at_sum (Î» i hi, ha i hi x)
end
section
variables {Î¹ : Sort*} {Î´ : Type*} [complete_linear_order Î´]
lemma upper_semicontinuous_within_at_infi {f : Î¹ â†’ Î± â†’ Î´}
  (h : âˆ€ i, upper_semicontinuous_within_at (f i) s x) :
  upper_semicontinuous_within_at (Î» x', â¨… i, f i x') s x :=
@lower_semicontinuous_within_at_supr Î± _ x s Î¹ Î´áµ’áµˆ _ f h
lemma upper_semicontinuous_within_at_binfi {p : Î¹ â†’ Prop} {f : Î  i (h : p i), Î± â†’ Î´}
  (h : âˆ€ i hi, upper_semicontinuous_within_at (f i hi) s x) :
  upper_semicontinuous_within_at (Î» x', â¨… i hi, f i hi x') s x :=
upper_semicontinuous_within_at_infi $ Î» i, upper_semicontinuous_within_at_infi $ Î» hi, h i hi
lemma upper_semicontinuous_at_infi {f : Î¹ â†’ Î± â†’ Î´}
  (h : âˆ€ i, upper_semicontinuous_at (f i) x) :
  upper_semicontinuous_at (Î» x', â¨… i, f i x') x :=
@lower_semicontinuous_at_supr Î± _ x Î¹ Î´áµ’áµˆ _ f h
lemma upper_semicontinuous_at_binfi {p : Î¹ â†’ Prop} {f : Î  i (h : p i), Î± â†’ Î´}
  (h : âˆ€ i hi, upper_semicontinuous_at (f i hi) x) :
  upper_semicontinuous_at (Î» x', â¨… i hi, f i hi x') x :=
upper_semicontinuous_at_infi $ Î» i, upper_semicontinuous_at_infi $ Î» hi, h i hi
lemma upper_semicontinuous_on_infi {f : Î¹ â†’ Î± â†’ Î´}
  (h : âˆ€ i, upper_semicontinuous_on (f i) s) :
  upper_semicontinuous_on (Î» x', â¨… i, f i x') s :=
Î» x hx, upper_semicontinuous_within_at_infi (Î» i, h i x hx)
lemma upper_semicontinuous_on_binfi {p : Î¹ â†’ Prop} {f : Î  i (h : p i), Î± â†’ Î´}
  (h : âˆ€ i hi, upper_semicontinuous_on (f i hi) s) :
  upper_semicontinuous_on (Î» x', â¨… i hi, f i hi x') s :=
upper_semicontinuous_on_infi $ Î» i, upper_semicontinuous_on_infi $ Î» hi, h i hi
lemma upper_semicontinuous_infi {f : Î¹ â†’ Î± â†’ Î´}
  (h : âˆ€ i, upper_semicontinuous (f i)) :
  upper_semicontinuous (Î» x', â¨… i, f i x') :=
Î» x, upper_semicontinuous_at_infi (Î» i, h i x)
lemma upper_semicontinuous_binfi {p : Î¹ â†’ Prop} {f : Î  i (h : p i), Î± â†’ Î´}
  (h : âˆ€ i hi, upper_semicontinuous (f i hi)) :
  upper_semicontinuous (Î» x', â¨… i hi, f i hi x') :=
upper_semicontinuous_infi $ Î» i, upper_semicontinuous_infi $ Î» hi, h i hi
end
section
variables {Î³ : Type*} [linear_order Î³] [topological_space Î³] [order_topology Î³]
lemma continuous_within_at_iff_lower_upper_semicontinuous_within_at {f : Î± â†’ Î³} :
  continuous_within_at f s x â†”
    lower_semicontinuous_within_at f s x âˆ§ upper_semicontinuous_within_at f s x:=
begin
  refine âŸ¨Î» h, âŸ¨h.lower_semicontinuous_within_at, h.upper_semicontinuous_within_atâŸ©, _âŸ©,
  rintros âŸ¨hâ‚, hâ‚‚âŸ©,
  assume v hv,
  simp only [filter.mem_map],
  by_cases Hl : âˆƒ l, l < f x,
  { rcases exists_Ioc_subset_of_mem_nhds hv Hl with âŸ¨l, lfx, hlâŸ©,
    by_cases Hu : âˆƒ u, f x < u,
    { rcases exists_Ico_subset_of_mem_nhds hv Hu with âŸ¨u, fxu, huâŸ©,
      filter_upwards [hâ‚ l lfx, hâ‚‚ u fxu] with a lfa fau,
      cases le_or_gt (f a) (f x) with h h,
      { exact hl âŸ¨lfa, hâŸ© },
      { exact hu âŸ¨le_of_lt h, fauâŸ© } },
    { simp only [not_exists, not_lt] at Hu,
      filter_upwards [hâ‚ l lfx] with a lfa using hl âŸ¨lfa, Hu (f a)âŸ©, }, },
  { simp only [not_exists, not_lt] at Hl,
    by_cases Hu : âˆƒ u, f x < u,
    { rcases exists_Ico_subset_of_mem_nhds hv Hu with âŸ¨u, fxu, huâŸ©,
      filter_upwards [hâ‚‚ u fxu] with a lfa,
      apply hu,
      exact âŸ¨Hl (f a), lfaâŸ© },
    { simp only [not_exists, not_lt] at Hu,
      apply filter.eventually_of_forall,
      assume a,
      have : f a = f x := le_antisymm (Hu _) (Hl _),
      rw this,
      exact mem_of_mem_nhds hv } }
end
lemma continuous_at_iff_lower_upper_semicontinuous_at {f : Î± â†’ Î³} :
  continuous_at f x â†” (lower_semicontinuous_at f x âˆ§ upper_semicontinuous_at f x) :=
by simp_rw [â† continuous_within_at_univ, â† lower_semicontinuous_within_at_univ_iff,
  â† upper_semicontinuous_within_at_univ_iff,
  continuous_within_at_iff_lower_upper_semicontinuous_within_at]
lemma continuous_on_iff_lower_upper_semicontinuous_on {f : Î± â†’ Î³} :
  continuous_on f s â†” (lower_semicontinuous_on f s âˆ§ upper_semicontinuous_on f s) :=
begin
  simp only [continuous_on, continuous_within_at_iff_lower_upper_semicontinuous_within_at],
  exact âŸ¨Î» H, âŸ¨Î» x hx, (H x hx).1, Î» x hx, (H x hx).2âŸ©, Î» H x hx, âŸ¨H.1 x hx, H.2 x hxâŸ©âŸ©
end
lemma continuous_iff_lower_upper_semicontinuous {f : Î± â†’ Î³} :
  continuous f â†” (lower_semicontinuous f âˆ§ upper_semicontinuous f) :=
by simp_rw [continuous_iff_continuous_on_univ, continuous_on_iff_lower_upper_semicontinuous_on,
    lower_semicontinuous_on_univ_iff, upper_semicontinuous_on_univ_iff]
end
