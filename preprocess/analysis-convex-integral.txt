import analysis.convex.function
import analysis.convex.strict_convex_space
import measure_theory.function.ae_eq_of_integral
import measure_theory.integral.average
open measure_theory measure_theory.measure metric set filter topological_space function
open_locale topological_space big_operators ennreal convex
variables {Î± E F : Type*} {m0 : measurable_space Î±}
  [normed_group E] [normed_space â„ E] [complete_space E]
  [normed_group F] [normed_space â„ F] [complete_space F]
  {Î¼ : measure Î±} {s : set E} {t : set Î±} {f : Î± â†’ E} {g : E â†’ â„} {C : â„}
lemma convex.integral_mem [is_probability_measure Î¼] (hs : convex â„ s) (hsc : is_closed s)
  (hf : âˆ€áµ x âˆ‚Î¼, f x âˆˆ s) (hfi : integrable f Î¼) :
  âˆ« x, f x âˆ‚Î¼ âˆˆ s :=
begin
  borelize E,
  rcases hfi.ae_strongly_measurable with âŸ¨g, hgm, hfgâŸ©,
  haveI : separable_space (range g âˆ© s : set E) :=
    (hgm.is_separable_range.mono (inter_subset_left _ _)).separable_space,
  obtain âŸ¨yâ‚€, hâ‚€âŸ© : (range g âˆ© s).nonempty,
  { rcases (hf.and hfg).exists with âŸ¨xâ‚€, hâ‚€âŸ©,
    exact âŸ¨f xâ‚€, by simp only [hâ‚€.2, mem_range_self], hâ‚€.1âŸ© },
  rw [integral_congr_ae hfg], rw [integrable_congr hfg] at hfi,
  have hg : âˆ€áµ x âˆ‚Î¼, g x âˆˆ closure (range g âˆ© s),
  { filter_upwards [hfg.rw (Î» x y, y âˆˆ s) hf] with x hx,
    apply subset_closure,
    exact âŸ¨mem_range_self _, hxâŸ© },
  set G : â„• â†’ simple_func Î± E := simple_func.approx_on _ hgm.measurable (range g âˆ© s) yâ‚€ hâ‚€,
  have : tendsto (Î» n, (G n).integral Î¼) at_top (ğ“ $ âˆ« x, g x âˆ‚Î¼),
    from tendsto_integral_approx_on_of_measurable hfi _ hg _ (integrable_const _),
  refine hsc.mem_of_tendsto this (eventually_of_forall $ Î» n, hs.sum_mem _ _ _),
  { exact Î» _ _, ennreal.to_real_nonneg },
  { rw [â† ennreal.to_real_sum, (G n).sum_range_measure_preimage_singleton, measure_univ,
      ennreal.one_to_real],
    exact Î» _ _, measure_ne_top _ _ },
  { simp only [simple_func.mem_range, forall_range_iff],
    assume x,
    apply inter_subset_right (range g),
    exact simple_func.approx_on_mem hgm.measurable _ _ _ },
end
lemma convex.average_mem [is_finite_measure Î¼] (hs : convex â„ s) (hsc : is_closed s) (hÎ¼ : Î¼ â‰  0)
  (hfs : âˆ€áµ x âˆ‚Î¼, f x âˆˆ s) (hfi : integrable f Î¼) :
  â¨ x, f x âˆ‚Î¼ âˆˆ s :=
begin
  haveI : is_probability_measure ((Î¼ univ)â»Â¹ â€¢ Î¼),
    from is_probability_measure_smul hÎ¼,
  refine hs.integral_mem hsc (ae_mono' _ hfs) hfi.to_average,
  exact absolutely_continuous.smul (refl _) _
end
lemma convex.set_average_mem (hs : convex â„ s) (hsc : is_closed s) (h0 : Î¼ t â‰  0) (ht : Î¼ t â‰  âˆ)
  (hfs : âˆ€áµ x âˆ‚Î¼.restrict t, f x âˆˆ s) (hfi : integrable_on f t Î¼) :
  â¨ x in t, f x âˆ‚Î¼ âˆˆ s :=
begin
  haveI : fact (Î¼ t < âˆ) := âŸ¨ht.lt_topâŸ©,
  refine hs.average_mem hsc _ hfs hfi,
  rwa [ne.def, restrict_eq_zero]
end
lemma convex.set_average_mem_closure (hs : convex â„ s) (h0 : Î¼ t â‰  0) (ht : Î¼ t â‰  âˆ)
  (hfs : âˆ€áµ x âˆ‚Î¼.restrict t, f x âˆˆ s) (hfi : integrable_on f t Î¼) :
  â¨ x in t, f x âˆ‚Î¼ âˆˆ closure s :=
hs.closure.set_average_mem is_closed_closure h0 ht (hfs.mono $ Î» x hx, subset_closure hx) hfi
lemma convex_on.average_mem_epigraph [is_finite_measure Î¼] (hg : convex_on â„ s g)
  (hgc : continuous_on g s) (hsc : is_closed s) (hÎ¼ : Î¼ â‰  0) (hfs : âˆ€áµ x âˆ‚Î¼, f x âˆˆ s)
  (hfi : integrable f Î¼) (hgi : integrable (g âˆ˜ f) Î¼) :
  (â¨ x, f x âˆ‚Î¼, â¨ x, g (f x) âˆ‚Î¼) âˆˆ {p : E Ã— â„ | p.1 âˆˆ s âˆ§ g p.1 â‰¤ p.2} :=
have ht_mem : âˆ€áµ x âˆ‚Î¼, (f x, g (f x)) âˆˆ {p : E Ã— â„ | p.1 âˆˆ s âˆ§ g p.1 â‰¤ p.2},
  from hfs.mono (Î» x hx, âŸ¨hx, le_rflâŸ©),
by simpa only [average_pair hfi hgi]
  using hg.convex_epigraph.average_mem (hsc.epigraph hgc) hÎ¼ ht_mem (hfi.prod_mk hgi)
lemma concave_on.average_mem_hypograph [is_finite_measure Î¼] (hg : concave_on â„ s g)
  (hgc : continuous_on g s) (hsc : is_closed s) (hÎ¼ : Î¼ â‰  0) (hfs : âˆ€áµ x âˆ‚Î¼, f x âˆˆ s)
  (hfi : integrable f Î¼) (hgi : integrable (g âˆ˜ f) Î¼) :
  (â¨ x, f x âˆ‚Î¼, â¨ x, g (f x) âˆ‚Î¼) âˆˆ {p : E Ã— â„ | p.1 âˆˆ s âˆ§ p.2 â‰¤ g p.1} :=
by simpa only [mem_set_of_eq, pi.neg_apply, average_neg, neg_le_neg_iff]
  using hg.neg.average_mem_epigraph hgc.neg hsc hÎ¼ hfs hfi hgi.neg
lemma convex_on.map_average_le [is_finite_measure Î¼] (hg : convex_on â„ s g)
  (hgc : continuous_on g s) (hsc : is_closed s) (hÎ¼ : Î¼ â‰  0) (hfs : âˆ€áµ x âˆ‚Î¼, f x âˆˆ s)
  (hfi : integrable f Î¼) (hgi : integrable (g âˆ˜ f) Î¼) :
  g (â¨ x, f x âˆ‚Î¼) â‰¤ â¨ x, g (f x) âˆ‚Î¼ :=
(hg.average_mem_epigraph hgc hsc hÎ¼ hfs hfi hgi).2
lemma concave_on.le_map_average [is_finite_measure Î¼] (hg : concave_on â„ s g)
  (hgc : continuous_on g s) (hsc : is_closed s) (hÎ¼ : Î¼ â‰  0) (hfs : âˆ€áµ x âˆ‚Î¼, f x âˆˆ s)
  (hfi : integrable f Î¼) (hgi : integrable (g âˆ˜ f) Î¼) :
  â¨ x, g (f x) âˆ‚Î¼ â‰¤ g (â¨ x, f x âˆ‚Î¼) :=
(hg.average_mem_hypograph hgc hsc hÎ¼ hfs hfi hgi).2
lemma convex_on.set_average_mem_epigraph (hg : convex_on â„ s g) (hgc : continuous_on g s)
  (hsc : is_closed s) (h0 : Î¼ t â‰  0) (ht : Î¼ t â‰  âˆ) (hfs : âˆ€áµ x âˆ‚Î¼.restrict t, f x âˆˆ s)
  (hfi : integrable_on f t Î¼) (hgi : integrable_on (g âˆ˜ f) t Î¼) :
  (â¨ x in t, f x âˆ‚Î¼, â¨ x in t, g (f x) âˆ‚Î¼) âˆˆ {p : E Ã— â„ | p.1 âˆˆ s âˆ§ g p.1 â‰¤ p.2} :=
begin
  haveI : fact (Î¼ t < âˆ) := âŸ¨ht.lt_topâŸ©,
  refine hg.average_mem_epigraph hgc hsc _ hfs hfi hgi,
  rwa [ne.def, restrict_eq_zero]
end
lemma concave_on.set_average_mem_hypograph (hg : concave_on â„ s g) (hgc : continuous_on g s)
  (hsc : is_closed s) (h0 : Î¼ t â‰  0) (ht : Î¼ t â‰  âˆ) (hfs : âˆ€áµ x âˆ‚Î¼.restrict t, f x âˆˆ s)
  (hfi : integrable_on f t Î¼) (hgi : integrable_on (g âˆ˜ f) t Î¼) :
  (â¨ x in t, f x âˆ‚Î¼, â¨ x in t, g (f x) âˆ‚Î¼) âˆˆ {p : E Ã— â„ | p.1 âˆˆ s âˆ§ p.2 â‰¤ g p.1} :=
by simpa only [mem_set_of_eq, pi.neg_apply, average_neg, neg_le_neg_iff]
  using hg.neg.set_average_mem_epigraph hgc.neg hsc h0 ht hfs hfi hgi.neg
lemma convex_on.map_set_average_le (hg : convex_on â„ s g) (hgc : continuous_on g s)
  (hsc : is_closed s) (h0 : Î¼ t â‰  0) (ht : Î¼ t â‰  âˆ) (hfs : âˆ€áµ x âˆ‚Î¼.restrict t, f x âˆˆ s)
  (hfi : integrable_on f t Î¼) (hgi : integrable_on (g âˆ˜ f) t Î¼) :
  g (â¨ x in t, f x âˆ‚Î¼) â‰¤ â¨ x in t, g (f x) âˆ‚Î¼ :=
(hg.set_average_mem_epigraph hgc hsc h0 ht hfs hfi hgi).2
lemma concave_on.le_map_set_average (hg : concave_on â„ s g) (hgc : continuous_on g s)
  (hsc : is_closed s) (h0 : Î¼ t â‰  0) (ht : Î¼ t â‰  âˆ) (hfs : âˆ€áµ x âˆ‚Î¼.restrict t, f x âˆˆ s)
  (hfi : integrable_on f t Î¼) (hgi : integrable_on (g âˆ˜ f) t Î¼) :
  â¨ x in t, g (f x) âˆ‚Î¼ â‰¤ g (â¨ x in t, f x âˆ‚Î¼) :=
(hg.set_average_mem_hypograph hgc hsc h0 ht hfs hfi hgi).2
lemma convex_on.map_integral_le [is_probability_measure Î¼] (hg : convex_on â„ s g)
  (hgc : continuous_on g s) (hsc : is_closed s) (hfs : âˆ€áµ x âˆ‚Î¼, f x âˆˆ s) (hfi : integrable f Î¼)
  (hgi : integrable (g âˆ˜ f) Î¼) :
  g (âˆ« x, f x âˆ‚Î¼) â‰¤ âˆ« x, g (f x) âˆ‚Î¼ :=
by simpa only [average_eq_integral]
  using hg.map_average_le hgc hsc (is_probability_measure.ne_zero Î¼) hfs hfi hgi
lemma concave_on.le_map_integral [is_probability_measure Î¼] (hg : concave_on â„ s g)
  (hgc : continuous_on g s) (hsc : is_closed s) (hfs : âˆ€áµ x âˆ‚Î¼, f x âˆˆ s) (hfi : integrable f Î¼)
  (hgi : integrable (g âˆ˜ f) Î¼) :
  âˆ« x, g (f x) âˆ‚Î¼ â‰¤ g (âˆ« x, f x âˆ‚Î¼) :=
by simpa only [average_eq_integral]
  using hg.le_map_average hgc hsc (is_probability_measure.ne_zero Î¼) hfs hfi hgi
lemma ae_eq_const_or_exists_average_ne_compl [is_finite_measure Î¼] (hfi : integrable f Î¼) :
  (f =áµ[Î¼] const Î± (â¨ x, f x âˆ‚Î¼)) âˆ¨ âˆƒ t, measurable_set t âˆ§ Î¼ t â‰  0 âˆ§ Î¼ tá¶œ â‰  0 âˆ§
    â¨ x in t, f x âˆ‚Î¼ â‰  â¨ x in tá¶œ, f x âˆ‚Î¼ :=
begin
  refine or_iff_not_imp_right.mpr (Î» H, _), push_neg at H,
  refine hfi.ae_eq_of_forall_set_integral_eq _ _ (integrable_const _) (Î» t ht ht', _), clear ht',
  simp only [const_apply, set_integral_const],
  by_cases hâ‚€ : Î¼ t = 0,
  { rw [restrict_eq_zero.2 hâ‚€, integral_zero_measure, hâ‚€, ennreal.zero_to_real, zero_smul] },
  by_cases hâ‚€' : Î¼ tá¶œ = 0,
  { rw â† ae_eq_univ at hâ‚€',
    rw [restrict_congr_set hâ‚€', restrict_univ, measure_congr hâ‚€', measure_smul_average] },
  have := average_mem_open_segment_compl_self ht.null_measurable_set hâ‚€ hâ‚€' hfi,
  rw [â† H t ht hâ‚€ hâ‚€', open_segment_same, mem_singleton_iff] at this,
  rw [this, measure_smul_set_average _ (measure_ne_top Î¼ _)]
end
lemma convex.average_mem_interior_of_set [is_finite_measure Î¼] (hs : convex â„ s) (h0 : Î¼ t â‰  0)
  (hfs : âˆ€áµ x âˆ‚Î¼, f x âˆˆ s) (hfi : integrable f Î¼) (ht : â¨ x in t, f x âˆ‚Î¼ âˆˆ interior s) :
  â¨ x, f x âˆ‚Î¼ âˆˆ interior s :=
begin
  rw â† measure_to_measurable at h0, rw â† restrict_to_measurable (measure_ne_top Î¼ t) at ht,
  by_cases h0' : Î¼ (to_measurable Î¼ t)á¶œ = 0,
  { rw â† ae_eq_univ at h0',
    rwa [restrict_congr_set h0', restrict_univ] at ht },
  exact hs.open_segment_interior_closure_subset_interior ht
    (hs.set_average_mem_closure h0' (measure_ne_top _ _) (ae_restrict_of_ae hfs) hfi.integrable_on)
    (average_mem_open_segment_compl_self (measurable_set_to_measurable Î¼ t).null_measurable_set
      h0 h0' hfi)
end
lemma strict_convex.ae_eq_const_or_average_mem_interior [is_finite_measure Î¼]
  (hs : strict_convex â„ s) (hsc : is_closed s) (hfs : âˆ€áµ x âˆ‚Î¼, f x âˆˆ s) (hfi : integrable f Î¼) :
  f =áµ[Î¼] const Î± (â¨ x, f x âˆ‚Î¼) âˆ¨ â¨ x, f x âˆ‚Î¼ âˆˆ interior s :=
begin
  have : âˆ€ {t}, Î¼ t â‰  0 â†’ â¨ x in t, f x âˆ‚Î¼ âˆˆ s,
    from Î» t ht, hs.convex.set_average_mem hsc ht (measure_ne_top _ _) (ae_restrict_of_ae hfs)
      hfi.integrable_on,
  refine (ae_eq_const_or_exists_average_ne_compl hfi).imp_right _,
  rintro âŸ¨t, hm, hâ‚€, hâ‚€', hneâŸ©,
  exact hs.open_segment_subset (this hâ‚€) (this hâ‚€') hne
    (average_mem_open_segment_compl_self hm.null_measurable_set hâ‚€ hâ‚€' hfi)
end
lemma strict_convex_on.ae_eq_const_or_map_average_lt [is_finite_measure Î¼]
  (hg : strict_convex_on â„ s g) (hgc : continuous_on g s) (hsc : is_closed s)
  (hfs : âˆ€áµ x âˆ‚Î¼, f x âˆˆ s) (hfi : integrable f Î¼) (hgi : integrable (g âˆ˜ f) Î¼) :
  f =áµ[Î¼] const Î± (â¨ x, f x âˆ‚Î¼) âˆ¨ g (â¨ x, f x âˆ‚Î¼) < â¨ x, g (f x) âˆ‚Î¼ :=
begin
  have : âˆ€ {t}, Î¼ t â‰  0 â†’ â¨ x in t, f x âˆ‚Î¼ âˆˆ s âˆ§ g (â¨ x in t, f x âˆ‚Î¼) â‰¤ â¨ x in t, g (f x) âˆ‚Î¼,
    from Î» t ht, hg.convex_on.set_average_mem_epigraph hgc hsc ht (measure_ne_top _ _)
      (ae_restrict_of_ae hfs) hfi.integrable_on hgi.integrable_on,
  refine (ae_eq_const_or_exists_average_ne_compl hfi).imp_right _,
  rintro âŸ¨t, hm, hâ‚€, hâ‚€', hneâŸ©,
  rcases average_mem_open_segment_compl_self hm.null_measurable_set hâ‚€ hâ‚€' (hfi.prod_mk hgi)
    with âŸ¨a, b, ha, hb, hab, h_avgâŸ©,
  simp only [average_pair hfi hgi, average_pair hfi.integrable_on hgi.integrable_on, prod.smul_mk,
    prod.mk_add_mk, prod.mk.inj_iff, (âˆ˜)] at h_avg,
  rw [â† h_avg.1, â† h_avg.2],
  calc g (a â€¢ â¨ x in t, f x âˆ‚Î¼ + b â€¢ â¨ x in tá¶œ, f x âˆ‚Î¼)
      < a * g (â¨ x in t, f x âˆ‚Î¼) + b * g (â¨ x in tá¶œ, f x âˆ‚Î¼) :
    hg.2 (this hâ‚€).1 (this hâ‚€').1 hne ha hb hab
  ... â‰¤ a * â¨ x in t, g (f x) âˆ‚Î¼ + b * â¨ x in tá¶œ, g (f x) âˆ‚Î¼ :
    add_le_add (mul_le_mul_of_nonneg_left (this hâ‚€).2 ha.le)
      (mul_le_mul_of_nonneg_left (this hâ‚€').2 hb.le)
end
lemma strict_concave_on.ae_eq_const_or_lt_map_average [is_finite_measure Î¼]
  (hg : strict_concave_on â„ s g) (hgc : continuous_on g s) (hsc : is_closed s)
  (hfs : âˆ€áµ x âˆ‚Î¼, f x âˆˆ s) (hfi : integrable f Î¼) (hgi : integrable (g âˆ˜ f) Î¼) :
  f =áµ[Î¼] const Î± (â¨ x, f x âˆ‚Î¼) âˆ¨ â¨ x, g (f x) âˆ‚Î¼ < g (â¨ x, f x âˆ‚Î¼) :=
by simpa only [pi.neg_apply, average_neg, neg_lt_neg_iff]
  using hg.neg.ae_eq_const_or_map_average_lt hgc.neg hsc hfs hfi hgi.neg
lemma ae_eq_const_or_norm_average_lt_of_norm_le_const [strict_convex_space â„ E]
  (h_le : âˆ€áµ x âˆ‚Î¼, âˆ¥f xâˆ¥ â‰¤ C) :
  (f =áµ[Î¼] const Î± â¨ x, f x âˆ‚Î¼) âˆ¨ âˆ¥â¨ x, f x âˆ‚Î¼âˆ¥ < C :=
begin
  cases le_or_lt C 0 with hC0 hC0,
  { have : f =áµ[Î¼] 0, from h_le.mono (Î» x hx, norm_le_zero_iff.1 (hx.trans hC0)),
    simp only [average_congr this, pi.zero_apply, average_zero],
    exact or.inl this },
  by_cases hfi : integrable f Î¼, swap,
    by simp [average_def', integral_undef hfi, hC0, ennreal.to_real_pos_iff],
  cases (le_top : Î¼ univ â‰¤ âˆ).eq_or_lt with hÎ¼t hÎ¼t, { simp [average_def', hÎ¼t, hC0] },
  haveI : is_finite_measure Î¼ := âŸ¨hÎ¼tâŸ©,
  replace h_le : âˆ€áµ x âˆ‚Î¼, f x âˆˆ closed_ball (0 : E) C, by simpa only [mem_closed_ball_zero_iff],
  simpa only [interior_closed_ball _ hC0.ne', mem_ball_zero_iff]
    using (strict_convex_closed_ball â„ (0 : E) C).ae_eq_const_or_average_mem_interior
      is_closed_ball h_le hfi
end
lemma ae_eq_const_or_norm_integral_lt_of_norm_le_const [strict_convex_space â„ E]
  [is_finite_measure Î¼] (h_le : âˆ€áµ x âˆ‚Î¼, âˆ¥f xâˆ¥ â‰¤ C) :
  (f =áµ[Î¼] const Î± â¨ x, f x âˆ‚Î¼) âˆ¨ âˆ¥âˆ« x, f x âˆ‚Î¼âˆ¥ < (Î¼ univ).to_real * C :=
begin
  cases eq_or_ne Î¼ 0 with hâ‚€ hâ‚€, { left, simp [hâ‚€] },
  have hÎ¼ : 0 < (Î¼ univ).to_real,
    by simp [ennreal.to_real_pos_iff, pos_iff_ne_zero, hâ‚€, measure_lt_top],
  refine (ae_eq_const_or_norm_average_lt_of_norm_le_const h_le).imp_right (Î» H, _),
  rwa [average_def', norm_smul, norm_inv, real.norm_eq_abs, abs_of_pos hÎ¼,
    â† div_eq_inv_mul, div_lt_iff' hÎ¼] at H
end
lemma ae_eq_const_or_norm_set_integral_lt_of_norm_le_const [strict_convex_space â„ E]
  (ht : Î¼ t â‰  âˆ) (h_le : âˆ€áµ x âˆ‚Î¼.restrict t, âˆ¥f xâˆ¥ â‰¤ C) :
  (f =áµ[Î¼.restrict t] const Î± â¨ x in t, f x âˆ‚Î¼) âˆ¨ âˆ¥âˆ« x in t, f x âˆ‚Î¼âˆ¥ < (Î¼ t).to_real * C :=
begin
  haveI := fact.mk ht.lt_top,
  rw [â† restrict_apply_univ],
  exact ae_eq_const_or_norm_integral_lt_of_norm_le_const h_le
end
