import topology.subset_properties
import topology.separation
import data.option.basic
open set filter function
open_locale filter topological_space
universes u v
class paracompact_space (X : Type v) [topological_space X] : Prop :=
(locally_finite_refinement :
  âˆ€ (Î± : Type v) (s : Î± â†’ set X) (ho : âˆ€ a, is_open (s a)) (hc : (â‹ƒ a, s a) = univ),
  âˆƒ (Î² : Type v) (t : Î² â†’ set X) (ho : âˆ€ b, is_open (t b)) (hc : (â‹ƒ b, t b) = univ),
    locally_finite t âˆ§ âˆ€ b, âˆƒ a, t b âŠ† s a)
variables {Î¹ : Type u} {X : Type v} [topological_space X]
lemma precise_refinement [paracompact_space X] (u : Î¹ â†’ set X) (uo : âˆ€ a, is_open (u a))
  (uc : (â‹ƒ i, u i) = univ) :
  âˆƒ v : Î¹ â†’ set X, (âˆ€ a, is_open (v a)) âˆ§ (â‹ƒ i, v i) = univ âˆ§ locally_finite v âˆ§ (âˆ€ a, v a âŠ† u a) :=
begin
lemma precise_refinement_set [paracompact_space X] {s : set X} (hs : is_closed s)
  (u : Î¹ â†’ set X) (uo : âˆ€ i, is_open (u i)) (us : s âŠ† â‹ƒ i, u i) :
  âˆƒ v : Î¹ â†’ set X, (âˆ€ i, is_open (v i)) âˆ§ (s âŠ† â‹ƒ i, v i) âˆ§ locally_finite v âˆ§ (âˆ€ i, v i âŠ† u i) :=
begin
  rcases precise_refinement (option.elim sá¶œ u)
    (option.forall.2 âŸ¨is_open_compl_iff.2 hs, uoâŸ©) _ with âŸ¨v, vo, vc, vf, vuâŸ©,
  refine âŸ¨v âˆ˜ some, Î» i, vo _, _, vf.comp_injective (option.some_injective _), Î» i, vu _âŸ©,
  { simp only [Union_option, â† compl_subset_iff_union] at vc,
    exact subset.trans (subset_compl_comm.1 $ vu option.none) vc },
  { simpa only [Union_option, option.elim, â† compl_subset_iff_union, compl_compl] }
end
theorem refinement_of_locally_compact_sigma_compact_of_nhds_basis_set
  [locally_compact_space X] [sigma_compact_space X] [t2_space X]
  {Î¹ : X â†’ Type u} {p : Î  x, Î¹ x â†’ Prop} {B : Î  x, Î¹ x â†’ set X} {s : set X}
  (hs : is_closed s) (hB : âˆ€ x âˆˆ s, (ğ“ x).has_basis (p x) (B x)) :
  âˆƒ (Î± : Type v) (c : Î± â†’ X) (r : Î  a, Î¹ (c a)), (âˆ€ a, c a âˆˆ s âˆ§ p (c a) (r a)) âˆ§
    (s âŠ† â‹ƒ a, B (c a) (r a)) âˆ§ locally_finite (Î» a, B (c a) (r a)) :=
begin
  classical,
theorem refinement_of_locally_compact_sigma_compact_of_nhds_basis
  [locally_compact_space X] [sigma_compact_space X] [t2_space X]
  {Î¹ : X â†’ Type u} {p : Î  x, Î¹ x â†’ Prop} {B : Î  x, Î¹ x â†’ set X}
  (hB : âˆ€ x, (ğ“ x).has_basis (p x) (B x)) :
  âˆƒ (Î± : Type v) (c : Î± â†’ X) (r : Î  a, Î¹ (c a)), (âˆ€ a, p (c a) (r a)) âˆ§
    (â‹ƒ a, B (c a) (r a)) = univ âˆ§ locally_finite (Î» a, B (c a) (r a)) :=
let âŸ¨Î±, c, r, hp, hU, hfinâŸ© := refinement_of_locally_compact_sigma_compact_of_nhds_basis_set
  is_closed_univ (Î» x _, hB x)
in âŸ¨Î±, c, r, Î» a, (hp a).2, univ_subset_iff.1 hU, hfinâŸ©
lemma normal_of_paracompact_t2 [t2_space X] [paracompact_space X] : normal_space X :=
begin
  have : âˆ€ (s t : set X), is_closed s â†’ is_closed t â†’
    (âˆ€ x âˆˆ s, âˆƒ u v, is_open u âˆ§ is_open v âˆ§ x âˆˆ u âˆ§ t âŠ† v âˆ§ disjoint u v) â†’
    âˆƒ u v, is_open u âˆ§ is_open v âˆ§ s âŠ† u âˆ§ t âŠ† v âˆ§ disjoint u v,
    intros s t hs ht H, choose u v hu hv hxu htv huv using set_coe.forall'.1 H,
    rcases precise_refinement_set hs u hu (Î» x hx, mem_Union.2 âŸ¨âŸ¨x, hxâŸ©, hxu _âŸ©)
      with âŸ¨u', hu'o, hcov', hu'fin, hsubâŸ©,
    refine âŸ¨â‹ƒ i, u' i, (closure (â‹ƒ i, u' i))á¶œ, is_open_Union hu'o, is_closed_closure.is_open_compl,
      hcov', _, disjoint_compl_right.mono le_rfl (compl_le_compl subset_closure)âŸ©,
    rw [hu'fin.closure_Union, compl_Union, subset_Inter_iff],
    refine Î» i x hxt hxu, absurd (htv i hxt) (closure_minimal _ (is_closed_compl_iff.2 $ hv _) hxu),
    exact Î» y hyu hyv, huv i âŸ¨hsub _ hyu, hyvâŸ© },
  refine âŸ¨Î» s t hs ht hst, this s t hs ht (Î» x hx, _)âŸ©,
  rcases this t {x} ht is_closed_singleton (Î» y hy, _) with âŸ¨v, u, hv, hu, htv, hxu, huvâŸ©,
  { exact âŸ¨u, v, hu, hv, singleton_subset_iff.1 hxu, htv, huv.symmâŸ© },
  { simp_rw singleton_subset_iff,
    exact t2_separation (hst.symm.ne_of_mem hy hx) }
end
