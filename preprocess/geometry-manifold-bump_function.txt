import analysis.calculus.specific_functions
import geometry.manifold.cont_mdiff
universes uE uF uH uM
variables
{E : Type uE} [normed_group E] [normed_space ‚Ñù E] [finite_dimensional ‚Ñù E]
{H : Type uH} [topological_space H] (I : model_with_corners ‚Ñù E H)
{M : Type uM} [topological_space M] [charted_space H M] [smooth_manifold_with_corners I M]
open function filter finite_dimensional set
open_locale topological_space manifold classical filter big_operators
noncomputable theory
structure smooth_bump_function (c : M) extends cont_diff_bump (ext_chart_at I c c) :=
(closed_ball_subset :
  (euclidean.closed_ball (ext_chart_at I c c) R) ‚à© range I ‚äÜ (ext_chart_at I c).target)
variable {M}
namespace smooth_bump_function
open euclidean (renaming dist -> eudist)
variables {c : M} (f : smooth_bump_function I c) {x : M} {I}
def to_fun : M ‚Üí ‚Ñù :=
indicator (chart_at H c).source (f.to_cont_diff_bump ‚àò ext_chart_at I c)
instance : has_coe_to_fun (smooth_bump_function I c) (Œª _, M ‚Üí ‚Ñù) := ‚ü®to_fun‚ü©
lemma coe_def :
  ‚áëf = indicator (chart_at H c).source (f.to_cont_diff_bump ‚àò ext_chart_at I c) :=
rfl
lemma R_pos : 0 < f.R := f.to_cont_diff_bump.R_pos
lemma ball_subset :
  ball (ext_chart_at I c c) f.R ‚à© range I ‚äÜ (ext_chart_at I c).target :=
subset.trans (inter_subset_inter_left _ ball_subset_closed_ball) f.closed_ball_subset
lemma eq_on_source :
  eq_on f (f.to_cont_diff_bump ‚àò ext_chart_at I c) (chart_at H c).source :=
eq_on_indicator
lemma eventually_eq_of_mem_source (hx : x ‚àà (chart_at H c).source) :
  f =·∂†[ùìù x] f.to_cont_diff_bump ‚àò ext_chart_at I c :=
f.eq_on_source.eventually_eq_of_mem $ is_open.mem_nhds (chart_at H c).open_source hx
lemma one_of_dist_le (hs : x ‚àà (chart_at H c).source)
  (hd : eudist (ext_chart_at I c x) (ext_chart_at I c c) ‚â§ f.r) :
  f x = 1 :=
by simp only [f.eq_on_source hs, (‚àò), f.to_cont_diff_bump.one_of_mem_closed_ball hd]
lemma support_eq_inter_preimage :
  support f =
    (chart_at H c).source ‚à© (ext_chart_at I c ‚Åª¬π' ball (ext_chart_at I c c) f.R) :=
by rw [coe_def, support_indicator, (‚àò), support_comp_eq_preimage, ‚Üê ext_chart_at_source I,
  ‚Üê (ext_chart_at I c).symm_image_target_inter_eq',
  ‚Üê (ext_chart_at I c).symm_image_target_inter_eq', f.to_cont_diff_bump.support_eq]
lemma open_support : is_open (support f) :=
by { rw support_eq_inter_preimage, exact ext_chart_preimage_open_of_open I c is_open_ball }
lemma support_eq_symm_image :
  support f = (ext_chart_at I c).symm '' (ball (ext_chart_at I c c) f.R ‚à© range I) :=
begin
  rw [f.support_eq_inter_preimage, ‚Üê ext_chart_at_source I,
    ‚Üê (ext_chart_at I c).symm_image_target_inter_eq', inter_comm],
  congr' 1 with y,
  exact and.congr_right_iff.2
    (Œª hy, ‚ü®Œª h, ext_chart_at_target_subset_range _ _ h, Œª h, f.ball_subset ‚ü®hy, h‚ü©‚ü©)
end
lemma support_subset_source : support f ‚äÜ (chart_at H c).source :=
by { rw [f.support_eq_inter_preimage, ‚Üê ext_chart_at_source I], exact inter_subset_left _ _ }
lemma image_eq_inter_preimage_of_subset_support {s : set M} (hs : s ‚äÜ support f) :
  ext_chart_at I c '' s =
    closed_ball (ext_chart_at I c c) f.R ‚à© range I ‚à© (ext_chart_at I c).symm ‚Åª¬π' s :=
begin
  rw [support_eq_inter_preimage, subset_inter_iff, ‚Üê ext_chart_at_source I,
    ‚Üê image_subset_iff] at hs,
  cases hs with hse hsf,
  apply subset.antisymm,
  { refine subset_inter (subset_inter (subset.trans hsf ball_subset_closed_ball) _) _,
    { rintro _ ‚ü®x, -, rfl‚ü©, exact mem_range_self _ },
    { rw [(ext_chart_at I c).image_eq_target_inter_inv_preimage hse],
      exact inter_subset_right _ _ } },
  { refine subset.trans (inter_subset_inter_left _ f.closed_ball_subset) _,
    rw [(ext_chart_at I c).image_eq_target_inter_inv_preimage hse] }
end
lemma mem_Icc : f x ‚àà Icc (0 : ‚Ñù) 1 :=
begin
  have : f x = 0 ‚à® f x = _, from indicator_eq_zero_or_self _ _ _,
  cases this; rw this,
  exacts [left_mem_Icc.2 zero_le_one,
    ‚ü®f.to_cont_diff_bump.nonneg, f.to_cont_diff_bump.le_one‚ü©]
end
lemma nonneg : 0 ‚â§ f x := f.mem_Icc.1
lemma le_one : f x ‚â§ 1 := f.mem_Icc.2
lemma eventually_eq_one_of_dist_lt (hs : x ‚àà (chart_at H c).source)
  (hd : eudist (ext_chart_at I c x) (ext_chart_at I c c) < f.r) :
  f =·∂†[ùìù x] 1 :=
begin
  filter_upwards [is_open.mem_nhds (ext_chart_preimage_open_of_open I c is_open_ball) ‚ü®hs, hd‚ü©],
  rintro z ‚ü®hzs, hzd : _ < _‚ü©,
  exact f.one_of_dist_le hzs hzd.le
end
lemma eventually_eq_one : f =·∂†[ùìù c] 1 :=
f.eventually_eq_one_of_dist_lt (mem_chart_source _ _) $
by { rw [euclidean.dist, dist_self], exact f.r_pos }
@[simp] lemma eq_one : f c = 1 := f.eventually_eq_one.eq_of_nhds
lemma support_mem_nhds : support f ‚àà ùìù c :=
f.eventually_eq_one.mono $ Œª x hx, by { rw hx, exact one_ne_zero }
lemma tsupport_mem_nhds : tsupport f ‚àà ùìù c :=
mem_of_superset f.support_mem_nhds subset_closure
lemma c_mem_support : c ‚àà support f := mem_of_mem_nhds f.support_mem_nhds
lemma nonempty_support : (support f).nonempty := ‚ü®c, f.c_mem_support‚ü©
lemma compact_symm_image_closed_ball :
  is_compact ((ext_chart_at I c).symm '' (closed_ball (ext_chart_at I c c) f.R ‚à© range I)) :=
(euclidean.is_compact_closed_ball.inter_right I.closed_range).image_of_continuous_on $
  (ext_chart_at_continuous_on_symm _ _).mono f.closed_ball_subset
lemma nhds_within_range_basis :
  (ùìù[range I] (ext_chart_at I c c)).has_basis (Œª f : smooth_bump_function I c, true)
    (Œª f, closed_ball (ext_chart_at I c c) f.R ‚à© range I) :=
begin
  refine ((nhds_within_has_basis euclidean.nhds_basis_closed_ball _).restrict_subset
      (ext_chart_at_target_mem_nhds_within _ _)).to_has_basis' _ _,
  { rintro R ‚ü®hR0, hsub‚ü©,
    exact ‚ü®‚ü®‚ü®‚ü®R / 2, R, half_pos hR0, half_lt_self hR0‚ü©‚ü©, hsub‚ü©, trivial, subset.rfl‚ü© },
  { exact Œª f _, inter_mem (mem_nhds_within_of_mem_nhds $ closed_ball_mem_nhds f.R_pos)
      self_mem_nhds_within }
end
lemma closed_image_of_closed {s : set M} (hsc : is_closed s) (hs : s ‚äÜ support f) :
  is_closed (ext_chart_at I c '' s) :=
begin
  rw f.image_eq_inter_preimage_of_subset_support hs,
  refine continuous_on.preimage_closed_of_closed
    ((ext_chart_continuous_on_symm _ _).mono f.closed_ball_subset) _ hsc,
  exact is_closed.inter is_closed_closed_ball I.closed_range
end
lemma exists_r_pos_lt_subset_ball {s : set M} (hsc : is_closed s) (hs : s ‚äÜ support f) :
  ‚àÉ r (hr : r ‚àà Ioo 0 f.R), s ‚äÜ
    (chart_at H c).source ‚à© ext_chart_at I c ‚Åª¬π' (ball (ext_chart_at I c c) r) :=
begin
  set e := ext_chart_at I c,
  have : is_closed (e '' s) := f.closed_image_of_closed hsc hs,
  rw [support_eq_inter_preimage, subset_inter_iff, ‚Üê image_subset_iff] at hs,
  rcases euclidean.exists_pos_lt_subset_ball f.R_pos this hs.2 with ‚ü®r, hrR, hr‚ü©,
  exact ‚ü®r, hrR, subset_inter hs.1 (image_subset_iff.1 hr)‚ü©
end
def update_r (r : ‚Ñù) (hr : r ‚àà Ioo 0 f.R) : smooth_bump_function I c :=
‚ü®‚ü®‚ü®r, f.R, hr.1, hr.2‚ü©‚ü©, f.closed_ball_subset‚ü©
@[simp] lemma update_r_R {r : ‚Ñù} (hr : r ‚àà Ioo 0 f.R) : (f.update_r r hr).R = f.R := rfl
@[simp] lemma update_r_r {r : ‚Ñù} (hr : r ‚àà Ioo 0 f.R) : (f.update_r r hr).r = r := rfl
@[simp] lemma support_update_r {r : ‚Ñù} (hr : r ‚àà Ioo 0 f.R) :
  support (f.update_r r hr) = support f :=
by simp only [support_eq_inter_preimage, update_r_R]
instance : inhabited (smooth_bump_function I c) :=
classical.inhabited_of_nonempty nhds_within_range_basis.nonempty
variables [t2_space M]
lemma closed_symm_image_closed_ball :
  is_closed ((ext_chart_at I c).symm '' (closed_ball (ext_chart_at I c c) f.R ‚à© range I)) :=
f.compact_symm_image_closed_ball.is_closed
lemma tsupport_subset_symm_image_closed_ball :
  tsupport f ‚äÜ (ext_chart_at I c).symm '' (closed_ball (ext_chart_at I c c) f.R ‚à© range I) :=
begin
  rw [tsupport, support_eq_symm_image],
  exact closure_minimal (image_subset _ $ inter_subset_inter_left _ ball_subset_closed_ball)
    f.closed_symm_image_closed_ball
end
lemma tsupport_subset_ext_chart_at_source :
  tsupport f ‚äÜ (ext_chart_at I c).source :=
calc tsupport f
    ‚äÜ (ext_chart_at I c).symm '' (closed_ball (ext_chart_at I c c) f.R ‚à© range I) :
  f.tsupport_subset_symm_image_closed_ball
... ‚äÜ (ext_chart_at I c).symm '' (ext_chart_at I c).target :
  image_subset _ f.closed_ball_subset
... = (ext_chart_at I c).source :
  (ext_chart_at I c).symm_image_target_eq_source
lemma tsupport_subset_chart_at_source :
  tsupport f ‚äÜ (chart_at H c).source :=
by simpa only [ext_chart_at_source] using f.tsupport_subset_ext_chart_at_source
protected lemma has_compact_support : has_compact_support f :=
compact_of_is_closed_subset f.compact_symm_image_closed_ball is_closed_closure
 f.tsupport_subset_symm_image_closed_ball
variables (I c)
lemma nhds_basis_tsupport :
  (ùìù c).has_basis (Œª f : smooth_bump_function I c, true) (Œª f, tsupport f) :=
begin
  have : (ùìù c).has_basis (Œª f : smooth_bump_function I c, true)
    (Œª f, (ext_chart_at I c).symm '' (closed_ball (ext_chart_at I c c) f.R ‚à© range I)),
  { rw [‚Üê ext_chart_at_symm_map_nhds_within_range I c],
    exact nhds_within_range_basis.map _ },
  refine this.to_has_basis' (Œª f hf, ‚ü®f, trivial, f.tsupport_subset_symm_image_closed_ball‚ü©)
    (Œª f _, f.tsupport_mem_nhds),
end
variable {c}
lemma nhds_basis_support {s : set M} (hs : s ‚àà ùìù c) :
  (ùìù c).has_basis (Œª f : smooth_bump_function I c, tsupport f ‚äÜ s) (Œª f, support f) :=
((nhds_basis_tsupport I c).restrict_subset hs).to_has_basis'
  (Œª f hf, ‚ü®f, hf.2, subset_closure‚ü©) (Œª f hf, f.support_mem_nhds)
variables [smooth_manifold_with_corners I M] {I}
protected lemma smooth : smooth I ùìò(‚Ñù) f :=
begin
  refine cont_mdiff_of_support (Œª x hx, _),
  have : x ‚àà (chart_at H c).source := f.tsupport_subset_chart_at_source hx,
  refine cont_mdiff_at.congr_of_eventually_eq _
    (f.eq_on_source.eventually_eq_of_mem $ is_open.mem_nhds (chart_at _ _).open_source this),
  exact f.to_cont_diff_bump.cont_diff_at.cont_mdiff_at.comp _
    (cont_mdiff_at_ext_chart_at' this)
end
protected lemma smooth_at {x} : smooth_at I ùìò(‚Ñù) f x := f.smooth.smooth_at
protected lemma continuous : continuous f := f.smooth.continuous
lemma smooth_smul {G} [normed_group G] [normed_space ‚Ñù G]
  {g : M ‚Üí G} (hg : smooth_on I ùìò(‚Ñù, G) g (chart_at H c).source) :
  smooth I ùìò(‚Ñù, G) (Œª x, f x ‚Ä¢ g x) :=
begin
  apply cont_mdiff_of_support (Œª x hx, _),
  have : x ‚àà (chart_at H c).source,
  calc x ‚àà tsupport (Œª x, f x ‚Ä¢ g x) : hx
     ... ‚äÜ tsupport f : closure_mono (support_smul_subset_left _ _)
     ... ‚äÜ (chart_at _ c).source : f.tsupport_subset_chart_at_source,
  exact f.smooth_at.smul ((hg _ this).cont_mdiff_at $
    is_open.mem_nhds (chart_at _ _).open_source this)
end
end smooth_bump_function
